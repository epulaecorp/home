blueprint:
  name: LIGHT - Sensor
  description: >
    #  Sensor Light
    
    **Version: 6.2**

    <details>
    <summary><b>The Automation Process:</b> - Click here to expand</summary>

    
      - Activaci贸n:**
        - Puede elegir cualquier [sensor binario](https://www.home-assistant.io/integrations/binary_sensor/) o [programaci贸n](https://www.home-assistant.io/integrations/schedule) para activar la automatizaci贸n.
        - Un sensor de activaci贸n, como un sensor de movimiento, activar谩 luces, interruptores, escenas y scripts cuando se active la automatizaci贸n.
        - Un retardo de tiempo inicia el proceso de apagado despu茅s de que todos los disparadores est茅n despejados. Ver [agrupaci贸n](https://community.home-assistant.io/t/481048/34...es, se activa autom谩ticamente en funci贸n de las condiciones.

      - Salvaguardias de reinicio deHA:**
        - Benef铆ciate de las salvaguardas integradas para los reinicios del Asistente del Hogar.
          
      - **Integraci贸n de complementos Blueprint:**
        - Complemento de sensor de luz: mejora la automatizaci贸n del control multimedia. [Haga clic aqu铆](https://community.home-assistant.io/t/591824) para obtener m谩s informaci贸n.
        - Extractor de Humedad del Ba帽o - Mantiene las luces encendidas al ducharse. [Haga clic aqu铆](https://community.home-assistant.io/t/509992) para obtener m谩s informaci贸n.

    </details>
    
    
    The Settings & Best Practice Guidelines: [Click Here](https://community.home-assistant.io/t/481048/345)
    
    Need help? See our FAQ: [Click Here](https://community.home-assistant.io/t/481048/6)

    Let us know what you think of this blueprint and for community support including updates: [Click Here](https://community.home-assistant.io/t/481048)
    
    
    Required = *
  domain: automation
  input:
    motion_trigger:
      name: Trigger Sensor - Binary Sensors - Schedule *
      description: Los sensores de disparo son los responsables de encender y apagar las luces, interruptores, escenas y scripts. Puede elegir cualquier [sensor binario](https://www.home-assistant.io/integrations/binary_sensor/) que prefiera como disparador.
        Alternativamente, si prefiere un disparador basado en el tiempo, tambi茅n puede a帽adir un [ayudante de programaci贸n](https://community.home-assistant.io/t/481048/1616).

        
        Cuando se utilizan varios sensores de disparo, es aconsejable agruparlos utilizando un ayudante de grupo.
        Esto garantiza una ejecuci贸n m谩s fluida de la automatizaci贸n y evita conflictos.
        
        
        Para obtener m谩s informaci贸n sobre la agrupaci贸n de los sensores de disparo [Haga clic aqu铆](https://community.home-assistant.io/t/481048/34)
      selector:
        entity:
          filter:
            domain:
              - binary_sensor
              - schedule
          multiple: true
    light_switch:
      name: Lights - Switches - Scenes - Scripts *
      description: Las luces, interruptores, escenas y scripts que ser谩n activados por el/los sensor/es de disparo.
        Si desea a帽adir una escena o un script, consulte la secci贸n "Escenas y Scripts - Toggle Helper" y la secci贸n "Escenas - Scripts para apagar".


        Para m谩s informaci贸n sobre c贸mo utilizar escenas y scripts [Haga clic aqu铆](https://community.home-assistant.io/t/481048/1595)


        **NOTA** - S贸lo puede utilizar entidades. Las 谩reas y los dispositivos no son compatibles.

      selector:
        target:
          entity:
            domain:
              - light
              - switch
              - scene
              - script
    boolean_scenes_scripts:
      name: Scenes & Scripts - Toggle Helper
      description: Para garantizar el buen funcionamiento de la automatizaci贸n, se recomienda crear un ayudante de conmutaci贸n independiente
        al seleccionar una escena o script en "Luces - Interruptores - Escenas - Scripts" m谩s arriba y luego introducirlo aqu铆.
      default: []
      selector:
        entity:
          filter:
            domain:
              - input_boolean
    end_scenes:
      name: Scenes - Scripts To Turn OFF
      description: Si ha seleccionado una escena o  script para que se encienda arriba en "Luces - Interruptores - Escenas - Guiones"
        o abajo en "Luces nocturnas", y desea que se apague despu茅s del retardo, debe crear una escena o un gui贸n con todo apagado e introducirlo aqu铆.
        o un script con todo APAGADO e introducirlo aqu铆.
      default: []
      selector:
        entity:
          multiple: true
          filter:
            domain:
              - scene
              - script
    time_delay:
      name: Time Delay
      description: El tiempo de retardo determina cu谩nto tiempo permanecer谩n activas las luces, los interruptores, las escenas y los scripts despu茅s de que todos los activadores se desactiven, iniciando el tiempo de retardo para apagarlos.
      default: 5
      selector:
        number:
          min: 0
          max: 30
          step: 0.5
          unit_of_measurement: minutes
    include_light_control:
      name: Use The Light Control Options (Optional)
      description: Seleccione si desea utilizar el brillo, la temperatura de color o la transici贸n.
        Estos ajustes s贸lo afectar谩n a una entidad "luz" que admita cada opci贸n seleccionada.
        A continuaci贸n se indican los ajustes de brillo, temperatura de color y transici贸n.
      default: []
      selector:
        select:
          multiple: true
          options:
            - label: Use brightness
              value: "use_brightness"
            - label: Use colour temperature
              value: "use_colour_temperature"
            - label: Use transition
              value: "use_transition"
    light_brightness:
      name: Brightness
      description: El ajuste de brillo de las luces cuando est谩n encendidas.
      default: 100
      selector:
        number:
          min: 1
          max: 100
          mode: slider
          step: 1
          unit_of_measurement: '%'
    light_colour_temperature:
      name: Colour Temperature
      description: Ajuste de la temperatura de color de las luces cuando est谩n encendidas.
      default: 5000
      selector:
        number:
          min: 2000
          max: 8000
          mode: slider
          step: 100
          unit_of_measurement: 'kelvin'
    light_transition_on:
      name: Transition - ON
      description: El ajuste de transici贸n para las luces cuando se encienden.
      default: 1
      selector:
        number:
          min: 0
          max: 5
          mode: slider
          step: 0.5
          unit_of_measurement: seconds
    light_transition_off:
      name: Transition - OFF
      description: El ajuste de transici贸n para las luces cuando est谩n apagadas.
      default: 1
      selector:
        number:
          min: 0
          max: 30
          mode: slider
          step: 1
          unit_of_measurement: seconds
    include_dynamic_lighting:
      name: Use The Dynamic Lighting Options (Optional)
      description: Esta opci贸n tiene como objetivo realizar ajustes continuos en su configuraci贸n de iluminaci贸n modulando el brillo seg煤n valores de lux flotantes
        o adaptando la temperatura del color y la luminosidad en funci贸n de la elevaci贸n del sol. Elige entre seis opciones preestablecidas disponibles en el men煤 desplegable.
        
        
        1 - Lux Controlled Brightness
        
        2 - Lux Controlled Brightness - Inverted
        
        3 - Sun Elevation Lighting - Colour Temp

        4 - Sun Elevation Lighting - Brightness

        5 - Sun Elevation Lighting - Colour Temp + Brightness

        6 - Sun Elevation Lighting - Colour Temp + Lux Controlled Brightness
        
        
        Se ha implementado un sistema de numeraci贸n para facilitar la navegaci贸n dentro de las selecciones desplegables. Cada n煤mero corresponde a una configuraci贸n espec铆fica,
        Cada n煤mero corresponde a una configuraci贸n espec铆fica, lo que ayuda a los usuarios a identificar y ajustar la configuraci贸n utilizada en cada selecci贸n. Por ejemplo, al seleccionar "3 - Iluminaci贸n de elevaci贸n del sol - Temperatura de color"
        como opci贸n desplegable, los ajustes marcados con "Utilizado en las opciones 3, 5 贸 6" son necesarios para esa selecci贸n respectiva porque el n煤mero 3 est谩 incluido en esas opciones.


        Para m谩s informaci贸n sobre los ajustes de iluminaci贸n din谩mica [Haga clic aqu铆](https://community.home-assistant.io/t/481048/837)

      default: disable_dynamic_lighting
      selector:
        select:
          mode: dropdown
          options:
            - label: Disable Dynamic Lighting
              value: "disable_dynamic_lighting"
            - label: 1 - Lux Controlled Brightness
              value: "enable_lux_controled_brightness"
            - label: 2 - Lux Controlled Brightness - Inverted
              value: "enable_lux_controled_brightness_inv"
            - label: 3 - Sun Elevation Lighting - Colour Temp
              value: "enable_sun_elevation_colour"
            - label: 4 - Sun Elevation Lighting - Brightness
              value: "enable_sun_elevation_brightness"
            - label: 5 - Sun Elevation Lighting - Colour Temp + Brightness
              value: "enable_sun_elevation_colour_brightness"
            - label: 6 - Sun Elevation Lighting - Colour Temp + Lux Brightness
              value: "enable_sun_elevation_colour_lux_brightness"
    dynamic_lighting_lux_sensor:
      name: Dynamic Lighting - Ambient Light Sensor
      description: "**Se utiliza en las opciones 1, 2 贸 6** - Introduzca el sensor de luz ambiental espec铆fico que se va a utilizar, en funci贸n de la configuraci贸n elegida."
      default: []
      selector:
        entity:
          filter:
            domain: sensor
            device_class: illuminance
    dynamic_lighting_max_lux:
      name: Dynamic Lighting - Max Lux Value
      description: "**Utilizado en las opciones 1, 2 贸 6** - Especifica el valor m谩ximo de lux. Una vez que el nivel de lux alcance o supere este valor, tus luces se ajustar谩n a su brillo m谩ximo o m铆nimo, dependiendo de la opci贸n elegida. 
        Este valor indica cu谩ndo prefiere que sus luces comiencen a encenderse o apagarse"
      default: 400
      selector:
        number:
          min: 10
          max: 900
          step: 10
          unit_of_measurement: lux
    dynamic_lighting_min_lux:
      name: Dynamic Lighting - Min Lux Value
      description: "**Utilizado en las opciones 1, 2 贸 6** - Especifica el valor m铆nimo de lux. Una vez que el nivel de lux alcance o supere este valor, tus luces se ajustar谩n a su brillo m谩ximo o m铆nimo, dependiendo de la opci贸n elegida. 
        Este valor indica cu谩ndo prefiere que sus luces comiencen a encenderse o apagarse"
      default: 40
      selector:
        number:
          min: 0
          max: 600
          step: 10
          unit_of_measurement: lux
    dynamic_lighting_max_brightness:
      name: Dynamic Lighting - Max Brightness Value
      description: "**Utilizado en las opciones 1, 2, 4, 5 o 6** - Define el valor m谩ximo de luminosidad, determina el nivel m谩ximo de luminosidad para tus luces"
      default: 100
      selector:
        number:
          min: 10
          max: 100
          step: 1
          unit_of_measurement: '%'
    dynamic_lighting_min_brightness:
      name: Dynamic Lighting - Min Brightness Value
      description: "**Utilizado en las opciones 1, 2, 4, 5 贸 6** - Especifica el valor m铆nimo de brillo, estableciendo el nivel de brillo m谩s bajo para sus luces.
        Al establecer el brillo en 0%, la luz se apagar谩."
      default: 0
      selector:
        number:
          min: 0
          max: 100
          step: 1
          unit_of_measurement: '%'
    dynamic_lighting_max_colour_temp:
      name: Dynamic Lighting - Max Colour Temperature
      description: "**Utilizado en las opciones 3, 5 o 6** - Especifica el valor m谩s alto de temperatura de color, determinando el ajuste de color m谩s fr铆o para tus luces."
      default: 5000
      selector:
        number:
          min: 2500
          max: 8000
          mode: slider
          step: 100
          unit_of_measurement: 'kelvin'
    dynamic_lighting_min_colour_temp:
      name: Dynamic Lighting - Min Colour Temperature
      description: "**Se utiliza en las opciones 3, 5 贸 6** - Establece el valor m谩s bajo de temperatura de color, definiendo el ajuste de color m谩s c谩lido para tus luces."
      default: 3000
      selector:
        number:
          min: 2000
          max: 7500
          mode: slider
          step: 100
          unit_of_measurement: 'kelvin'
    dynamic_lighting_sun_elevation_start_rising:
      name: Dynamic Lighting - Sun Elevation Rising - Start Point
      description: "**Utilizado en las opciones 3, 4, 5 贸 6** - Cuando el sol se eleva por encima del punto de inicio del sensor, tanto la temperatura de color como el porcentaje de luminosidad
        pasar谩n linealmente de sus valores m铆nimos a los m谩ximos hasta alcanzar el punto final ascendente, en funci贸n de los ajustes elegidos."
      default: -1.5
      selector:
        number:
          min: -10
          max: 30
          step: 0.5
          unit_of_measurement: degrees
    dynamic_lighting_sun_elevation_end_rising:
      name: Dynamic Lighting - Sun Elevation Rising - End Point
      description: "**Utilizado en las opciones 3, 4, 5 贸 6** - Cuando el sol se eleva por encima del punto final del sensor, la temperatura de color m谩xima y el valor de luminosidad m谩xima se establecer谩n de acuerdo con la configuraci贸n elegida.
        se establecer谩n en funci贸n de los ajustes elegidos."
      default: 15
      selector:
        number:
          min: 0
          max: 90
          step: 0.5
          unit_of_measurement: degrees
    dynamic_lighting_sun_elevation_start_falling:
      name: Dynamic Lighting - Sun Elevation Descending - Start Point
      description: "**Utilizado en las opciones 3, 4, 5 贸 6** - Cuando el sol desciende por debajo del punto inicial del sensor, tanto la temperatura de color como el porcentaje de luminosidad pasar谩n linealmente de sus valores m谩ximos a los m铆nimos hasta que alcancen el punto final descendente, en funci贸n de los ajustes elegidos.
        de color y el porcentaje de luminosidad pasar谩n linealmente de sus valores m谩ximos a los m铆nimos hasta alcanzar el punto final descendente, en funci贸n de la configuraci贸n elegida."
      default: 15
      selector:
        number:
          min: 0
          max: 90
          step: 0.5
          unit_of_measurement: degrees
    dynamic_lighting_sun_elevation_end_falling:
      name: Dynamic Lighting - Sun Elevation Descending - End Point
      description: "**Utilizado en las opciones 3, 4, 5 贸 6** - Cuando el sol desciende por debajo del punto final del sensor, la temperatura de color m铆nima y el valor de luminosidad m铆nimo se establecer谩n de acuerdo con la configuraci贸n elegida. 
        se establecer谩n en funci贸n de los ajustes elegidos."
      default: -4.0
      selector:
        number:
          min: -10
          max: 30
          step: 0.5
          unit_of_measurement: degrees
    dynamic_lighting_heartbeat:
      name: Dynamic Lighting - Heartbeat
      description: "**Utilizado en las opciones 1, 2, 3, 4, 5 贸 6** - Define la frecuencia de sensoreo, ajustando la velocidad de funcionamiento.
        Durante cada sensoreo, eval煤a el valor de lux, el brillo de la luz, el brillo objetivo y la elevaci贸n del sol en funci贸n de los ajustes elegidos,
            ajustando la luminosidad o la temperatura de color seg煤n la selecci贸n."
      default: 1
      selector:
        number:
          min: 0.25
          max: 10
          step: 0.25
          unit_of_measurement: minutes
    dynamic_lighting_step_value:
      name: Dynamic Lighting - Step Value
      description: "**Utilizado en las opciones 1, 2 贸 6** - Con cada latido, el sistema eval煤a el valor lux, el brillo de la luz y el brillo objetivo.
        Si la luminosidad objetivo supera el valor de paso predefinido, el sistema aplica el valor de paso establecido para moderar con elegancia el ritmo de los cambios,
        facilitando una transici贸n m谩s suave en el brillo de la luz."
      default: 4
      selector:
        number:
          min: 1
          max: 100
          step: 1
          unit_of_measurement: '%'
    dynamic_lighting_dead_zone:
      name: Dynamic Lighting - Dead Zone (卤)
      description: "**Utilizado en las opciones 1, 2 贸 6** - En cada sensoreo, el sistema eval煤a la luminosidad actual y la luminosidad deseada.
        Si la luminosidad deseada se encuentra dentro de la zona muerta definida, el sistema mantiene la luminosidad actual.
        De este modo se evitan peque帽as fluctuaciones en la intensidad de la luz que podr铆an resultar molestas para la vista."
      default: 7
      selector:
        number:
          min: 0
          max: 15
          step: 1
          unit_of_measurement: '%'
    include_bypass:
      name: Use The Bypass Options (Optional)
      description: Seleccione si desea activar una opci贸n. Cada opci贸n permite el control manual de sus luces pero altera su
        comportamiento encendi茅ndose, apag谩ndose o manteniendo su estado actual cuando se enciende la derivaci贸n. Al activar una opci贸n,
        introduzca el interruptor de bypass en la entrada correspondiente.
        
        
        Para m谩s informaci贸n sobre c贸mo utilizar el bypass [Haga clic aqu铆](https://community.home-assistant.io/t/481048/895)

      default: []
      selector:
        select:
          options:
            - label: 1 - Enable the Bypass - Turn lights ON
              value: "bypass_enabled_turn_on"
            - label: 2 - Enable the Bypass - Turn lights OFF
              value: "bypass_enabled_turn_off"
            - label: 3 - Enable the Bypass - Keep the lights current state
              value: "bypass_enabled_stop"
          multiple: true
    motion_bypass_lights_on:
      name: Bypass Switch - Turn lights ON
      description: Seleccione los interruptores que encender谩n sus luces, anular谩n el sensor de activaci贸n y permitir谩n que sus luces funcionen normalmente.
        Tenga en cuenta que la entidad no puede incluirse en las selecciones 'Luces - Interruptores - Escenas - scripts' o 'Luces nocturnas'.
      default: []
      selector:
        entity:
          multiple: true
    motion_bypass_lights_off:
      name: Bypass Switch - Turn lights OFF
      description: Seleccione los interruptores que apagar谩n sus luces, anular谩n el sensor de activaci贸n y permitir谩n que sus luces funcionen normalmente.
        Tenga en cuenta que la entidad no puede incluirse en las selecciones 'Luces - Interruptores - Escenas - scripts' o 'Luces nocturnas'.
      default: []
      selector:
        entity:
          multiple: true
    motion_bypass_lights_stop:
      name: Bypass Switch - Keep The Lights Current State
      description: Seleccione los interruptores que mantendr谩n el estado actual de sus luces, anular谩n el sensor de disparo y permitir谩n que sus luces funcionen normalmente.
        Tenga en cuenta que la entidad no puede incluirse en las selecciones 'Luces - Interruptores - Escenas - scripts' o 'Luces nocturnas'.
      default: []
      selector:
        entity:
          multiple: true
    bypass_time_delay:
      name: Bypass - Time Delay
      description: Esto s贸lo se utiliza en dos escenarios de anulaci贸n - cuando las luces ya est谩n encendidas y cuando la automatizaci贸n apaga las luces.
        El primer escenario ocurre cuando usted ha seleccionado la opci贸n 2 arriba para "Activar el Bypass - Apagar las luces".
        El segundo escenario ocurre cuando usted desactiva el bypass, el sensor de activaci贸n est谩 desactivado y las luces est谩n encendidas.
        En ambos casos, la automatizaci贸n apagar谩 las luces despu茅s del tiempo de retardo establecido.
      default: 0
      selector:
        number:
          min: 0
          max: 10
          step: 0.25
          unit_of_measurement: minutes
    include_bypass_auto_off:
      name: Use The Bypass Auto OFF Option (Optional)
      description: Se utiliza cuando se activa el bypass y se desea que se desactive autom谩ticamente despu茅s de un tiempo determinado.
        Puede elegir a qu茅 opci贸n de bypass desea aplicar la funci贸n de desconexi贸n autom谩tica
      default: []
      selector:
        select:
          options:
            - label: Enable the auto OFF for the bypass switch - Turn lights ON
              value: "bypass_auto_off_enabled_on"
            - label: Enable the auto OFF for the bypass switch - Turn lights OFF
              value: "bypass_auto_off_enabled_off"
            - label: Enable the auto OFF for the bypass switch - Keep The Lights Current State
              value: "bypass_auto_off_enabled_stop"
          multiple: true
    bypass_auto_off_delay:
      name: Bypass Auto OFF - Time Delay
      description: Ajuste el tiempo de retardo de la desactivaci贸n autom谩tica del bypass. El tiempo de retardo comienza a partir del ultimo bypass que se activ贸.
      default: 60
      selector:
        number:
          min: 1
          max: 240
          step: 1
          unit_of_measurement: minutes
    include_sun:
      name: Use The Sun Option (Optional)
      description: Esta opci贸n se utiliza para a帽adir una condici贸n que s贸lo permite que la automatizaci贸n se ejecute cuando est谩 oscuro o por debajo de los ajustes de 'Elevaci贸n del Sol'.
        Es una condici贸n global que puede funcionar junto con otras opciones. Habilitar esta opci贸n no es necesario para que funcione la condici贸n de elevaci贸n del sol de las luces nocturnas.
        
        
        Para m谩s informaci贸n sobre los ajustes del sol [Haga clic aqu铆](https://community.home-assistant.io/t/481048/37)

      default: sun_disabled
      selector:
        select:
          options:
            - label: Enable the sun option
              value: "sun_enabled"
            - label: Disable the sun option
              value: "sun_disabled"
    sun_elevation:
      name: Sun Elevation Falling
      description: La ca铆da de la elevaci贸n del sol se refiere al 谩ngulo entre el sol y el horizonte cuando el sol se est谩 poniendo.
        Un valor negativo indica que el sol est谩 POR DEBAJO del horizonte. Por ejemplo, una gu铆a de puesta de -1,5 corresponde al crep煤sculo
      default: -1.5
      selector:
        number:
          min: -10
          max: 5
          step: 0.5
          unit_of_measurement: degrees
    sun_elevation_rising:
      name: Sun Elevation Rising
      description: La elevaci贸n del sol naciente se refiere al 谩ngulo entre el sol y el horizonte durante la salida del sol.
        Un valor negativo indica que el sol est谩 DEBAJO del horizonte. Por ejemplo, una gu铆a de ajuste de -4,0 corresponde al amanecer.
      default: -4.0
      selector:
        number:
          min: -10
          max: 5
          step: 0.5
          unit_of_measurement: degrees
    include_ambient:
      name: Use The Ambient Options (Optional)
      description: Esta opci贸n se utiliza para a帽adir una condici贸n que s贸lo permite que la automatizaci贸n se ejecute cuando est谩 oscuro o por debajo de la configuraci贸n 'Ambiente'.
        Es una condici贸n global que puede funcionar junto con otras opciones.
        
        
        Para obtener m谩s informaci贸n sobre la configuraci贸n de ambiente [Haga clic aqu铆](https://community.home-assistant.io/t/481048/1608)
      default: ambient_disabled
      selector:
        select:
          options:
            - label: Enable the ambient options
              value: "ambient_enabled"
            - label: Disable the ambient options
              value: "ambient_disabled"
    ambient_light_sensor:
      name: Ambient Light Sensor
      description: Select the ambient sensor to be used.
      default: []
      selector:
        entity:
          filter:
            domain: sensor
            device_class: illuminance
    ambient_light_options:
      name: Ambient Light Sensor - Site Conditions
      description: En algunos casos, cuando las luces se encienden, el sensor de luz ambiental se ve afectado, aumentando su valor LUX.
        Esto puede provocar que las luces se APAGUE antes de tiempo. Seleccione la opci贸n que mejor se adapte a su instalaci贸n.
        
        
        **NOTA** - Si utiliza un offset entre el valor de lux alto y bajo, entonces por favor seleccione NO.
      default: ambient_light_option_disabled
      selector:
        select:
          options:
            - label: YES - My Ambient Light Sensor is affected by the Lights
              value: "ambient_light_option_enabled"
            - label: NO - My Ambient Light Sensor is not affected by the Lights
              value: "ambient_light_option_disabled"
    ambient_light_value:
      name: Ambient Light - Low Lux Value
      description: Ajuste el valor de lux bajo de la luz ambiente. La luz se encender谩 cuando el nivel de lux est茅 por debajo del valor ajustado.
        Este valor debe ser igual o inferior al "Valor Lux Alto" que se indica a continuaci贸n. La gu铆a es 20 lux (atardecer).
      default: 20
      selector:
        number:
          min: 0
          max: 500
          step: 10
          unit_of_measurement: lux
    ambient_light_high_value:
      name: Ambient Light - High Lux Value
      description: Ajuste el valor de lux alto de la luz ambiente. La luz se apagar谩 cuando el nivel de lux sea superior al valor ajustado.
        Este valor debe ser igual o superior al "Valor Lux Bajo" anterior. 
        Establecer un valor superior al valor bajo permite una compensaci贸n. El valor gu铆a es 80 lux (amanecer).
      default: 80
      selector:
        number:
          min: 0
          max: 1000
          step: 10
          unit_of_measurement: lux
    include_time:
      name: Use The Time Options (Optional)
      description: Esta opci贸n se utiliza para a帽adir una condici贸n que s贸lo permite que la automatizaci贸n se ejecute entre los ajustes de hora de inicio y hora de fin en los d铆as laborables seleccionados.
        Estos ajustes de hora son condiciones globales que pueden funcionar junto con otras opciones.
        No es necesario activar esta opci贸n para que funcione la condici贸n horaria de las luces nocturnas.
        
        
        Para obtener m谩s informaci贸n sobre los ajustes de tiempo [Haga clic aqu铆](https://community.home-assistant.io/t/481048/310)
      default: time_disabled
      selector:
        select:
          options:
            - label: Enable the time options
              value: "time_enabled"
            - label: Disable the time options
              value: "time_disabled"
    after_time:
      name: Start Time
      description: Ajuste la hora de inicio.
      default: 00:00:00
      selector:
        time:
    before_time:
      name: End Time
      description: Fije la hora de finalizaci贸n.
      default: 00:00:00
      selector:
        time:
    weekday_options:
      name: Weekdays
      description: Seleccione los d铆as de la semana en los que desea que se ejecute la automatizaci贸n.
        Debe seleccionar "Activar las opciones de hora" m谩s arriba para que las selecciones de d铆as de la semana funcionen.
      default:
        - mon
        - tue
        - wed
        - thu
        - fri
        - sat
        - sun
      selector:
        select:
          multiple: true
          mode: list
          options:
            - label: Monday
              value: "mon"
            - label: Tuesday
              value: "tue"
            - label: Wednesday
              value: "wed"
            - label: Thursday
              value: "thu"
            - label: Friday
              value: "fri"
            - label: Saturday
              value: "sat"
            - label: Sunday
              value: "sun"
    include_device_tracker:
      name: Use The Device Tracker Options (Optional)
      description: Home assistant puede rastrear la ubicaci贸n de sus dispositivos (como tel茅fonos m贸viles) dentro de una zona designada a trav茅s del rastreador de dispositivos de la aplicaci贸n m贸vil.
        Para utilizar esta opci贸n, tienes que establecer una zona y configurar tus dispositivos para el seguimiento en Home Assitant.
        Hay dos opciones de activaci贸n disponibles - "Zona" rastrea todos los dispositivos dentro de la zona, mientras que "Zona + Personas" te permite rastrear individuos dentro de una zona.
        Esta funci贸n puede ser especialmente 煤til si tiene mascotas que activan el sensor, encendiendo y apagando las luces cuando no hay nadie en casa.
      default: device_tracker_disabled
      selector:
        select:
          options:
            - label: Enable the zone option
              value: "zone_enabled"
            - label: Enable the zone + people options
              value: "zone_people_enabled"
            - label: Disable the device tracker options
              value: "device_tracker_disabled"
    zone:
      name: Device Tracker - Zone
      description: Elija la zona que rastrear谩 sus dispositivos y/o las personas que se encuentren en ella.
      default: []
      selector:
        entity:
          filter:
            domain: zone
    people:
      name: Device Tracker - People
      description: Seleccione las personas que desea seguir en la zona seleccionada anteriormente. Debe introducir una zona arriba para que esta opci贸n funcione.
      default: []
      selector:
        entity:
          multiple: true
          filter:
            domain:
              - person
    include_night_lights:
      name: Use The Night Lights Options (Optional)
      description: Habilitar las opciones de luces nocturnas permite un control de la iluminaci贸n independiente y personalizable cuando se cumplen las condiciones de las luces nocturnas.
        Las opciones de condici贸n de las luces nocturnas incluyen el estado de la entidad, la hora o la elevaci贸n del sol. Por favor, elija la opci贸n de condici贸n que desea utilizar a continuaci贸n.
        Esta caracter铆stica es particularmente beneficiosa para crear un ambiente relajante con una iluminaci贸n m谩s suave por la noche.
        La flexibilidad de estas opciones permite realizar ajustes personalizados, mejorando el ambiente nocturno y la comodidad, especialmente cuando se desplaza durante la noche.
      default: night_lights_disabled
      selector:
        select:
          options:
            - label: Enable the night lights options
              value: "night_lights_enabled"
            - label: Disable the night lights options
              value: "night_lights_disabled"
    night_lights:
      name: Night Lights
      description: Las luces, interruptores, escenas y scripts que ser谩n activados por el/los sensor/es de disparo.
        Si desea a帽adir una escena o un script, consulte la secci贸n 'Luces nocturnas - Escenas y scripts - Toggle Helper' m谩s abajo y la secci贸n 'Escenas - Scripts para apagar' m谩s arriba.


        Para m谩s informaci贸n sobre el uso de escenas y guiones [Haga clic aqu铆](https://community.home-assistant.io/t/481048/1595)


        **NOTA** - S贸lo puede utilizar entidades. Las 谩reas y los dispositivos no son compatibles.
      default: {}
      selector:
        target:
          entity:
            domain: 
              - light
              - switch
              - scene
              - script
    night_boolean_scenes_scripts:
      name: Night Lights - Scenes & Scripts - Toggle Helper
      description: Para garantizar el buen funcionamiento de la automatizaci贸n, se recomienda crear un ayudante de conmutaci贸n independiente
        al seleccionar una escena o script en "Luces nocturnas" m谩s arriba y luego introducirlo aqu铆.
      default: []
      selector:
        entity:
          filter:
            domain:
              - input_boolean
    night_time_delay:
      name: Night Lights - Time Delay
      description: El tiempo de retardo determina el tiempo que las luces nocturnas permanecer谩n activas despu茅s de que todos los disparadores est茅n despejados, iniciando el tiempo de retardo para apagarlas.
      default: 5
      selector:
        number:
          min: 0
          max: 30
          step: 0.5
          unit_of_measurement: minutes
    include_night_light_control:
      name: Night Lights - Use The Light Control Options (Optional)
      description:  Seleccione si desea utilizar el brillo, la temperatura de color o la transici贸n.
        Estos ajustes s贸lo afectar谩n a una entidad "luz" que admita cada opci贸n seleccionada.
        A continuaci贸n se indican los ajustes de brillo, temperatura de color y transici贸n. 
        
        
        Seleccionando la opci贸n 'Si las luces est谩n encendidas, ajustar las luces al cruzar' se garantiza que los ajustes de control de luces se aplicar谩n a cualquier luz que ya est茅 encendida durante la transici贸n de luces normales a luces nocturnas y viceversa.


        La selecci贸n de la opci贸n 'S铆 - Gestionar OFF script al cruzar' es beneficiosa para los scripts que contienen acciones if-then-else que activan y desactivan varias funciones durante la transici贸n de luces normales a luces nocturnas y viceversa.
      default: []
      selector:
        select:
          multiple: true
          options:
            - label: Use brightness
              value: "use_brightness"
            - label: Use colour temperature
              value: "use_colour_temperature"
            - label: Use transition
              value: "use_transition"
            - label: If lights are ON, adjust the lights when crossing over
              value: "if_lights_are_on_adjust_when_crossing_over"
            - label: Yes - Manage OFF script when crossing over
              value: "manage_scripts_crossing_over"
    night_light_brightness:
      name: Night Lights - Brightness
      description: El ajuste de brillo de las luces nocturnas cuando est谩n encendidas.
      default: 20
      selector:
        number:
          min: 1
          max: 100
          mode: slider
          step: 1
          unit_of_measurement: '%'
    night_light_colour_temperature:
      name: Night Lights - Colour Temperature
      description: Ajuste de la temperatura de color de las luces nocturnas cuando est谩n encendidas.
      default: 5000
      selector:
        number:
          min: 2000
          max: 8000
          mode: slider
          step: 100
          unit_of_measurement: 'kelvin'
    night_light_transition_on:
      name: Night Lights - Transition - ON
      description: La transici贸n de las luces nocturnas cuando se encienden.
      default: 1
      selector:
        number:
          min: 0
          max: 5
          mode: slider
          step: 0.5
          unit_of_measurement: seconds
    night_light_transition_off:
      name: Night Lights - Transition - OFF
      description: La transici贸n de las luces nocturnas cuando se apagan.
      default: 1
      selector:
        number:
          min: 0
          max: 30
          mode: slider
          step: 1
          unit_of_measurement: seconds
    night_lights_conditions:
      name: Night Lights Conditions (Required For Night Lights)
      description: Seleccione cualquier condici贸n de luz nocturna de las opciones proporcionadas.
        Aseg煤rate de que has activado "Usar las opciones de luces nocturnas" en la secci贸n anterior y elige al menos una "Condici贸n de luces nocturnas" para que las luces nocturnas funcionen.
        A continuaci贸n se indican los ajustes de cada opci贸n
      default: []
      selector:
        select:
          multiple: true
          options:
            - label: Enable entity state option
              value: "entity_state_enabled"
            - label: Enable time option
              value: "time_enabled"
            - label: Enable sun elevation option
              value: "sun_enabled"
    night_lights_entity_state:
      name: Night Lights - Entity State
      description: Seleccione una entidad que activar谩 las luces nocturnas cuando se enciendan. Podr铆a ser su tel茅fono en 'No molestar', un ayudante, un sensor de cama, etc.
        Tenga en cuenta que la entidad seleccionada no puede incluirse en las selecciones 'Luces - Interruptores - Escenas - Scripts' o 'Luces Nocturnas'.
        
        
        Para m谩s informaci贸n sobre el estado de las entidades [Haga clic aqu铆](https://community.home-assistant.io/t/481048/663)
      default: []
      selector:
        entity:
          multiple: true
    night_lights_after_time:
      name: Night Lights - Start Time
      description: Set the start time.
      default: 00:00:00
      selector:
        time:
    night_lights_before_time:
      name: Night Lights - End Time
      description: Set the end time.
      default: 00:00:00
      selector:
        time:
    night_lights_sun_elevation:
      name: Night Lights - Sun Elevation Falling
      description: La ca铆da de la elevaci贸n del sol se refiere al 谩ngulo entre el sol y el horizonte cuando el sol se est谩 poniendo.
        Un valor negativo indica que el sol est谩 DEBAJO del horizonte. Por ejemplo, una gu铆a de puesta de -1,5 corresponde al crep煤sculo.
      default: -1.5
      selector:
        number:
          min: -10
          max: 5
          step: 0.5
          unit_of_measurement: degrees
    night_lights_sun_elevation_rising:
      name: Night Lights - Sun Elevation Rising
      description: La elevaci贸n del sol naciente se refiere al 谩ngulo entre el sol y el horizonte durante la salida del sol.
        Un valor negativo indica que el sol est谩 DEBAJO del horizonte. Por ejemplo, una gu铆a de ajuste de -4,0 corresponde al amanecer.
      default: -4.0
      selector:
        number:
          min: -10
          max: 5
          step: 0.5
          unit_of_measurement: degrees

# If motion sensor turns ON again within the time delay, it will restart the script.
mode: restart
max_exceeded: silent

variables:
  motion_trigger: !input motion_trigger
  light_switch: !input light_switch
  boolean_scenes_scripts: !input boolean_scenes_scripts
  end_scenes: !input end_scenes
  time_delay: !input time_delay
  include_light_control: !input include_light_control
  light_brightness: !input light_brightness
  brightness_value: "{{ iif ('use_brightness' in include_light_control , light_brightness, ) }}"
  light_colour_temperature: !input light_colour_temperature
  temperature_value: "{{ iif ('use_colour_temperature' in include_light_control , light_colour_temperature, [] ) }}"
  light_transition_on: !input light_transition_on
  light_transition_off: !input light_transition_off
  transition_on_value: "{{ iif ('use_transition' in include_light_control, light_transition_on, ) }}"
  transition_off_value: "{{ iif ('use_transition' in include_light_control, light_transition_off, ) }}"
  include_dynamic_lighting: !input include_dynamic_lighting
  dynamic_lighting_lux_sensor: !input dynamic_lighting_lux_sensor
  dynamic_lighting_max_lux: !input dynamic_lighting_max_lux
  dynamic_lighting_min_lux: !input dynamic_lighting_min_lux
  dynamic_lighting_max_brightness: !input dynamic_lighting_max_brightness
  dynamic_lighting_min_brightness: !input dynamic_lighting_min_brightness
  dynamic_lighting_max_colour_temp: !input dynamic_lighting_max_colour_temp
  dynamic_lighting_min_colour_temp: !input dynamic_lighting_min_colour_temp
  dynamic_lighting_sun_elevation_start_rising: !input dynamic_lighting_sun_elevation_start_rising
  dynamic_lighting_sun_elevation_end_rising: !input dynamic_lighting_sun_elevation_end_rising
  dynamic_lighting_sun_elevation_start_falling: !input dynamic_lighting_sun_elevation_start_falling
  dynamic_lighting_sun_elevation_end_falling: !input dynamic_lighting_sun_elevation_end_falling
  dynamic_lighting_heartbeat: !input dynamic_lighting_heartbeat
  dynamic_lighting_step_value: !input dynamic_lighting_step_value
  dynamic_lighting_dead_zone: !input dynamic_lighting_dead_zone
  include_bypass: !input include_bypass
  motion_bypass_lights_on: !input motion_bypass_lights_on
  motion_bypass_lights_off: !input motion_bypass_lights_off
  motion_bypass_lights_stop: !input motion_bypass_lights_stop
  bypass_time_delay: !input bypass_time_delay
  include_bypass_auto_off: !input include_bypass_auto_off
  bypass_auto_off_delay: !input bypass_auto_off_delay
  include_sun: !input include_sun
  sun_elevation: !input sun_elevation
  sun_elevation_rising: !input sun_elevation_rising
  include_ambient: !input include_ambient
  ambient_light_sensor: !input ambient_light_sensor
  ambient_light_options: !input ambient_light_options
  ambient_light_value: !input ambient_light_value
  ambient_light_high_value: !input ambient_light_high_value
  include_time: !input include_time
  after_time: !input after_time
  before_time: !input before_time
  weekday_options: !input weekday_options
  include_device_tracker: !input include_device_tracker
  zone: !input zone
  people: !input people
  include_night_lights: !input include_night_lights
  night_lights: !input night_lights
  night_boolean_scenes_scripts: !input night_boolean_scenes_scripts
  night_time_delay: !input night_time_delay
  include_night_light_control: !input include_night_light_control
  night_light_brightness: !input night_light_brightness
  night_brightness_value: "{{ iif ('use_brightness' in include_night_light_control , night_light_brightness, ) }}"
  night_light_colour_temperature: !input night_light_colour_temperature
  night_temperature_value: "{{ iif ('use_colour_temperature' in include_night_light_control , night_light_colour_temperature, [] ) }}"
  night_light_transition_on: !input night_light_transition_on
  night_light_transition_off: !input night_light_transition_off
  night_transition_on_value: "{{ iif ('use_transition' in include_night_light_control, night_light_transition_on, ) }}"
  night_transition_off_value: "{{ iif ('use_transition' in include_night_light_control, night_light_transition_off, ) }}"
  night_lights_conditions: !input night_lights_conditions
  night_lights_entity_state: !input night_lights_entity_state
  night_lights_after_time: !input night_lights_after_time
  night_lights_before_time: !input night_lights_before_time
  night_lights_sun_elevation: !input night_lights_sun_elevation
  night_lights_sun_elevation_rising: !input night_lights_sun_elevation_rising

# Split domains for light switch targets and check the entities are OFF - exclude scenes and scripts as they have no off state

  light_entities_off: "{{ expand(light_switch.entity_id) | selectattr('domain', 'eq', 'light') | selectattr('state', 'eq', 'off') | map(attribute='entity_id') | list }}"
  switch_entities_off: "{{ expand(light_switch.entity_id) | selectattr('domain', 'eq', 'switch') | selectattr('state', 'eq', 'off') | map(attribute='entity_id') | list }}"

# Split domains for light switch targets

  light_entities: "{{ expand(light_switch.entity_id) | selectattr('domain', 'eq', 'light') | map(attribute='entity_id') | list }}"
  switch_entities: "{{ expand(light_switch.entity_id) | selectattr('domain', 'eq', 'switch') | map(attribute='entity_id') | list }}"
  scene_entities: >-
    {% set a = light_switch.entity_id %}
    {% if boolean_scenes_scripts == [] %}
      {{ expand(a) | selectattr('domain', 'eq', 'scene') | map(attribute='entity_id') | list }}
    {% elif is_state(boolean_scenes_scripts, 'off') %}
      {{ expand(a) | selectattr('domain', 'eq', 'scene') | map(attribute='entity_id') | list }}
    {% else %}
      []
    {% endif %}
  script_entities: >-
    {% set a = light_switch.entity_id %}
    {% if boolean_scenes_scripts == [] %}
      {{ expand(a) | selectattr('domain', 'eq', 'script') | map(attribute='entity_id') | list }}
    {% elif is_state(boolean_scenes_scripts, 'off') %}
      {{ expand(a) | selectattr('domain', 'eq', 'script') | map(attribute='entity_id') | list }}
    {% else %}
      []
    {% endif %}
  boolean_scenes_scripts_helper: >-
    {% if boolean_scenes_scripts | length > 0 and states(boolean_scenes_scripts) == 'off' %}
      {{ boolean_scenes_scripts }}
    {% else %}
      []
    {% endif %}

# Split domains for end scenes and scripts

  end_scene_entities: "{{ end_scenes | select('match', '^scene\\..*') | list }}"
  end_script_entities: "{{ end_scenes | select('match', '^script\\..*') | list }}"

# Split domains for night lights target and check the entities are OFF - exclude scenes and scripts as they have no off state

  night_light_entities_off: >-
    {% set b =  night_lights and night_lights.entity_id %}
    {% if b %}
      {{ expand(b) | selectattr('domain', 'eq', 'light') | selectattr('state', 'eq', 'off') | map(attribute='entity_id') | list }}
    {% else %}
      []
    {% endif %}
  night_switch_entities_off: >-
    {% set b =  night_lights and night_lights.entity_id %}
    {% if b %}
      {{ expand(b) | selectattr('domain', 'eq', 'switch') | selectattr('state', 'eq', 'off') | map(attribute='entity_id') | list }}
    {% else %}
      []
    {% endif %}

# Split domains for night lights target

  night_light_entities: >-
    {% set b =  night_lights and night_lights.entity_id %}
    {% if b %}
      {{ expand(b) | selectattr('domain', 'eq', 'light') | map(attribute='entity_id') | list }}
    {% else %}
      []
    {% endif %}
  night_switch_entities: >-
    {% set b =  night_lights and night_lights.entity_id %}
    {% if b %}
      {{ expand(b) | selectattr('domain', 'eq', 'switch') | map(attribute='entity_id') | list }}
    {% else %}
      []
    {% endif %}
  night_scene_entities: >-
    {% set b = night_lights and night_lights.entity_id %}
    {% if night_boolean_scenes_scripts == [] %}
      {{ expand(b) | selectattr('domain', 'eq', 'scene') | map(attribute='entity_id') | list }}
    {% elif is_state(night_boolean_scenes_scripts, 'off') %}
      {{ expand(b) | selectattr('domain', 'eq', 'scene') | map(attribute='entity_id') | list }}
    {% else %}
      []
    {% endif %}
  night_script_entities: >-
    {% set b = night_lights and night_lights.entity_id %}
    {% if night_boolean_scenes_scripts == [] %}
      {{ expand(b) | selectattr('domain', 'eq', 'script') | map(attribute='entity_id') | list }}
    {% elif is_state(night_boolean_scenes_scripts, 'off') %}
      {{ expand(b) | selectattr('domain', 'eq', 'script') | map(attribute='entity_id') | list }}
    {% else %}
      []
    {% endif %}
  night_boolean_scenes_scripts_helper: >-
    {% if night_boolean_scenes_scripts | length > 0 and states(night_boolean_scenes_scripts) == 'off' %}
      {{ night_boolean_scenes_scripts }}
    {% else %}
      []
    {% endif %}

# Set up crossover lights for T4, T5 & t6 trigger. This is to stop the light flicker - exclude scenes and scripts as they have no off state

  crossover_lights_light: >-
    {% set a = light_switch.entity_id %}
    {% set b =  night_lights and night_lights.entity_id %}
    {% if a and b %}
      {{ expand(a) | reject('in', expand(b)) | selectattr('domain', 'eq', 'light') | map(attribute='entity_id') | list }}
    {% else %}
      []
    {% endif %}
  crossover_lights_switch: >-
    {% set a = light_switch.entity_id %}
    {% set b =  night_lights and night_lights.entity_id %}
    {% if a and b %}
      {{ expand(a) | reject('in', expand(b)) | selectattr('domain', 'eq', 'switch') | map(attribute='entity_id') | list }}
    {% else %}
      []
    {% endif %}
  crossover_night_lights_light_on: >-
    {% set b =  night_lights and night_lights.entity_id %}
    {% if b %}
      {{ expand(b) | selectattr('domain', 'eq', 'light') | selectattr('state', 'eq', 'on') | map(attribute='entity_id') | list }}
    {% else %}
      []
    {% endif %}

# Set up crossover lights for t12, t13 & t14 trigger. This is to stop the light flicker - exclude scenes and scripts as they have no off state

  crossover_night_lights_light: >-
    {% set a = light_switch.entity_id %}
    {% set b =  night_lights and night_lights.entity_id %}
    {% if a and b %}
      {{ expand(b) | reject('in', expand(a)) | selectattr('domain', 'eq', 'light') | map(attribute='entity_id') | list }}
    {% else %}
      []
    {% endif %}
  crossover_night_lights_switch: >-
    {% set a = light_switch.entity_id %}
    {% set b =  night_lights and night_lights.entity_id %}
    {% if a and b %}
      {{ expand(b) | reject('in', expand(a)) | selectattr('domain', 'eq', 'switch') | map(attribute='entity_id') | list }}
    {% else %}
      []
    {% endif %}
  crossover_lights_light_on: >-
    {% set a = light_switch.entity_id %}
    {% if a %}
      {{ expand(a) | selectattr('domain', 'eq', 'light') | selectattr('state', 'eq', 'on') | map(attribute='entity_id') | list }}
    {% else %}
      []
    {% endif %}

trigger:
  - platform: state
    id: "t0"
    entity_id: !input motion_trigger
    from: "off"
    to: "on"
  - platform: numeric_state
    id: "t1"
    entity_id: sun.sun
    attribute: elevation
    below: !input sun_elevation
  - platform: numeric_state
    id: "t2"
    entity_id: !input ambient_light_sensor
    below: !input ambient_light_value
  - platform: time
    id: "t3"
    at: !input after_time
  - platform: state
    id: "t4"
    entity_id: !input night_lights_entity_state
    from: "off"
    to: "on"
  - platform: time
    id: "t5"
    at: !input night_lights_after_time
  - platform: numeric_state
    id: "t6"
    entity_id: sun.sun
    attribute: elevation
    below: !input night_lights_sun_elevation
  - platform: state
    id: "t7_on"
    entity_id: !input motion_bypass_lights_on
    from: "off"
    to: "on"
  - platform: state
    id: "t7_off"
    entity_id: !input motion_bypass_lights_off
    from: "off"
    to: "on"
  - platform: state
    id: "t7_stop"
    entity_id: !input motion_bypass_lights_stop
    from: "off"
    to: "on"
  - platform: state
    id: "t8_on"
    entity_id: !input motion_bypass_lights_on
    from: "on"
    to: "off"
  - platform: state
    id: "t8_off"
    entity_id: !input motion_bypass_lights_off
    from: "on"
    to: "off"
  - platform: state
    id: "t8_stop"
    entity_id: !input motion_bypass_lights_stop
    from: "on"
    to: "off"
  - platform: numeric_state
    id: "t9"
    entity_id: sun.sun
    attribute: elevation
    above: !input sun_elevation_rising
  - platform: numeric_state
    id: "t10"
    entity_id: !input ambient_light_sensor
    above: !input ambient_light_high_value
  - platform: time
    id: "t11"
    at: !input before_time
  - platform: state
    id: "t12"
    entity_id: !input night_lights_entity_state
    from: "on"
    to: "off"
  - platform: time
    id: "t13"
    at: !input night_lights_before_time
  - platform: numeric_state
    id: "t14"
    entity_id: sun.sun
    attribute: elevation
    above: !input night_lights_sun_elevation_rising
  - platform: homeassistant
    id: "t15"
    event: start

# All Conditions
condition:
#Trigger conditions
  - condition: or
    conditions:
      - condition: and # trigger from off to on
        conditions:
          - condition: state
            entity_id: !input motion_trigger
            match: any
            state: 'on'
          - condition: trigger
            id: 't0'
      - condition: and # trigger by sun & check motion trigger is on
        conditions:
          - condition: state
            entity_id: !input motion_trigger
            state: 'on'
            match: any
          - "{{ include_sun == 'sun_enabled' }}"
          - condition: trigger
            id: 't1'
      - condition: and # trigger by ambient & check motion trigger is on
        conditions:
          - condition: state
            entity_id: !input motion_trigger
            state: 'on'
            match: any
          - "{{ include_ambient == 'ambient_enabled' }}"
          - condition: trigger
            id: 't2'
      - condition: and # trigger by time & check motion trigger is on
        conditions:
          - condition: state
            entity_id: !input motion_trigger
            state: 'on'
            match: any
          -  "{{ include_time == 'time_enabled' }}"
          - condition: trigger
            id: 't3'
      - condition: and # trigger by the start of night light entity state & check if any lights are on
        conditions:
          - condition: trigger
            id: 't4'
          - "{{ include_night_lights == 'night_lights_enabled' }}"
          - "{{ 'entity_state_enabled' in night_lights_conditions }}"
          - condition: state
            entity_id: !input night_lights_entity_state
            match: any
            state: 'on'
          - condition: or
            conditions:
              - "{{ (expand(light_switch.entity_id) | selectattr('state', '==', 'on') | list | count > 0) }}"
              - "{{ (include_night_lights == 'night_lights_enabled') and (expand(night_lights.entity_id) | selectattr('state', '==', 'on') | list | count > 0) }}"
              - condition: template
                value_template: "{{ 'manage_scripts_crossing_over' in include_night_light_control }}"
              - condition: template
                value_template: >-
                  {% if boolean_scenes_scripts != [] %}
                    {{ is_state(boolean_scenes_scripts, 'on') }}
                  {% endif %}
              - condition: template
                value_template: >-
                  {% if night_boolean_scenes_scripts != [] %}
                    {{ is_state(night_boolean_scenes_scripts, 'on') }}
                  {% endif %}
      - condition: and # trigger by the start of night lights time & check if any lights are on
        conditions:
          - condition: trigger
            id: 't5'
          - "{{ include_night_lights == 'night_lights_enabled' }}"
          - "{{ 'time_enabled' in night_lights_conditions }}"
          - condition: or
            conditions:
              - "{{ (expand(light_switch.entity_id) | selectattr('state', '==', 'on') | list | count > 0) }}"
              - "{{ (include_night_lights == 'night_lights_enabled') and (expand(night_lights.entity_id) | selectattr('state', '==', 'on') | list | count > 0) }}"
              - condition: template
                value_template: "{{ 'manage_scripts_crossing_over' in include_night_light_control }}"
              - condition: template
                value_template: >-
                  {% if boolean_scenes_scripts != [] %}
                    {{ is_state(boolean_scenes_scripts, 'on') }}
                  {% endif %}
              - condition: template
                value_template: >-
                  {% if night_boolean_scenes_scripts != [] %}
                    {{ is_state(night_boolean_scenes_scripts, 'on') }}
                  {% endif %}
      - condition: and # trigger by the start of night lights sun elevation & check if any lights are on
        conditions:
          - condition: trigger
            id: 't6'
          - "{{ include_night_lights == 'night_lights_enabled' }}"
          - "{{ 'sun_enabled' in night_lights_conditions }}"
          - condition: or
            conditions:
              - "{{ (expand(light_switch.entity_id) | selectattr('state', '==', 'on') | list | count > 0) }}"
              - "{{ (include_night_lights == 'night_lights_enabled') and (expand(night_lights.entity_id) | selectattr('state', '==', 'on') | list | count > 0) }}"
              - condition: template
                value_template: "{{ 'manage_scripts_crossing_over' in include_night_light_control }}"
              - condition: template
                value_template: >-
                  {% if boolean_scenes_scripts != [] %}
                    {{ is_state(boolean_scenes_scripts, 'on') }}
                  {% endif %}
              - condition: template
                value_template: >-
                  {% if night_boolean_scenes_scripts != [] %}
                    {{ is_state(night_boolean_scenes_scripts, 'on') }}
                  {% endif %}
      - condition: and # trigger by by-pass turning on
        conditions:
          - condition: trigger
            id: 't7_on'
          - "{{ 'bypass_enabled_turn_on' in include_bypass }}"
      - condition: and # trigger by by-pass turning off
        conditions:
          - condition: trigger
            id: 't7_off'
          - "{{ 'bypass_enabled_turn_off' in include_bypass }}"
      - condition: and # trigger by by-pass stop
        conditions:
          - condition: trigger
            id: 't7_stop'
          - "{{ 'bypass_enabled_stop' in include_bypass }}"
      - condition: and # trigger by by-pass turning on
        conditions:
          - condition: trigger
            id: 't8_on'
          - "{{ 'bypass_enabled_turn_on' in include_bypass }}"
      - condition: and # trigger by by-pass turning off
        conditions:
          - condition: trigger
            id: 't8_off'
          - "{{ 'bypass_enabled_turn_off' in  include_bypass }}"
      - condition: and # trigger by by-pass stop
        conditions:
          - condition: trigger
            id: 't8_stop'
          - "{{ 'bypass_enabled_stop' in include_bypass }}"
      - condition: and # trigger by rising of the sun & check if the lights are ON
        conditions:
          - condition: trigger
            id: 't9'
          - "{{ include_sun == 'sun_enabled' }}"
          - condition: or
            conditions:
              - "{{ (expand(light_switch.entity_id) | selectattr('state', '==', 'on') | list | count > 0) }}"
              - "{{ (include_night_lights == 'night_lights_enabled') and (expand(night_lights.entity_id) | selectattr('state', '==', 'on') | list | count > 0) }}"
              - condition: template
                value_template: >-
                  {% if boolean_scenes_scripts != [] %}
                    {{ is_state(boolean_scenes_scripts, 'on') }}
                  {% endif %}
              - condition: template
                value_template: >-
                  {% if night_boolean_scenes_scripts != [] %}
                    {{ is_state(night_boolean_scenes_scripts, 'on') }}
                  {% endif %}
      - condition: and # trigger by rising of the ambient high lux value, the ambient site condition is set to NO & check if the lights are ON
        conditions:
          - condition: trigger
            id: 't10'
          - "{{ include_ambient == 'ambient_enabled' }}"
          - "{{ ambient_light_options == 'ambient_light_option_disabled' }}"
          - condition: or
            conditions:
              - "{{ (expand(light_switch.entity_id) | selectattr('state', '==', 'on') | list | count > 0) }}"
              - "{{ (include_night_lights == 'night_lights_enabled') and (expand(night_lights.entity_id) | selectattr('state', '==', 'on') | list | count > 0) }}"
              - condition: template
                value_template: >-
                  {% if boolean_scenes_scripts != [] %}
                    {{ is_state(boolean_scenes_scripts, 'on') }}
                  {% endif %}
              - condition: template
                value_template: >-
                  {% if night_boolean_scenes_scripts != [] %}
                    {{ is_state(night_boolean_scenes_scripts, 'on') }}
                  {% endif %}
      - condition: and # trigger by the end time & check if the lights are ON
        conditions:
          - condition: trigger
            id: 't11'
          -  "{{ include_time == 'time_enabled' }}"
          - condition: or
            conditions:
              - "{{ (expand(light_switch.entity_id) | selectattr('state', '==', 'on') | list | count > 0) }}"
              - "{{ (include_night_lights == 'night_lights_enabled') and (expand(night_lights.entity_id) | selectattr('state', '==', 'on') | list | count > 0) }}"
              - condition: template
                value_template: >-
                  {% if boolean_scenes_scripts != [] %}
                    {{ is_state(boolean_scenes_scripts, 'on') }}
                  {% endif %}
              - condition: template
                value_template: >-
                  {% if night_boolean_scenes_scripts != [] %}
                    {{ is_state(night_boolean_scenes_scripts, 'on') }}
                  {% endif %}
      - condition: and # trigger by the end of night lights entity state & check if any lights are on
        conditions:
          - condition: trigger
            id: 't12'
          - "{{ include_night_lights == 'night_lights_enabled' }}"
          - "{{ 'entity_state_enabled' in night_lights_conditions }}"
          - condition: state
            entity_id: !input night_lights_entity_state
            state: 'off'
          - condition: or
            conditions:
              - "{{ (expand(light_switch.entity_id) | selectattr('state', '==', 'on') | list | count > 0) }}"
              - "{{ (include_night_lights == 'night_lights_enabled') and (expand(night_lights.entity_id) | selectattr('state', '==', 'on') | list | count > 0) }}"
              - condition: template
                value_template: "{{ 'manage_scripts_crossing_over' in include_night_light_control }}"
              - condition: template
                value_template: >-
                  {% if boolean_scenes_scripts != [] %}
                    {{ is_state(boolean_scenes_scripts, 'on') }}
                  {% endif %}
              - condition: template
                value_template: >-
                  {% if night_boolean_scenes_scripts != [] %}
                    {{ is_state(night_boolean_scenes_scripts, 'on') }}
                  {% endif %}
      - condition: and # trigger by the end of night lights time & check if any lights are on
        conditions:
          - condition: trigger
            id: 't13'
          - "{{ include_night_lights == 'night_lights_enabled' }}"
          - "{{ 'time_enabled' in night_lights_conditions }}"
          - condition: or
            conditions:
              - "{{ (expand(light_switch.entity_id) | selectattr('state', '==', 'on') | list | count > 0) }}"
              - "{{ (include_night_lights == 'night_lights_enabled') and (expand(night_lights.entity_id) | selectattr('state', '==', 'on') | list | count > 0) }}"
              - condition: template
                value_template: "{{ 'manage_scripts_crossing_over' in include_night_light_control }}"
              - condition: template
                value_template: >-
                  {% if boolean_scenes_scripts != [] %}
                    {{ is_state(boolean_scenes_scripts, 'on') }}
                  {% endif %}
              - condition: template
                value_template: >-
                  {% if night_boolean_scenes_scripts != [] %}
                    {{ is_state(night_boolean_scenes_scripts, 'on') }}
                  {% endif %}
      - condition: and # trigger by the end of night lights sun elevation & check if any lights are on
        conditions:
          - condition: trigger
            id: 't14'
          - "{{ include_night_lights == 'night_lights_enabled' }}"
          - "{{ 'sun_enabled' in night_lights_conditions }}"
          - condition: or
            conditions:
              - "{{ (expand(light_switch.entity_id) | selectattr('state', '==', 'on') | list | count > 0) }}"
              - "{{ (include_night_lights == 'night_lights_enabled') and (expand(night_lights.entity_id) | selectattr('state', '==', 'on') | list | count > 0) }}"
              - condition: template
                value_template: "{{ 'manage_scripts_crossing_over' in include_night_light_control }}"
              - condition: template
                value_template: >-
                  {% if boolean_scenes_scripts != [] %}
                    {{ is_state(boolean_scenes_scripts, 'on') }}
                  {% endif %}
              - condition: template
                value_template: >-
                  {% if night_boolean_scenes_scripts != [] %}
                    {{ is_state(night_boolean_scenes_scripts, 'on') }}
                  {% endif %}
      - condition: and # trigger by HA Restart & check if any lights are on
        conditions:
          - condition: trigger
            id: 't15'
          - condition: or
            conditions:
              - "{{ (expand(light_switch.entity_id) | selectattr('state', '==', 'on') | list | count > 0) }}"
              - "{{ (include_night_lights == 'night_lights_enabled') and (expand(night_lights.entity_id) | selectattr('state', '==', 'on') | list | count > 0) }}"
              - condition: template
                value_template: >-
                  {% if boolean_scenes_scripts != [] %}
                    {{ is_state(boolean_scenes_scripts, 'on') }}
                  {% endif %}
              - condition: template
                value_template: >-
                  {% if night_boolean_scenes_scripts != [] %}
                    {{ is_state(night_boolean_scenes_scripts, 'on') }}
                  {% endif %}
      - condition: and # trigger by HA Restart & check if any triggers are on
        conditions:
          - condition: state
            entity_id: !input motion_trigger
            match: any
            state: 'on'
          - condition: trigger
            id: 't15'
      - condition: and # trigger by HA Restart & check if by-pass auto off is enabled and any by-passes are on
        conditions:
          - "{{ ('bypass_auto_off_enabled_on' in include_bypass_auto_off) or ('bypass_auto_off_enabled_off' in include_bypass_auto_off) or ('bypass_auto_off_enabled_stop' in include_bypass_auto_off) }}"
          - condition: trigger
            id: 't15'
          - condition: or
            conditions:
              - condition: state
                entity_id: !input motion_bypass_lights_on
                match: any
                state: 'on'
              - condition: state
                entity_id: !input motion_bypass_lights_off
                match: any
                state: 'on'
              - condition: state
                entity_id: !input motion_bypass_lights_stop
                match: any
                state: 'on'

# Check Motion Sensor Manual By-pass
  - condition: or
    conditions:
      - "{{ include_bypass == [] }}"
      - condition: and
        conditions:
          - "{{ ('bypass_enabled_turn_on' in include_bypass) and ('bypass_enabled_turn_off' in include_bypass) and ('bypass_enabled_stop' in include_bypass) }}"
          - condition: state
            entity_id: !input motion_bypass_lights_on
            state: 'off'
          - condition: state
            entity_id: !input motion_bypass_lights_off
            state: 'off'
          - condition: state
            entity_id: !input motion_bypass_lights_stop
            state: 'off'
      - condition: and
        conditions:
          - "{{ ('bypass_enabled_turn_on' in include_bypass) and ('bypass_enabled_turn_off' in include_bypass) and ('bypass_enabled_stop' not in include_bypass) }}"
          - condition: state
            entity_id: !input motion_bypass_lights_on
            state: 'off'
          - condition: state
            entity_id: !input motion_bypass_lights_off
            state: 'off'
      - condition: and
        conditions:
          - "{{ ('bypass_enabled_turn_on' in include_bypass) and ('bypass_enabled_turn_off' not in include_bypass) and ('bypass_enabled_stop' in include_bypass) }}"
          - condition: state
            entity_id: !input motion_bypass_lights_on
            state: 'off'
          - condition: state
            entity_id: !input motion_bypass_lights_stop
            state: 'off'
      - condition: and
        conditions:
          - "{{ ('bypass_enabled_turn_on' not in include_bypass) and ('bypass_enabled_turn_off' in include_bypass) and ('bypass_enabled_stop' in include_bypass) }}"
          - condition: state
            entity_id: !input motion_bypass_lights_off
            state: 'off'
          - condition: state
            entity_id: !input motion_bypass_lights_stop
            state: 'off'
      - condition: and
        conditions:
          - "{{ ('bypass_enabled_turn_on' in include_bypass) and ('bypass_enabled_turn_off' not in include_bypass) and ('bypass_enabled_stop' not in include_bypass) }}"
          - condition: state
            entity_id: !input motion_bypass_lights_on
            state: 'off'
      - condition: and
        conditions:
          - "{{ ('bypass_enabled_turn_on' not in include_bypass) and ('bypass_enabled_turn_off' in include_bypass) and ('bypass_enabled_stop' not in include_bypass) }}"
          - condition: state
            entity_id: !input motion_bypass_lights_off
            state: 'off'
      - condition: and
        conditions:
          - "{{ ('bypass_enabled_turn_on' not in include_bypass) and ('bypass_enabled_turn_off' not in include_bypass) and ('bypass_enabled_stop' in include_bypass) }}"
          - condition: state
            entity_id: !input motion_bypass_lights_stop
            state: 'off'
      - condition: trigger
        id: 
          - 't7_on'
          - 't7_off'
          - 't7_stop'
          - 't8_on'
          - 't8_off'
          - 't8_stop'
          - 't15'

# Check Sun Elevation
  - condition: or
    conditions:
      - "{{ include_sun == 'sun_disabled' }}"
      - "{{ include_sun == 'sun_enabled_night_lights' }}"
      - "{{ (include_sun == 'sun_enabled') and (is_state_attr('sun.sun', 'rising', false)) and (state_attr('sun.sun','elevation') <= sun_elevation | float(90)) }}"
      - "{{ (include_sun == 'sun_enabled') and (is_state_attr('sun.sun', 'rising', true)) and (state_attr('sun.sun','elevation') <= sun_elevation_rising | float(90)) }}"
      - condition: trigger
        id: 
          - 't7_on'
          - 't7_off'
          - 't7_stop'
          - 't8_on'
          - 't8_off'
          - 't8_stop'
          - 't9'

# Check Ambient Light Sensor
  - condition: or
    conditions:
      - "{{ include_ambient == 'ambient_disabled' }}"
      - "{{ ambient_light_sensor == [] }}"
      - "{{ (include_ambient == 'ambient_enabled') and (states[ambient_light_sensor].state | int < ambient_light_value | int) }}"
      - "{{ (include_ambient == 'ambient_enabled') and (states[ambient_light_sensor].state | int < ambient_light_high_value | int) and (expand(light_switch.entity_id) | selectattr('state', '==', 'on') | list | count > 0) }}"
      - "{{ (include_ambient == 'ambient_enabled') and (states[ambient_light_sensor].state | int < ambient_light_high_value | int) and ((include_night_lights == 'night_lights_enabled') and (expand(night_lights.entity_id) | selectattr('state', '==', 'on') | list | count > 0)) }}"
      - "{{ (include_ambient == 'ambient_enabled') and (ambient_light_options == 'ambient_light_option_enabled') and (expand(light_switch.entity_id) | selectattr('state', '==', 'on') | list | count > 0) }}"
      - "{{ (include_ambient == 'ambient_enabled') and (ambient_light_options == 'ambient_light_option_enabled') and ((include_night_lights == 'night_lights_enabled') and (expand(night_lights.entity_id) | selectattr('state', '==', 'on') | list | count > 0)) }}"
      - condition: and
        conditions:
          - "{{ (include_ambient == 'ambient_enabled') and (states[ambient_light_sensor].state | int < ambient_light_high_value | int) }}"
          - condition: template
            value_template: >-
              {% if boolean_scenes_scripts != [] %}
                {{ is_state(boolean_scenes_scripts, 'on') }}
              {% endif %}
      - condition: and
        conditions:
          - "{{ (include_ambient == 'ambient_enabled') and (states[ambient_light_sensor].state | int < ambient_light_high_value | int) }}"
          - condition: template
            value_template: >-
              {% if night_boolean_scenes_scripts != [] %}
                {{ is_state(night_boolean_scenes_scripts, 'on') }}
              {% endif %}
      - condition: and
        conditions:
          - "{{ (include_ambient == 'ambient_enabled') and ( ambient_light_options == 'ambient_light_option_enabled' ) }}"
          - condition: template
            value_template: >-
              {% if boolean_scenes_scripts != [] %}
                {{ is_state(boolean_scenes_scripts, 'on') }}
              {% endif %}
      - condition: and
        conditions:
          - "{{ (include_ambient == 'ambient_enabled') and ( ambient_light_options == 'ambient_light_option_enabled' ) }}"
          - condition: template
            value_template: >-
              {% if night_boolean_scenes_scripts != [] %}
                {{ is_state(night_boolean_scenes_scripts, 'on') }}
              {% endif %}
      - condition: trigger
        id:
          - 't7_on'
          - 't7_off'
          - 't7_stop'
          - 't8_on'
          - 't8_off'
          - 't8_stop'
          - 't10'

# Check The Time Options
  - condition: or
    conditions:
      - "{{ include_time == 'time_disabled' }}"
      - condition: and
        conditions:
        - condition: time
          after: !input after_time
          before: !input before_time
          weekday: !input weekday_options
        -  "{{ include_time == 'time_enabled' }}"
      - condition: trigger
        id:
          - 't7_on'
          - 't7_off'
          - 't7_stop'
          - 't8_on'
          - 't8_off'
          - 't8_stop'
          - 't11'

# Check the Device Tracker Options
  - condition: or
    conditions:
      - "{{ include_device_tracker == 'device_tracker_disabled' }}"
      - condition: and
        conditions:
        - condition: numeric_state
          entity_id: !input zone
          above: 0
        - "{{ include_device_tracker == 'zone_enabled' }}"
      - condition: and
        conditions:
        - "{{ (state_attr(zone, 'persons') + people) | count != dict.fromkeys(state_attr(zone, 'persons') + people) | count }}"
        - "{{ include_device_tracker == 'zone_people_enabled' }}"
      - condition: trigger
        id:
          - 't7_on'
          - 't7_off'
          - 't7_stop'
          - 't8_on'
          - 't8_off'
          - 't8_stop'

action:
  - choose:
      - alias: "Check if the night lights are enabled and within the night lights conditions"
        conditions:
          - condition: and
            conditions:
              - alias: "Check if night lights is enabled"
                condition: or
                conditions:
                  - "{{ 'night_lights_enabled' in include_night_lights }}"
              - alias: "Check if night lights entity state is enabled"
                condition: or
                conditions:
                  - "{{ ('time_enabled' in night_lights_conditions) and not ('entity_state_enabled' in night_lights_conditions) }}"
                  - "{{ ('sun_enabled' in night_lights_conditions) and not ('entity_state_enabled' in night_lights_conditions) }}"
                  - condition: and
                    conditions:
                      - "{{ 'entity_state_enabled' in night_lights_conditions }}"
                      - condition: state
                        entity_id: !input night_lights_entity_state
                        state: 'on'
                        match: any
              - alias: "Check if night lights time is enabled"
                condition: or
                conditions:
                  - "{{ ('entity_state_enabled' in night_lights_conditions)  and not ('time_enabled' in night_lights_conditions) }}"
                  - "{{ ('sun_enabled' in night_lights_conditions)  and not ('time_enabled' in night_lights_conditions) }}"
                  - condition: and
                    conditions:
                      - "{{ 'time_enabled' in night_lights_conditions }}"
                      - condition: time
                        after: !input night_lights_after_time
                        before: !input night_lights_before_time
              - alias: "Check if night lights sun is enabled"
                condition: or
                conditions:
                  - "{{ ('entity_state_enabled' in night_lights_conditions)  and not ('sun_enabled' in night_lights_conditions) }}"
                  - "{{ ('time_enabled' in night_lights_conditions)  and not ('sun_enabled' in night_lights_conditions) }}"
                  - "{{ ('sun_enabled' in night_lights_conditions) and (((is_state_attr('sun.sun', 'rising', false)) and (state_attr('sun.sun','elevation') <= night_lights_sun_elevation | float(90))) or ((is_state_attr('sun.sun', 'rising', true)) and (state_attr('sun.sun','elevation') <= night_lights_sun_elevation_rising | float(90)))) }}"
        sequence:
          - choose:
            - alias: "By-pass is turned on  & check by-pass option - turn lights off"
              conditions:
                - condition: trigger
                  id: 't7_off'
              sequence:
                - alias: "Wait the number of minutes set in the by-pass time delay"
                  delay:
                    minutes: !input bypass_time_delay
                - choose:
                  - alias: "If transition is selected"
                    conditions:
                      - condition: template
                        value_template: "{{ 'use_transition' in include_night_light_control }}"
                    sequence:
                      - alias: "Turn off the lights"
                        service: light.turn_off
                        target:
                          entity_id: "{{ night_light_entities }}"
                        data:
                          transition: "{{ night_transition_off_value }}"
                      - alias: "Turn off the scenes"
                        service: scene.turn_on
                        data:
                          entity_id: "{{ end_scene_entities }}"
                          transition: "{{ night_transition_off_value }}"
                  - alias: "If transition is not selected"
                    conditions:
                      - condition: template
                        value_template: "{{ 'use_transition' not in include_night_light_control }}"
                    sequence:
                      - alias: "Turn off the lights"
                        service: light.turn_off
                        target:
                          entity_id: "{{ night_light_entities }}"
                      - alias: "Turn off the scenes"
                        service: scene.turn_on
                        data:
                          entity_id: "{{ end_scene_entities }}"
                - alias: "Turn off the switches"
                  service: switch.turn_off
                  target:
                    entity_id: "{{ night_switch_entities }}"
                - alias: "Turn off the script"
                  service: script.turn_on
                  data:
                    entity_id: "{{ end_script_entities }}"
                - alias: "Turn off the boolean for scenes and scripts"
                  service: input_boolean.turn_off
                  data:
                    entity_id: !input boolean_scenes_scripts
                - alias: "Turn off the boolean for scenes and scripts"
                  service: input_boolean.turn_off
                  data:
                    entity_id: !input night_boolean_scenes_scripts
                - alias: "Check by-pass settings and preform the correct action"
                  if:
                    - alias: "Check if the by-pass auto off is enabled"
                      condition: template
                      value_template: "{{ ('bypass_auto_off_enabled_on' in include_bypass_auto_off) or ('bypass_auto_off_enabled_off' in include_bypass_auto_off) or ('bypass_auto_off_enabled_stop' in include_bypass_auto_off) }}"
                  then:
                    - alias: "Wait the number of minutes set in the by-pass auto off time delay"
                      delay: 
                        minutes: !input bypass_auto_off_delay
                    - alias: Parallel Actions for the by-pass auto off
                      parallel:
                        - sequence:
                            - choose:
                                - conditions:
                                    - condition: template
                                      value_template: "{{ ('bypass_enabled_turn_on' in include_bypass) and ('bypass_auto_off_enabled_on' in include_bypass_auto_off) }}"
                                  sequence:
                                    - alias: "Turn off the by-pass"
                                      service: homeassistant.turn_off
                                      entity_id: !input motion_bypass_lights_on
                        - sequence:
                            - choose:
                                - conditions:
                                    - condition: template
                                      value_template: "{{ ('bypass_enabled_turn_off' in include_bypass) and ('bypass_auto_off_enabled_off' in include_bypass_auto_off) }}"
                                  sequence:
                                    - alias: "Turn off the by-pass"
                                      service: homeassistant.turn_off
                                      entity_id: !input motion_bypass_lights_off
                        - sequence:
                            - choose:
                                - conditions:
                                    - condition: template
                                      value_template: "{{ ('bypass_enabled_stop' in include_bypass) and ('bypass_auto_off_enabled_stop' in include_bypass_auto_off) }}"
                                  sequence:
                                    - alias: "Turn off the by-pass"
                                      service: homeassistant.turn_off
                                      entity_id: !input motion_bypass_lights_stop
                    - stop: "Stop the automation"
                  else:
                    - stop: "Stop the automation"
            - alias: "By-pass is turned on  & check by-pass option - Keep the current lights state"
              conditions:
                - condition: trigger
                  id: 't7_stop'
              sequence:
                - alias: "Check by-pass settings and preform the correct action"
                  if:
                    - alias: "Check if the by-pass auto off is enabled"
                      condition: template
                      value_template: "{{ ('bypass_auto_off_enabled_on' in include_bypass_auto_off) or ('bypass_auto_off_enabled_off' in include_bypass_auto_off) or ('bypass_auto_off_enabled_stop' in include_bypass_auto_off) }}"
                  then:
                    - alias: "Wait the number of minutes set in the by-pass auto off time delay"
                      delay: 
                        minutes: !input bypass_auto_off_delay
                    - alias: Parallel Actions for the by-pass auto off
                      parallel:
                        - sequence:
                            - choose:
                                - conditions:
                                    - condition: template
                                      value_template: "{{ ('bypass_enabled_turn_on' in include_bypass) and ('bypass_auto_off_enabled_on' in include_bypass_auto_off) }}"
                                  sequence:
                                    - alias: "Turn off the by-pass"
                                      service: homeassistant.turn_off
                                      entity_id: !input motion_bypass_lights_on
                        - sequence:
                            - choose:
                                - conditions:
                                    - condition: template
                                      value_template: "{{ ('bypass_enabled_turn_off' in include_bypass) and ('bypass_auto_off_enabled_off' in include_bypass_auto_off) }}"
                                  sequence:
                                    - alias: "Turn off the by-pass"
                                      service: homeassistant.turn_off
                                      entity_id: !input motion_bypass_lights_off
                        - sequence:
                            - choose:
                                - conditions:
                                    - condition: template
                                      value_template: "{{ ('bypass_enabled_stop' in include_bypass) and ('bypass_auto_off_enabled_stop' in include_bypass_auto_off) }}"
                                  sequence:
                                    - alias: "Turn off the by-pass"
                                      service: homeassistant.turn_off
                                      entity_id: !input motion_bypass_lights_stop
                    - stop: "Stop the automation"
                  else:
                    - stop: "Stop the automation"
          - choose:
            - alias: "By-pass is turned off  & check if the motion trigger is off"
              conditions:
                - condition: trigger
                  id:
                    - 't8_on'
                    - 't8_off'
                    - 't8_stop'
                - condition: state
                  entity_id: !input motion_trigger
                  match: all
                  state: 'off'
              sequence:
                - choose:
                  - alias: "Check all by-pass are off"
                    conditions:
                      - condition: or
                        conditions:
                          - condition: and
                            conditions:
                              - "{{ ('bypass_enabled_turn_on' in include_bypass) and ('bypass_enabled_turn_off' in include_bypass) and ('bypass_enabled_stop' in include_bypass) }}"
                              - condition: state
                                entity_id: !input motion_bypass_lights_on
                                state: 'off'
                              - condition: state
                                entity_id: !input motion_bypass_lights_off
                                state: 'off'
                              - condition: state
                                entity_id: !input motion_bypass_lights_stop
                                state: 'off'
                          - condition: and
                            conditions:
                              - "{{ ('bypass_enabled_turn_on' in include_bypass) and ('bypass_enabled_turn_off' in include_bypass) and ('bypass_enabled_stop' not in include_bypass) }}"
                              - condition: state
                                entity_id: !input motion_bypass_lights_on
                                state: 'off'
                              - condition: state
                                entity_id: !input motion_bypass_lights_off
                                state: 'off'
                          - condition: and
                            conditions:
                              - "{{ ('bypass_enabled_turn_on' in include_bypass) and ('bypass_enabled_turn_off' not in include_bypass) and ('bypass_enabled_stop' in include_bypass) }}"
                              - condition: state
                                entity_id: !input motion_bypass_lights_on
                                state: 'off'
                              - condition: state
                                entity_id: !input motion_bypass_lights_stop
                                state: 'off'
                          - condition: and
                            conditions:
                              - "{{ ('bypass_enabled_turn_on' not in include_bypass) and ('bypass_enabled_turn_off' in include_bypass) and ('bypass_enabled_stop' in include_bypass) }}"
                              - condition: state
                                entity_id: !input motion_bypass_lights_off
                                state: 'off'
                              - condition: state
                                entity_id: !input motion_bypass_lights_stop
                                state: 'off'
                          - condition: and
                            conditions:
                              - "{{ ('bypass_enabled_turn_on' in include_bypass) and ('bypass_enabled_turn_off' not in include_bypass) and ('bypass_enabled_stop' not in include_bypass) }}"
                              - condition: state
                                entity_id: !input motion_bypass_lights_on
                                state: 'off'
                          - condition: and
                            conditions:
                              - "{{ ('bypass_enabled_turn_on' not in include_bypass) and ('bypass_enabled_turn_off' in include_bypass) and ('bypass_enabled_stop' not in include_bypass) }}"
                              - condition: state
                                entity_id: !input motion_bypass_lights_off
                                state: 'off'
                          - condition: and
                            conditions:
                              - "{{ ('bypass_enabled_turn_on' not in include_bypass) and ('bypass_enabled_turn_off' not in include_bypass) and ('bypass_enabled_stop' in include_bypass) }}"
                              - condition: state
                                entity_id: !input motion_bypass_lights_stop
                                state: 'off'
                    sequence:
                      - alias: "Wait the number of minutes set in the by-pass time delay"
                        delay:
                          minutes: !input bypass_time_delay
                      - choose:
                        - alias: "If transition is selected"
                          conditions:
                            - condition: template
                              value_template: "{{ 'use_transition' in include_night_light_control }}"
                          sequence:
                            - alias: "Turn off the lights"
                              service: light.turn_off
                              target:
                                entity_id: "{{ night_light_entities }}"
                              data:
                                transition: "{{ night_transition_off_value }}"
                            - alias: "Turn off the scenes"
                              service: scene.turn_on
                              data:
                                entity_id: "{{ end_scene_entities }}"
                                transition: "{{ night_transition_off_value }}"
                        - alias: "If transition is not selected"
                          conditions:
                            - condition: template
                              value_template: "{{ 'use_transition' not in include_night_light_control }}"
                          sequence:
                            - alias: "Turn off the lights"
                              service: light.turn_off
                              target:
                                entity_id: "{{ night_light_entities }}"
                            - alias: "Turn off the scenes"
                              service: scene.turn_on
                              data:
                                entity_id: "{{ end_scene_entities }}"
                      - alias: "Turn off the switches"
                        service: switch.turn_off
                        target:
                          entity_id: "{{ night_switch_entities }}"
                      - alias: "Turn off the script"
                        service: script.turn_on
                        data:
                          entity_id: "{{ end_script_entities }}"
                      - alias: "Turn off the boolean for scenes and scripts"
                        service: input_boolean.turn_off
                        data:
                          entity_id: !input boolean_scenes_scripts
                      - alias: "Turn off the boolean for scenes and scripts"
                        service: input_boolean.turn_off
                        data:
                          entity_id: !input night_boolean_scenes_scripts
                      - stop: "Stop the automation"
                  - alias: "Motion trigger is off and check if any by-passes are on"
                    conditions:
                      - condition: or
                        conditions:
                          - condition: and
                            conditions:
                              - "{{ ('bypass_enabled_turn_on' in include_bypass) and ('bypass_enabled_turn_off' in include_bypass) and ('bypass_enabled_stop' in include_bypass) }}"
                              - condition: or
                                conditions:
                                  - condition: state
                                    entity_id: !input motion_bypass_lights_on
                                    match: any
                                    state: 'on'
                                  - condition: state
                                    entity_id: !input motion_bypass_lights_off
                                    match: any
                                    state: 'on'
                                  - condition: state
                                    entity_id: !input motion_bypass_lights_stop
                                    match: any
                                    state: 'on'
                          - condition: and
                            conditions:
                              - "{{ ('bypass_enabled_turn_on' in include_bypass) and ('bypass_enabled_turn_off' in include_bypass) and ('bypass_enabled_stop' not in include_bypass) }}"
                              - condition: or
                                conditions:
                                  - condition: state
                                    entity_id: !input motion_bypass_lights_on
                                    match: any
                                    state: 'on'
                                  - condition: state
                                    entity_id: !input motion_bypass_lights_off
                                    match: any
                                    state: 'on'
                          - condition: and
                            conditions:
                              - "{{ ('bypass_enabled_turn_on' in include_bypass) and ('bypass_enabled_turn_off' not in include_bypass) and ('bypass_enabled_stop' in include_bypass) }}"
                              - condition: or
                                conditions:
                                  - condition: state
                                    entity_id: !input motion_bypass_lights_on
                                    match: any
                                    state: 'on'
                                  - condition: state
                                    entity_id: !input motion_bypass_lights_stop
                                    match: any
                                    state: 'on'
                          - condition: and
                            conditions:
                              - "{{ ('bypass_enabled_turn_on' not in include_bypass) and ('bypass_enabled_turn_off' in include_bypass) and ('bypass_enabled_stop' in include_bypass) }}"
                              - condition: or
                                conditions:
                                  - condition: state
                                    entity_id: !input motion_bypass_lights_off
                                    match: any
                                    state: 'on'
                                  - condition: state
                                    entity_id: !input motion_bypass_lights_stop
                                    match: any
                                    state: 'on'
                          - condition: and
                            conditions:
                              - "{{ ('bypass_enabled_turn_on' in include_bypass) and ('bypass_enabled_turn_off' not in include_bypass) and ('bypass_enabled_stop' not in include_bypass) }}"
                              - condition: state
                                entity_id: !input motion_bypass_lights_on
                                match: any
                                state: 'on'
                          - condition: and
                            conditions:
                              - "{{ ('bypass_enabled_turn_on' not in include_bypass) and ('bypass_enabled_turn_off' in include_bypass) and ('bypass_enabled_stop' not in include_bypass) }}"
                              - condition: state
                                entity_id: !input motion_bypass_lights_off
                                match: any
                                state: 'on'
                          - condition: and
                            conditions:
                              - "{{ ('bypass_enabled_turn_on' not in include_bypass) and ('bypass_enabled_turn_off' not in include_bypass) and ('bypass_enabled_stop' in include_bypass) }}"
                              - condition: state
                                entity_id: !input motion_bypass_lights_stop
                                match: any
                                state: 'on'
                    sequence:
                      - alias: "Check by-pass settings and preform the correct action"
                        if:
                          - alias: "Check if the by-pass auto off is enabled"
                            condition: template
                            value_template: "{{ ('bypass_auto_off_enabled_on' in include_bypass_auto_off) or ('bypass_auto_off_enabled_off' in include_bypass_auto_off) or ('bypass_auto_off_enabled_stop' in include_bypass_auto_off) }}"
                        then:
                          - alias: "Wait the number of minutes set in the by-pass auto off time delay"
                            delay: 
                              minutes: !input bypass_auto_off_delay
                          - alias: Parallel Actions for the by-pass auto off
                            parallel:
                              - sequence:
                                  - choose:
                                      - conditions:
                                          - condition: template
                                            value_template: "{{ ('bypass_enabled_turn_on' in include_bypass) and ('bypass_auto_off_enabled_on' in include_bypass_auto_off) }}"
                                        sequence:
                                          - alias: "Turn off the by-pass"
                                            service: homeassistant.turn_off
                                            entity_id: !input motion_bypass_lights_on
                              - sequence:
                                  - choose:
                                      - conditions:
                                          - condition: template
                                            value_template: "{{ ('bypass_enabled_turn_off' in include_bypass) and ('bypass_auto_off_enabled_off' in include_bypass_auto_off) }}"
                                        sequence:
                                          - alias: "Turn off the by-pass"
                                            service: homeassistant.turn_off
                                            entity_id: !input motion_bypass_lights_off
                              - sequence:
                                  - choose:
                                      - conditions:
                                          - condition: template
                                            value_template: "{{ ('bypass_enabled_stop' in include_bypass) and ('bypass_auto_off_enabled_stop' in include_bypass_auto_off) }}"
                                        sequence:
                                          - alias: "Turn off the by-pass"
                                            service: homeassistant.turn_off
                                            entity_id: !input motion_bypass_lights_stop
                      - stop: "Stop the automation"
            - alias: "By-pass is turned off  & check if the motion trigger is on"
              conditions:
                - condition: trigger
                  id:
                    - 't8_on'
                    - 't8_off'
                    - 't8_stop'
                - condition: state
                  entity_id: !input motion_trigger
                  match: any
                  state: 'on'
              sequence:
                - choose:
                  - alias: "Check all by-pass are off and check conditions if enabled "
                    conditions:
                      - condition: or
                        conditions:
                          - condition: and
                            conditions:
                              - "{{ ('bypass_enabled_turn_on' in include_bypass) and ('bypass_enabled_turn_off' in include_bypass) and ('bypass_enabled_stop' in include_bypass) }}"
                              - condition: state
                                entity_id: !input motion_bypass_lights_on
                                state: 'off'
                              - condition: state
                                entity_id: !input motion_bypass_lights_off
                                state: 'off'
                              - condition: state
                                entity_id: !input motion_bypass_lights_stop
                                state: 'off'
                          - condition: and
                            conditions:
                              - "{{ ('bypass_enabled_turn_on' in include_bypass) and ('bypass_enabled_turn_off' in include_bypass) and ('bypass_enabled_stop' not in include_bypass) }}"
                              - condition: state
                                entity_id: !input motion_bypass_lights_on
                                state: 'off'
                              - condition: state
                                entity_id: !input motion_bypass_lights_off
                                state: 'off'
                          - condition: and
                            conditions:
                              - "{{ ('bypass_enabled_turn_on' in include_bypass) and ('bypass_enabled_turn_off' not in include_bypass) and ('bypass_enabled_stop' in include_bypass) }}"
                              - condition: state
                                entity_id: !input motion_bypass_lights_on
                                state: 'off'
                              - condition: state
                                entity_id: !input motion_bypass_lights_stop
                                state: 'off'
                          - condition: and
                            conditions:
                              - "{{ ('bypass_enabled_turn_on' not in include_bypass) and ('bypass_enabled_turn_off' in include_bypass) and ('bypass_enabled_stop' in include_bypass) }}"
                              - condition: state
                                entity_id: !input motion_bypass_lights_off
                                state: 'off'
                              - condition: state
                                entity_id: !input motion_bypass_lights_stop
                                state: 'off'
                          - condition: and
                            conditions:
                              - "{{ ('bypass_enabled_turn_on' in include_bypass) and ('bypass_enabled_turn_off' not in include_bypass) and ('bypass_enabled_stop' not in include_bypass) }}"
                              - condition: state
                                entity_id: !input motion_bypass_lights_on
                                state: 'off'
                          - condition: and
                            conditions:
                              - "{{ ('bypass_enabled_turn_on' not in include_bypass) and ('bypass_enabled_turn_off' in include_bypass) and ('bypass_enabled_stop' not in include_bypass) }}"
                              - condition: state
                                entity_id: !input motion_bypass_lights_off
                                state: 'off'
                          - condition: and
                            conditions:
                              - "{{ ('bypass_enabled_turn_on' not in include_bypass) and ('bypass_enabled_turn_off' not in include_bypass) and ('bypass_enabled_stop' in include_bypass) }}"
                              - condition: state
                                entity_id: !input motion_bypass_lights_stop
                                state: 'off'
                      - condition: or
                        conditions:
                        - "{{ (include_sun == 'sun_enabled') and (state_attr('sun.sun','elevation') >= sun_elevation | float(90)) }}"
                        - "{{ (include_ambient == 'ambient_enabled') and (ambient_light_options == 'ambient_light_option_disabled') and (states[ambient_light_sensor].state | int > ambient_light_value | int) }}"
                        - "{{ (include_ambient == 'ambient_enabled') and (ambient_light_options == 'ambient_light_option_enabled') and (states[ambient_light_sensor].state | int > ambient_light_value | int) and (expand(night_lights.entity_id) | selectattr('state', '==', 'off') | list | count > 0) }}"
                        - "{{ (include_ambient == 'ambient_enabled') and (ambient_light_options == 'ambient_light_option_enabled') and (states[ambient_light_sensor].state | int > ambient_light_value | int) and (is_state(night_boolean_scenes_scripts, 'off')) }}"
                        - condition: and
                          conditions:
                          - condition: time
                            after: !input before_time
                            before: !input after_time
                          -  "{{ include_time == 'time_enabled' }}"
                    sequence:
                      - alias: "Wait the number of minutes set in the by-pass time delay"
                        delay:
                          minutes: !input bypass_time_delay
                      - choose:
                        - alias: "If transition is selected"
                          conditions:
                            - condition: template
                              value_template: "{{ 'use_transition' in include_night_light_control }}"
                          sequence:
                            - alias: "Turn off the lights"
                              service: light.turn_off
                              target:
                                entity_id: "{{ night_light_entities }}"
                              data:
                                transition: "{{ night_transition_off_value }}"
                            - alias: "Turn off the scenes"
                              service: scene.turn_on
                              data:
                                entity_id: "{{ end_scene_entities }}"
                                transition: "{{ night_transition_off_value }}"
                        - alias: "If transition is not selected"
                          conditions:
                            - condition: template
                              value_template: "{{ 'use_transition' not in include_night_light_control }}"
                          sequence:
                            - alias: "Turn off the lights"
                              service: light.turn_off
                              target:
                                entity_id: "{{ night_light_entities }}"
                            - alias: "Turn off the scenes"
                              service: scene.turn_on
                              data:
                                entity_id: "{{ end_scene_entities }}"
                      - alias: "Turn off the switches"
                        service: switch.turn_off
                        target:
                          entity_id: "{{ night_switch_entities }}"
                      - alias: "Turn off the script"
                        service: script.turn_on
                        data:
                          entity_id: "{{ end_script_entities }}"
                      - stop: "Stop the automation"
                  - alias: "Motion trigger is on and check if any by-passes are on"
                    conditions:
                      - condition: or
                        conditions:
                          - condition: and
                            conditions:
                              - "{{ ('bypass_enabled_turn_on' in include_bypass) and ('bypass_enabled_turn_off' in include_bypass) and ('bypass_enabled_stop' in include_bypass) }}"
                              - condition: or
                                conditions:
                                  - condition: state
                                    entity_id: !input motion_bypass_lights_on
                                    match: any
                                    state: 'on'
                                  - condition: state
                                    entity_id: !input motion_bypass_lights_off
                                    match: any
                                    state: 'on'
                                  - condition: state
                                    entity_id: !input motion_bypass_lights_stop
                                    match: any
                                    state: 'on'
                          - condition: and
                            conditions:
                              - "{{ ('bypass_enabled_turn_on' in include_bypass) and ('bypass_enabled_turn_off' in include_bypass) and ('bypass_enabled_stop' not in include_bypass) }}"
                              - condition: or
                                conditions:
                                  - condition: state
                                    entity_id: !input motion_bypass_lights_on
                                    match: any
                                    state: 'on'
                                  - condition: state
                                    entity_id: !input motion_bypass_lights_off
                                    match: any
                                    state: 'on'
                          - condition: and
                            conditions:
                              - "{{ ('bypass_enabled_turn_on' in include_bypass) and ('bypass_enabled_turn_off' not in include_bypass) and ('bypass_enabled_stop' in include_bypass) }}"
                              - condition: or
                                conditions:
                                  - condition: state
                                    entity_id: !input motion_bypass_lights_on
                                    match: any
                                    state: 'on'
                                  - condition: state
                                    entity_id: !input motion_bypass_lights_stop
                                    match: any
                                    state: 'on'
                          - condition: and
                            conditions:
                              - "{{ ('bypass_enabled_turn_on' not in include_bypass) and ('bypass_enabled_turn_off' in include_bypass) and ('bypass_enabled_stop' in include_bypass) }}"
                              - condition: or
                                conditions:
                                  - condition: state
                                    entity_id: !input motion_bypass_lights_off
                                    match: any
                                    state: 'on'
                                  - condition: state
                                    entity_id: !input motion_bypass_lights_stop
                                    match: any
                                    state: 'on'
                          - condition: and
                            conditions:
                              - "{{ ('bypass_enabled_turn_on' in include_bypass) and ('bypass_enabled_turn_off' not in include_bypass) and ('bypass_enabled_stop' not in include_bypass) }}"
                              - condition: state
                                entity_id: !input motion_bypass_lights_on
                                match: any
                                state: 'on'
                          - condition: and
                            conditions:
                              - "{{ ('bypass_enabled_turn_on' not in include_bypass) and ('bypass_enabled_turn_off' in include_bypass) and ('bypass_enabled_stop' not in include_bypass) }}"
                              - condition: state
                                entity_id: !input motion_bypass_lights_off
                                match: any
                                state: 'on'
                          - condition: and
                            conditions:
                              - "{{ ('bypass_enabled_turn_on' not in include_bypass) and ('bypass_enabled_turn_off' not in include_bypass) and ('bypass_enabled_stop' in include_bypass) }}"
                              - condition: state
                                entity_id: !input motion_bypass_lights_stop
                                match: any
                                state: 'on'
                    sequence:
                      - alias: "Check by-pass settings and preform the correct action"
                        if:
                          - alias: "Check if the by-pass auto off is enabled"
                            condition: template
                            value_template: "{{ ('bypass_auto_off_enabled_on' in include_bypass_auto_off) or ('bypass_auto_off_enabled_off' in include_bypass_auto_off) or ('bypass_auto_off_enabled_stop' in include_bypass_auto_off) }}"
                        then:
                          - alias: "Wait the number of minutes set in the by-pass auto off time delay"
                            delay: 
                              minutes: !input bypass_auto_off_delay
                          - alias: Parallel Actions for the by-pass auto off
                            parallel:
                              - sequence:
                                  - choose:
                                      - conditions:
                                          - condition: template
                                            value_template: "{{ ('bypass_enabled_turn_on' in include_bypass) and ('bypass_auto_off_enabled_on' in include_bypass_auto_off) }}"
                                        sequence:
                                          - alias: "Turn off the by-pass"
                                            service: homeassistant.turn_off
                                            entity_id: !input motion_bypass_lights_on
                              - sequence:
                                  - choose:
                                      - conditions:
                                          - condition: template
                                            value_template: "{{ ('bypass_enabled_turn_off' in include_bypass) and ('bypass_auto_off_enabled_off' in include_bypass_auto_off) }}"
                                        sequence:
                                          - alias: "Turn off the by-pass"
                                            service: homeassistant.turn_off
                                            entity_id: !input motion_bypass_lights_off
                              - sequence:
                                  - choose:
                                      - conditions:
                                          - condition: template
                                            value_template: "{{ ('bypass_enabled_stop' in include_bypass) and ('bypass_auto_off_enabled_stop' in include_bypass_auto_off) }}"
                                        sequence:
                                          - alias: "Turn off the by-pass"
                                            service: homeassistant.turn_off
                                            entity_id: !input motion_bypass_lights_stop
                      - stop: "Stop the automation"
          - choose:
            - alias: "Sun, Ambient Light Sensor & time above setting to turn off"
              conditions:
                - condition: trigger
                  id:
                    - 't9'
                    - 't10'
                    - 't11'
              sequence:
                - choose:
                  - alias: "If transition is selected"
                    conditions:
                      - condition: template
                        value_template: "{{ 'use_transition' in include_night_light_control }}"
                    sequence:
                      - alias: "Turn off the lights"
                        service: light.turn_off
                        target:
                          entity_id: "{{ night_light_entities }}"
                        data:
                          transition: "{{ night_transition_off_value }}"
                      - alias: "Turn off the scenes"
                        service: scene.turn_on
                        data:
                          entity_id: "{{ end_scene_entities }}"
                          transition: "{{ night_transition_off_value }}"
                  - alias: "If transition is not selected"
                    conditions:
                      - condition: template
                        value_template: "{{ 'use_transition' not in include_night_light_control }}"
                    sequence:
                      - alias: "Turn off the lights"
                        service: light.turn_off
                        target:
                          entity_id: "{{ night_light_entities }}"
                      - alias: "Turn off the scenes"
                        service: scene.turn_on
                        data:
                          entity_id: "{{ end_scene_entities }}"
                - alias: "Turn off the switches"
                  service: switch.turn_off
                  target:
                    entity_id: "{{ night_switch_entities }}"
                - alias: "Turn off the script"
                  service: script.turn_on
                  data:
                    entity_id: "{{ end_script_entities }}"
                - alias: "Turn off the input boolean night lights"
                  service: input_boolean.turn_off
                  data:
                    entity_id: !input night_boolean_scenes_scripts
                - stop: "Stop the automation"
            - alias: "Turn off normal lights when trigger by start night lights conditions"
              conditions:
                - condition: trigger
                  id:
                    - 't4'
                    - 't5'
                    - 't6'
              sequence:
                - choose:
                  - alias: "light - switch - scene - script is ON"
                    conditions:
                      - "{{ (expand(light_switch.entity_id) | selectattr('state', '==', 'on') | list | count > 0) or (expand(night_lights.entity_id) | selectattr('state', '==', 'on') | list | count > 0) or (is_state(boolean_scenes_scripts, 'on')) }}"
                    sequence:
                      - choose:
                        - alias: "If transition is selected"
                          conditions:
                            - condition: template
                              value_template: "{{ 'use_transition' in include_light_control }}"
                          sequence:
                            - alias: "Turn off the lights"
                              service: light.turn_off
                              target:
                                entity_id: "{{ crossover_lights_light }}"
                              data:
                                transition: "{{ transition_off_value }}"
                            - alias: "Turn off the scenes"
                              service: scene.turn_on
                              data:
                                entity_id: "{{ end_scene_entities }}"
                                transition: "{{ transition_off_value }}"
                        - alias: "If transition is not selected"
                          conditions:
                            - condition: template
                              value_template: "{{ 'use_transition' not in include_light_control }}"
                          sequence:
                            - alias: "Turn off the lights"
                              service: light.turn_off
                              target:
                                entity_id: "{{ crossover_lights_light }}"
                            - alias: "Turn off the scenes"
                              service: scene.turn_on
                              data:
                                entity_id: "{{ end_scene_entities }}"
                      - alias: "Turn off the switches"
                        service: switch.turn_off
                        target:
                          entity_id: "{{ crossover_lights_switch }}"
                      - alias: "Turn off the script"
                        service: script.turn_on
                        data:
                          entity_id: "{{ end_script_entities }}"
                      - alias: "Turn off the input boolean normal lights"
                        service: input_boolean.turn_off
                        data:
                          entity_id: !input boolean_scenes_scripts
                      - choose:
                        - alias: "If adjust light settings when crossing over if lights are ON is selected in night light control"
                          conditions:
                            - condition: template
                              value_template: "{{ 'if_lights_are_on_adjust_when_crossing_over' in include_night_light_control }}"
                          sequence:
                            - choose:
                              - alias: "Set the transition and brightness for the night lights switch"
                                conditions:
                                  - condition: template
                                    value_template: "{{ ('use_transition' in include_night_light_control) and ('use_brightness' in include_night_light_control) and ('use_colour_temperature' not in include_night_light_control) }}"
                                sequence:
                                  - service: light.turn_on
                                    target:
                                      entity_id: "{{ crossover_night_lights_light_on }}"
                                    data:
                                      transition: "{{ night_transition_on_value }}"
                                      brightness_pct: "{{ night_brightness_value }}"
                              - alias: "Set the transition and colour temperature for the night lights switch"
                                conditions:
                                  - condition: template
                                    value_template: "{{ ('use_transition' in include_night_light_control) and ('use_brightness' not in include_night_light_control) and ('use_colour_temperature' in include_night_light_control) }}"
                                sequence:
                                  - service: light.turn_on
                                    target:
                                      entity_id: "{{ crossover_night_lights_light_on }}"
                                    data:
                                      transition: "{{ night_transition_on_value }}"
                                      kelvin: "{{ night_temperature_value }}"
                              - alias: "Set the transition, brightness and colour temperature for the night lights switch"
                                conditions:
                                  - condition: template
                                    value_template: "{{ ('use_transition' in include_night_light_control) and ('use_brightness' in include_night_light_control) and ('use_colour_temperature' in include_night_light_control) }}"
                                sequence:
                                  - service: light.turn_on
                                    target:
                                      entity_id: "{{ crossover_night_lights_light_on }}"
                                    data:
                                      transition: "{{ night_transition_on_value }}"
                                      brightness_pct: "{{ night_brightness_value }}"
                                      kelvin: "{{ night_temperature_value }}"
                              - alias: "Set the brightness for the night lights switch"
                                conditions:
                                  - condition: template
                                    value_template: "{{ ('use_transition' not in include_night_light_control) and ('use_brightness' in include_night_light_control) and ('use_colour_temperature' not in include_night_light_control) }}"
                                sequence:
                                  - service: light.turn_on
                                    target:
                                      entity_id: "{{ crossover_night_lights_light_on }}"
                                    data:
                                      brightness_pct: "{{ night_brightness_value }}"
                              - alias: "Set the colour temperature for the night lights switch"
                                conditions:
                                  - condition: template
                                    value_template: "{{ ('use_transition' not in include_night_light_control) and ('use_brightness' not in include_night_light_control) and ('use_colour_temperature' in include_night_light_control) }}"
                                sequence:
                                  - service: light.turn_on
                                    target:
                                      entity_id: "{{ crossover_night_lights_light_on }}"
                                    data:
                                      kelvin: "{{ night_temperature_value }}"
                              - alias: "Set the brightness and colour temperature for the night lights switch"
                                conditions:
                                  - condition: template
                                    value_template: "{{ ('use_transition' not in include_night_light_control) and ('use_brightness' in include_night_light_control) and ('use_colour_temperature' in include_night_light_control) }}"
                                sequence:
                                  - service: light.turn_on
                                    target:
                                      entity_id: "{{ crossover_night_lights_light_on }}"
                                    data:
                                      brightness_pct: "{{ night_brightness_value }}"
                                      kelvin: "{{ night_temperature_value }}"
                  - alias: "light - switch - scene - script is ON"
                    conditions:
                      - "{{ 'manage_scripts_crossing_over' in include_night_light_control }}"
                      - "{{ (expand(light_switch.entity_id) | selectattr('state', '==', 'off') | list | count > 0) or (expand(night_lights.entity_id) | selectattr('state', '==', 'off') | list | count > 0) or (is_state(boolean_scenes_scripts, 'off')) }}"
                    sequence:
                      - alias: "Turn off the script"
                        service: script.turn_on
                        data:
                          entity_id: "{{ end_script_entities }}"
                      - stop: "Stop the automation"
            - alias: "Safe Guard when HA restarts"
              conditions:
                - condition: trigger
                  id: 't15'
              sequence:
                - choose:
                  - alias: "Check all by-pass are off and check conditions if enabled "
                    conditions:
                      - condition: or
                        conditions:
                          - condition: and
                            conditions:
                              - "{{ ('bypass_enabled_turn_on' in include_bypass) and ('bypass_enabled_turn_off' in include_bypass) and ('bypass_enabled_stop' in include_bypass) }}"
                              - condition: state
                                entity_id: !input motion_bypass_lights_on
                                state: 'off'
                              - condition: state
                                entity_id: !input motion_bypass_lights_off
                                state: 'off'
                              - condition: state
                                entity_id: !input motion_bypass_lights_stop
                                state: 'off'
                          - condition: and
                            conditions:
                              - "{{ ('bypass_enabled_turn_on' in include_bypass) and ('bypass_enabled_turn_off' in include_bypass) and ('bypass_enabled_stop' not in include_bypass) }}"
                              - condition: state
                                entity_id: !input motion_bypass_lights_on
                                state: 'off'
                              - condition: state
                                entity_id: !input motion_bypass_lights_off
                                state: 'off'
                          - condition: and
                            conditions:
                              - "{{ ('bypass_enabled_turn_on' in include_bypass) and ('bypass_enabled_turn_off' not in include_bypass) and ('bypass_enabled_stop' in include_bypass) }}"
                              - condition: state
                                entity_id: !input motion_bypass_lights_on
                                state: 'off'
                              - condition: state
                                entity_id: !input motion_bypass_lights_stop
                                state: 'off'
                          - condition: and
                            conditions:
                              - "{{ ('bypass_enabled_turn_on' not in include_bypass) and ('bypass_enabled_turn_off' in include_bypass) and ('bypass_enabled_stop' in include_bypass) }}"
                              - condition: state
                                entity_id: !input motion_bypass_lights_off
                                state: 'off'
                              - condition: state
                                entity_id: !input motion_bypass_lights_stop
                                state: 'off'
                          - condition: and
                            conditions:
                              - "{{ ('bypass_enabled_turn_on' in include_bypass) and ('bypass_enabled_turn_off' not in include_bypass) and ('bypass_enabled_stop' not in include_bypass) }}"
                              - condition: state
                                entity_id: !input motion_bypass_lights_on
                                state: 'off'
                          - condition: and
                            conditions:
                              - "{{ ('bypass_enabled_turn_on' not in include_bypass) and ('bypass_enabled_turn_off' in include_bypass) and ('bypass_enabled_stop' not in include_bypass) }}"
                              - condition: state
                                entity_id: !input motion_bypass_lights_off
                                state: 'off'
                          - condition: and
                            conditions:
                              - "{{ ('bypass_enabled_turn_on' not in include_bypass) and ('bypass_enabled_turn_off' not in include_bypass) and ('bypass_enabled_stop' in include_bypass) }}"
                              - condition: state
                                entity_id: !input motion_bypass_lights_stop
                                state: 'off'
                    sequence:
                      - alias: "Small time delay required"
                        delay:
                          seconds: 1
                  - alias: "Check if any by-passes are on"
                    conditions:
                      - condition: or
                        conditions:
                          - condition: and
                            conditions:
                              - "{{ ('bypass_enabled_turn_on' in include_bypass) and ('bypass_enabled_turn_off' in include_bypass) and ('bypass_enabled_stop' in include_bypass) }}"
                              - condition: or
                                conditions:
                                  - condition: state
                                    entity_id: !input motion_bypass_lights_on
                                    match: any
                                    state: 'on'
                                  - condition: state
                                    entity_id: !input motion_bypass_lights_off
                                    match: any
                                    state: 'on'
                                  - condition: state
                                    entity_id: !input motion_bypass_lights_stop
                                    match: any
                                    state: 'on'
                          - condition: and
                            conditions:
                              - "{{ ('bypass_enabled_turn_on' in include_bypass) and ('bypass_enabled_turn_off' in include_bypass) and ('bypass_enabled_stop' not in include_bypass) }}"
                              - condition: or
                                conditions:
                                  - condition: state
                                    entity_id: !input motion_bypass_lights_on
                                    match: any
                                    state: 'on'
                                  - condition: state
                                    entity_id: !input motion_bypass_lights_off
                                    match: any
                                    state: 'on'
                          - condition: and
                            conditions:
                              - "{{ ('bypass_enabled_turn_on' in include_bypass) and ('bypass_enabled_turn_off' not in include_bypass) and ('bypass_enabled_stop' in include_bypass) }}"
                              - condition: or
                                conditions:
                                  - condition: state
                                    entity_id: !input motion_bypass_lights_on
                                    match: any
                                    state: 'on'
                                  - condition: state
                                    entity_id: !input motion_bypass_lights_stop
                                    match: any
                                    state: 'on'
                          - condition: and
                            conditions:
                              - "{{ ('bypass_enabled_turn_on' not in include_bypass) and ('bypass_enabled_turn_off' in include_bypass) and ('bypass_enabled_stop' in include_bypass) }}"
                              - condition: or
                                conditions:
                                  - condition: state
                                    entity_id: !input motion_bypass_lights_off
                                    match: any
                                    state: 'on'
                                  - condition: state
                                    entity_id: !input motion_bypass_lights_stop
                                    match: any
                                    state: 'on'
                          - condition: and
                            conditions:
                              - "{{ ('bypass_enabled_turn_on' in include_bypass) and ('bypass_enabled_turn_off' not in include_bypass) and ('bypass_enabled_stop' not in include_bypass) }}"
                              - condition: state
                                entity_id: !input motion_bypass_lights_on
                                match: any
                                state: 'on'
                          - condition: and
                            conditions:
                              - "{{ ('bypass_enabled_turn_on' not in include_bypass) and ('bypass_enabled_turn_off' in include_bypass) and ('bypass_enabled_stop' not in include_bypass) }}"
                              - condition: state
                                entity_id: !input motion_bypass_lights_off
                                match: any
                                state: 'on'
                          - condition: and
                            conditions:
                              - "{{ ('bypass_enabled_turn_on' not in include_bypass) and ('bypass_enabled_turn_off' not in include_bypass) and ('bypass_enabled_stop' in include_bypass) }}"
                              - condition: state
                                entity_id: !input motion_bypass_lights_stop
                                match: any
                                state: 'on'
                    sequence:
                      - alias: "Check by-pass auto off is enabled and preform the correct"
                        if:
                          - alias: "Check if the by-pass auto off is enabled"
                            condition: template
                            value_template: "{{ ('bypass_auto_off_enabled_on' in include_bypass_auto_off) or ('bypass_auto_off_enabled_off' in include_bypass_auto_off) or ('bypass_auto_off_enabled_stop' in include_bypass_auto_off) }}"
                        then:
                          - alias: "Wait the number of minutes set in the by-pass auto off time delay"
                            delay: 
                              minutes: !input bypass_auto_off_delay
                          - alias: Parallel Actions for the by-pass auto off
                            parallel:
                              - sequence:
                                  - choose:
                                      - conditions:
                                          - condition: template
                                            value_template: "{{ ('bypass_enabled_turn_on' in include_bypass) and ('bypass_auto_off_enabled_on' in include_bypass_auto_off) }}"
                                        sequence:
                                          - alias: "Turn off the by-pass"
                                            service: homeassistant.turn_off
                                            entity_id: !input motion_bypass_lights_on
                              - sequence:
                                  - choose:
                                      - conditions:
                                          - condition: template
                                            value_template: "{{ ('bypass_enabled_turn_off' in include_bypass) and ('bypass_auto_off_enabled_off' in include_bypass_auto_off) }}"
                                        sequence:
                                          - alias: "Turn off the by-pass"
                                            service: homeassistant.turn_off
                                            entity_id: !input motion_bypass_lights_off
                              - sequence:
                                  - choose:
                                      - conditions:
                                          - condition: template
                                            value_template: "{{ ('bypass_enabled_stop' in include_bypass) and ('bypass_auto_off_enabled_stop' in include_bypass_auto_off) }}"
                                        sequence:
                                          - alias: "Turn off the by-pass"
                                            service: homeassistant.turn_off
                                            entity_id: !input motion_bypass_lights_stop
                      - stop: "Stop the automation"
          - choose:
            - alias: "Set the transition for the night lights switch"
              conditions:
                - condition: template
                  value_template: "{{ ('use_transition' in include_night_light_control) and ('use_brightness' not in include_night_light_control) and ('use_colour_temperature' not in include_night_light_control) }}"
              sequence:
                - service: light.turn_on
                  target:
                    entity_id: "{{ night_light_entities_off }}"
                  data:
                    transition: "{{ night_transition_on_value }}"
            - alias: "Set the transition and brightness for the night lights switch"
              conditions:
                - condition: template
                  value_template: "{{ ('use_transition' in include_night_light_control) and ('use_brightness' in include_night_light_control) and ('use_colour_temperature' not in include_night_light_control) }}"
              sequence:
                - service: light.turn_on
                  target:
                    entity_id: "{{ night_light_entities_off }}"
                  data:
                    transition: "{{ night_transition_on_value }}"
                    brightness_pct: "{{ night_brightness_value }}"
            - alias: "Set the transition and colour temperature for the night lights switch"
              conditions:
                - condition: template
                  value_template: "{{ ('use_transition' in include_night_light_control) and ('use_brightness' not in include_night_light_control) and ('use_colour_temperature' in include_night_light_control) }}"
              sequence:
                - service: light.turn_on
                  target:
                    entity_id: "{{ night_light_entities_off }}"
                  data:
                    transition: "{{ night_transition_on_value }}"
                    kelvin: "{{ night_temperature_value }}"
            - alias: "Set the transition, brightness and colour temperature for the night lights switch"
              conditions:
                - condition: template
                  value_template: "{{ ('use_transition' in include_night_light_control) and ('use_brightness' in include_night_light_control) and ('use_colour_temperature' in include_night_light_control) }}"
              sequence:
                - service: light.turn_on
                  target:
                    entity_id: "{{ night_light_entities_off }}"
                  data:
                    transition: "{{ night_transition_on_value }}"
                    brightness_pct: "{{ night_brightness_value }}"
                    kelvin: "{{ night_temperature_value }}"
            - alias: "Set the brightness for the night lights switch"
              conditions:
                - condition: template
                  value_template: "{{ ('use_transition' not in include_night_light_control) and ('use_brightness' in include_night_light_control) and ('use_colour_temperature' not in include_night_light_control) }}"
              sequence:
                - service: light.turn_on
                  target:
                    entity_id: "{{ night_light_entities_off }}"
                  data:
                    brightness_pct: "{{ night_brightness_value }}"
            - alias: "Set the colour temperature for the night lights switch"
              conditions:
                - condition: template
                  value_template: "{{ ('use_transition' not in include_night_light_control) and ('use_brightness' not in include_night_light_control) and ('use_colour_temperature' in include_night_light_control) }}"
              sequence:
                - service: light.turn_on
                  target:
                    entity_id: "{{ night_light_entities_off }}"
                  data:
                    kelvin: "{{ night_temperature_value }}"
            - alias: "Set the brightness and colour temperature for the night lights switch"
              conditions:
                - condition: template
                  value_template: "{{ ('use_transition' not in include_night_light_control) and ('use_brightness' in include_night_light_control) and ('use_colour_temperature' in include_night_light_control) }}"
              sequence:
                - service: light.turn_on
                  target:
                    entity_id: "{{ night_light_entities_off }}"
                  data:
                    brightness_pct: "{{ night_brightness_value }}"
                    kelvin: "{{ night_temperature_value }}"
            - alias: "Set the default for the night lights switch"
              conditions:
                - condition: template
                  value_template: "{{ ('use_transition' not in include_night_light_control) and ('use_brightness' not in include_night_light_control) and ('use_colour_temperature' not in include_night_light_control) }}"
              sequence:
                - service: light.turn_on
                  target:
                    entity_id: "{{ night_light_entities_off }}"
          - choose:
            - alias: "If transition is selected"
              conditions:
                - condition: template
                  value_template: "{{ 'use_transition' in include_night_light_control }}"
              sequence:
                - alias: "Turn on the night scenes"
                  service: scene.turn_on
                  target:
                    entity_id: "{{ night_scene_entities }}"
                  data:
                    transition: "{{ night_transition_on_value }}"
            - alias: "If transition is not selected"
              conditions:
                - condition: template
                  value_template: "{{ 'use_transition' not in include_night_light_control }}"
              sequence:
                - alias: "Turn on the night scenes"
                  service: scene.turn_on
                  target:
                    entity_id: "{{ night_scene_entities }}"
          - alias: "Turn on the night switches"
            service: switch.turn_on
            target:
              entity_id: "{{ night_switch_entities_off }}"
          - alias: "Turn on the night scripts"
            service: script.turn_on
            target:
              entity_id: "{{ night_script_entities }}"
          - alias: "Turn on the boolean for scenes and scripts"
            service: input_boolean.turn_on
            data:
              entity_id: "{{ night_boolean_scenes_scripts_helper }}"
          - choose:
            - alias: "By-pass is enabled & check by-pass option - turn lights on"
              conditions:
                - condition: trigger
                  id: 't7_on'
              sequence:
                - alias: "Check by-pass settings and preform the correct action"
                  if:
                    - alias: "Check if the by-pass auto off is enabled"
                      condition: template
                      value_template: "{{ ('bypass_auto_off_enabled_on' in include_bypass_auto_off) or ('bypass_auto_off_enabled_off' in include_bypass_auto_off) or ('bypass_auto_off_enabled_stop' in include_bypass_auto_off) }}"
                  then:
                    - alias: "Wait the number of minutes set in the by-pass auto off time delay"
                      delay: 
                        minutes: !input bypass_auto_off_delay
                    - alias: Parallel Actions for the by-pass auto off
                      parallel:
                        - sequence:
                            - choose:
                                - conditions:
                                    - condition: template
                                      value_template: "{{ ('bypass_enabled_turn_on' in include_bypass) and ('bypass_auto_off_enabled_on' in include_bypass_auto_off) }}"
                                  sequence:
                                    - alias: "Turn off the by-pass"
                                      service: homeassistant.turn_off
                                      entity_id: !input motion_bypass_lights_on
                        - sequence:
                            - choose:
                                - conditions:
                                    - condition: template
                                      value_template: "{{ ('bypass_enabled_turn_off' in include_bypass) and ('bypass_auto_off_enabled_off' in include_bypass_auto_off) }}"
                                  sequence:
                                    - alias: "Turn off the by-pass"
                                      service: homeassistant.turn_off
                                      entity_id: !input motion_bypass_lights_off
                        - sequence:
                            - choose:
                                - conditions:
                                    - condition: template
                                      value_template: "{{ ('bypass_enabled_stop' in include_bypass) and ('bypass_auto_off_enabled_stop' in include_bypass_auto_off) }}"
                                  sequence:
                                    - alias: "Turn off the by-pass"
                                      service: homeassistant.turn_off
                                      entity_id: !input motion_bypass_lights_stop
                    - stop: "Stop the automation"
                  else:
                    - stop: "Stop the automation"
          - choose:
              - alias: "Check if the trigger is on and wait for it to go off"
                conditions:
                  - condition: state
                    entity_id: !input motion_trigger
                    state: 'on'
                    match: any
                sequence:
                  - alias: "Wait until motion sensor is off"
                    wait_for_trigger:
                      platform: state
                      entity_id: !input motion_trigger
                      from: "on"
                      to: "off"
          - alias: "Wait the number of minutes set in the night lights time delay"
            delay:
              minutes: !input night_time_delay
          - choose:
            - alias: "If transition is selected"
              conditions:
                - condition: template
                  value_template: "{{ 'use_transition' in include_night_light_control }}"
              sequence:
                - alias: "Turn off the lights"
                  service: light.turn_off
                  target:
                    entity_id: "{{ night_light_entities }}"
                  data:
                    transition: "{{ night_transition_off_value }}"
                - alias: "Turn off the scenes"
                  service: scene.turn_on
                  data:
                    entity_id: "{{ end_scene_entities }}"
                    transition: "{{ night_transition_off_value }}"
            - alias: "If transition is not selected"
              conditions:
                - condition: template
                  value_template: "{{ 'use_transition' not in include_night_light_control }}"
              sequence:
                - alias: "Turn off the lights"
                  service: light.turn_off
                  target:
                    entity_id: "{{ night_light_entities }}"
                - alias: "Turn off the scenes"
                  service: scene.turn_on
                  data:
                    entity_id: "{{ end_scene_entities }}"
          - alias: "Turn off the switches"
            service: switch.turn_off
            target:
              entity_id: "{{ night_switch_entities }}"
          - alias: "Turn off the script"
            service: script.turn_on
            data:
              entity_id: "{{ end_script_entities }}"
          - alias: "Turn off the boolean for scenes and scripts"
            service: input_boolean.turn_off
            data:
              entity_id: !input night_boolean_scenes_scripts
    default:
      - choose:
        - alias: "By-pass is turned on  & check by-pass option - turn lights off"
          conditions:
            - condition: trigger
              id: 't7_off'
          sequence:
            - alias: "Wait the number of minutes set in the by-pass time delay"
              delay:
                minutes: !input bypass_time_delay
            - choose:
              - alias: "If transition is selected"
                conditions:
                  - condition: template
                    value_template: "{{ 'use_transition' in include_light_control }}"
                sequence:
                  - alias: "Turn off the lights"
                    service: light.turn_off
                    target:
                      entity_id: "{{ light_entities }}"
                    data:
                      transition: "{{ transition_off_value }}"
                  - alias: "Turn off the scenes"
                    service: scene.turn_on
                    data:
                      entity_id: "{{ end_scene_entities }}"
                      transition: "{{ transition_off_value }}"
              - alias: "If transition is not selected"
                conditions:
                  - condition: template
                    value_template: "{{ 'use_transition' not in include_light_control }}"
                sequence:
                  - alias: "Turn off the lights"
                    service: light.turn_off
                    target:
                      entity_id: "{{ light_entities }}"
                  - alias: "Turn off the scenes"
                    service: scene.turn_on
                    data:
                      entity_id: "{{ end_scene_entities }}"
            - alias: "Turn off the switches"
              service: switch.turn_off
              target:
                entity_id: "{{ switch_entities }}"
            - alias: "Turn off the script"
              service: script.turn_on
              data:
                entity_id: "{{ end_script_entities }}"
            - alias: "Turn off the boolean for scenes and scripts"
              service: input_boolean.turn_off
              data:
                entity_id: !input boolean_scenes_scripts
            - alias: "Turn off the boolean for scenes and scripts"
              service: input_boolean.turn_off
              data:
                entity_id: !input night_boolean_scenes_scripts
            - alias: "Check by-pass settings and preform the correct action"
              if:
                - alias: "Check if the by-pass auto off is enabled"
                  condition: template
                  value_template: "{{ ('bypass_auto_off_enabled_on' in include_bypass_auto_off) or ('bypass_auto_off_enabled_off' in include_bypass_auto_off) or ('bypass_auto_off_enabled_stop' in include_bypass_auto_off) }}"
              then:
                - alias: "Wait the number of minutes set in the by-pass auto off time delay"
                  delay: 
                    minutes: !input bypass_auto_off_delay
                - alias: Parallel Actions for the by-pass auto off
                  parallel:
                    - sequence:
                        - choose:
                            - conditions:
                                - condition: template
                                  value_template: "{{ ('bypass_enabled_turn_on' in include_bypass) and ('bypass_auto_off_enabled_on' in include_bypass_auto_off) }}"
                              sequence:
                                - alias: "Turn off the by-pass"
                                  service: homeassistant.turn_off
                                  entity_id: !input motion_bypass_lights_on
                    - sequence:
                        - choose:
                            - conditions:
                                - condition: template
                                  value_template: "{{ ('bypass_enabled_turn_off' in include_bypass) and ('bypass_auto_off_enabled_off' in include_bypass_auto_off) }}"
                              sequence:
                                - alias: "Turn off the by-pass"
                                  service: homeassistant.turn_off
                                  entity_id: !input motion_bypass_lights_off
                    - sequence:
                        - choose:
                            - conditions:
                                - condition: template
                                  value_template: "{{ ('bypass_enabled_stop' in include_bypass) and ('bypass_auto_off_enabled_stop' in include_bypass_auto_off) }}"
                              sequence:
                                - alias: "Turn off the by-pass"
                                  service: homeassistant.turn_off
                                  entity_id: !input motion_bypass_lights_stop
                - stop: "Stop the automation"
              else:
                - stop: "Stop the automation"
        - alias: "By-pass is turned on  & check by-pass option - Keep the current lights state"
          conditions:
            - condition: trigger
              id: 't7_stop'
          sequence:
            - alias: "Check by-pass settings and preform the correct action"
              if:
                - alias: "Check if the by-pass auto off is enabled"
                  condition: template
                  value_template: "{{ ('bypass_auto_off_enabled_on' in include_bypass_auto_off) or ('bypass_auto_off_enabled_off' in include_bypass_auto_off) or ('bypass_auto_off_enabled_stop' in include_bypass_auto_off) }}"
              then:
                - alias: "Wait the number of minutes set in the by-pass auto off time delay"
                  delay: 
                    minutes: !input bypass_auto_off_delay
                - alias: Parallel Actions for the by-pass auto off
                  parallel:
                    - sequence:
                        - choose:
                            - conditions:
                                - condition: template
                                  value_template: "{{ ('bypass_enabled_turn_on' in include_bypass) and ('bypass_auto_off_enabled_on' in include_bypass_auto_off) }}"
                              sequence:
                                - alias: "Turn off the by-pass"
                                  service: homeassistant.turn_off
                                  entity_id: !input motion_bypass_lights_on
                    - sequence:
                        - choose:
                            - conditions:
                                - condition: template
                                  value_template: "{{ ('bypass_enabled_turn_off' in include_bypass) and ('bypass_auto_off_enabled_off' in include_bypass_auto_off) }}"
                              sequence:
                                - alias: "Turn off the by-pass"
                                  service: homeassistant.turn_off
                                  entity_id: !input motion_bypass_lights_off
                    - sequence:
                        - choose:
                            - conditions:
                                - condition: template
                                  value_template: "{{ ('bypass_enabled_stop' in include_bypass) and ('bypass_auto_off_enabled_stop' in include_bypass_auto_off) }}"
                              sequence:
                                - alias: "Turn off the by-pass"
                                  service: homeassistant.turn_off
                                  entity_id: !input motion_bypass_lights_stop
                - stop: "Stop the automation"
              else:
                - stop: "Stop the automation"
      - choose:
        - alias: "By-pass is turned off  & check if the motion trigger is off"
          conditions:
            - condition: trigger
              id:
                - 't8_on'
                - 't8_off'
                - 't8_stop'
            - condition: state
              entity_id: !input motion_trigger
              match: all
              state: 'off'
          sequence:
            - choose:
              - alias: "Check all by-pass are off"
                conditions:
                  - condition: or
                    conditions:
                      - condition: and
                        conditions:
                          - "{{ ('bypass_enabled_turn_on' in include_bypass) and ('bypass_enabled_turn_off' in include_bypass) and ('bypass_enabled_stop' in include_bypass) }}"
                          - condition: state
                            entity_id: !input motion_bypass_lights_on
                            state: 'off'
                          - condition: state
                            entity_id: !input motion_bypass_lights_off
                            state: 'off'
                          - condition: state
                            entity_id: !input motion_bypass_lights_stop
                            state: 'off'
                      - condition: and
                        conditions:
                          - "{{ ('bypass_enabled_turn_on' in include_bypass) and ('bypass_enabled_turn_off' in include_bypass) and ('bypass_enabled_stop' not in include_bypass) }}"
                          - condition: state
                            entity_id: !input motion_bypass_lights_on
                            state: 'off'
                          - condition: state
                            entity_id: !input motion_bypass_lights_off
                            state: 'off'
                      - condition: and
                        conditions:
                          - "{{ ('bypass_enabled_turn_on' in include_bypass) and ('bypass_enabled_turn_off' not in include_bypass) and ('bypass_enabled_stop' in include_bypass) }}"
                          - condition: state
                            entity_id: !input motion_bypass_lights_on
                            state: 'off'
                          - condition: state
                            entity_id: !input motion_bypass_lights_stop
                            state: 'off'
                      - condition: and
                        conditions:
                          - "{{ ('bypass_enabled_turn_on' not in include_bypass) and ('bypass_enabled_turn_off' in include_bypass) and ('bypass_enabled_stop' in include_bypass) }}"
                          - condition: state
                            entity_id: !input motion_bypass_lights_off
                            state: 'off'
                          - condition: state
                            entity_id: !input motion_bypass_lights_stop
                            state: 'off'
                      - condition: and
                        conditions:
                          - "{{ ('bypass_enabled_turn_on' in include_bypass) and ('bypass_enabled_turn_off' not in include_bypass) and ('bypass_enabled_stop' not in include_bypass) }}"
                          - condition: state
                            entity_id: !input motion_bypass_lights_on
                            state: 'off'
                      - condition: and
                        conditions:
                          - "{{ ('bypass_enabled_turn_on' not in include_bypass) and ('bypass_enabled_turn_off' in include_bypass) and ('bypass_enabled_stop' not in include_bypass) }}"
                          - condition: state
                            entity_id: !input motion_bypass_lights_off
                            state: 'off'
                      - condition: and
                        conditions:
                          - "{{ ('bypass_enabled_turn_on' not in include_bypass) and ('bypass_enabled_turn_off' not in include_bypass) and ('bypass_enabled_stop' in include_bypass) }}"
                          - condition: state
                            entity_id: !input motion_bypass_lights_stop
                            state: 'off'
                sequence:
                  - alias: "Wait the number of minutes set in the by-pass time delay"
                    delay:
                      minutes: !input bypass_time_delay
                  - choose:
                    - alias: "If transition is selected"
                      conditions:
                        - condition: template
                          value_template: "{{ 'use_transition' in include_light_control }}"
                      sequence:
                        - alias: "Turn off the lights"
                          service: light.turn_off
                          target:
                            entity_id: "{{ light_entities }}"
                          data:
                            transition: "{{ transition_off_value }}"
                        - alias: "Turn off the scenes"
                          service: scene.turn_on
                          data:
                            entity_id: "{{ end_scene_entities }}"
                            transition: "{{ transition_off_value }}"
                    - alias: "If transition is not selected"
                      conditions:
                        - condition: template
                          value_template: "{{ 'use_transition' not in include_light_control }}"
                      sequence:
                        - alias: "Turn off the lights"
                          service: light.turn_off
                          target:
                            entity_id: "{{ light_entities }}"
                        - alias: "Turn off the scenes"
                          service: scene.turn_on
                          data:
                            entity_id: "{{ end_scene_entities }}"
                  - alias: "Turn off the switches"
                    service: switch.turn_off
                    target:
                      entity_id: "{{ switch_entities }}"
                  - alias: "Turn off the script"
                    service: script.turn_on
                    data:
                      entity_id: "{{ end_script_entities }}"
                  - alias: "Turn off the boolean for scenes and scripts"
                    service: input_boolean.turn_off
                    data:
                      entity_id: !input boolean_scenes_scripts
                  - alias: "Turn off the boolean for scenes and scripts"
                    service: input_boolean.turn_off
                    data:
                      entity_id: !input night_boolean_scenes_scripts
                  - stop: "Stop the automation"
              - alias: "Motion trigger is off and check if any by-passes are on"
                conditions:
                  - condition: or
                    conditions:
                      - condition: and
                        conditions:
                          - "{{ ('bypass_enabled_turn_on' in include_bypass) and ('bypass_enabled_turn_off' in include_bypass) and ('bypass_enabled_stop' in include_bypass) }}"
                          - condition: or
                            conditions:
                              - condition: state
                                entity_id: !input motion_bypass_lights_on
                                match: any
                                state: 'on'
                              - condition: state
                                entity_id: !input motion_bypass_lights_off
                                match: any
                                state: 'on'
                              - condition: state
                                entity_id: !input motion_bypass_lights_stop
                                match: any
                                state: 'on'
                      - condition: and
                        conditions:
                          - "{{ ('bypass_enabled_turn_on' in include_bypass) and ('bypass_enabled_turn_off' in include_bypass) and ('bypass_enabled_stop' not in include_bypass) }}"
                          - condition: or
                            conditions:
                              - condition: state
                                entity_id: !input motion_bypass_lights_on
                                match: any
                                state: 'on'
                              - condition: state
                                entity_id: !input motion_bypass_lights_off
                                match: any
                                state: 'on'
                      - condition: and
                        conditions:
                          - "{{ ('bypass_enabled_turn_on' in include_bypass) and ('bypass_enabled_turn_off' not in include_bypass) and ('bypass_enabled_stop' in include_bypass) }}"
                          - condition: or
                            conditions:
                              - condition: state
                                entity_id: !input motion_bypass_lights_on
                                match: any
                                state: 'on'
                              - condition: state
                                entity_id: !input motion_bypass_lights_stop
                                match: any
                                state: 'on'
                      - condition: and
                        conditions:
                          - "{{ ('bypass_enabled_turn_on' not in include_bypass) and ('bypass_enabled_turn_off' in include_bypass) and ('bypass_enabled_stop' in include_bypass) }}"
                          - condition: or
                            conditions:
                              - condition: state
                                entity_id: !input motion_bypass_lights_off
                                match: any
                                state: 'on'
                              - condition: state
                                entity_id: !input motion_bypass_lights_stop
                                match: any
                                state: 'on'
                      - condition: and
                        conditions:
                          - "{{ ('bypass_enabled_turn_on' in include_bypass) and ('bypass_enabled_turn_off' not in include_bypass) and ('bypass_enabled_stop' not in include_bypass) }}"
                          - condition: state
                            entity_id: !input motion_bypass_lights_on
                            match: any
                            state: 'on'
                      - condition: and
                        conditions:
                          - "{{ ('bypass_enabled_turn_on' not in include_bypass) and ('bypass_enabled_turn_off' in include_bypass) and ('bypass_enabled_stop' not in include_bypass) }}"
                          - condition: state
                            entity_id: !input motion_bypass_lights_off
                            match: any
                            state: 'on'
                      - condition: and
                        conditions:
                          - "{{ ('bypass_enabled_turn_on' not in include_bypass) and ('bypass_enabled_turn_off' not in include_bypass) and ('bypass_enabled_stop' in include_bypass) }}"
                          - condition: state
                            entity_id: !input motion_bypass_lights_stop
                            match: any
                            state: 'on'
                sequence:
                  - alias: "Check by-pass settings and preform the correct action"
                    if:
                      - alias: "Check if the by-pass auto off is enabled"
                        condition: template
                        value_template: "{{ ('bypass_auto_off_enabled_on' in include_bypass_auto_off) or ('bypass_auto_off_enabled_off' in include_bypass_auto_off) or ('bypass_auto_off_enabled_stop' in include_bypass_auto_off) }}"
                    then:
                      - alias: "Wait the number of minutes set in the by-pass auto off time delay"
                        delay: 
                          minutes: !input bypass_auto_off_delay
                      - alias: Parallel Actions for the by-pass auto off
                        parallel:
                          - sequence:
                              - choose:
                                  - conditions:
                                      - condition: template
                                        value_template: "{{ ('bypass_enabled_turn_on' in include_bypass) and ('bypass_auto_off_enabled_on' in include_bypass_auto_off) }}"
                                    sequence:
                                      - alias: "Turn off the by-pass"
                                        service: homeassistant.turn_off
                                        entity_id: !input motion_bypass_lights_on
                          - sequence:
                              - choose:
                                  - conditions:
                                      - condition: template
                                        value_template: "{{ ('bypass_enabled_turn_off' in include_bypass) and ('bypass_auto_off_enabled_off' in include_bypass_auto_off) }}"
                                    sequence:
                                      - alias: "Turn off the by-pass"
                                        service: homeassistant.turn_off
                                        entity_id: !input motion_bypass_lights_off
                          - sequence:
                              - choose:
                                  - conditions:
                                      - condition: template
                                        value_template: "{{ ('bypass_enabled_stop' in include_bypass) and ('bypass_auto_off_enabled_stop' in include_bypass_auto_off) }}"
                                    sequence:
                                      - alias: "Turn off the by-pass"
                                        service: homeassistant.turn_off
                                        entity_id: !input motion_bypass_lights_stop
                  - stop: "Stop the automation"
        - alias: "By-pass is turned off & check if the motion trigger is on"
          conditions:
            - condition: trigger
              id:
                - 't8_on'
                - 't8_off'
                - 't8_stop'
            - condition: state
              entity_id: !input motion_trigger
              match: any
              state: 'on'
          sequence:
            - choose:
              - alias: "Check all by-pass are off and check conditions if enabled "
                conditions:
                  - condition: or
                    conditions:
                      - condition: and
                        conditions:
                          - "{{ ('bypass_enabled_turn_on' in include_bypass) and ('bypass_enabled_turn_off' in include_bypass) and ('bypass_enabled_stop' in include_bypass) }}"
                          - condition: state
                            entity_id: !input motion_bypass_lights_on
                            state: 'off'
                          - condition: state
                            entity_id: !input motion_bypass_lights_off
                            state: 'off'
                          - condition: state
                            entity_id: !input motion_bypass_lights_stop
                            state: 'off'
                      - condition: and
                        conditions:
                          - "{{ ('bypass_enabled_turn_on' in include_bypass) and ('bypass_enabled_turn_off' in include_bypass) and ('bypass_enabled_stop' not in include_bypass) }}"
                          - condition: state
                            entity_id: !input motion_bypass_lights_on
                            state: 'off'
                          - condition: state
                            entity_id: !input motion_bypass_lights_off
                            state: 'off'
                      - condition: and
                        conditions:
                          - "{{ ('bypass_enabled_turn_on' in include_bypass) and ('bypass_enabled_turn_off' not in include_bypass) and ('bypass_enabled_stop' in include_bypass) }}"
                          - condition: state
                            entity_id: !input motion_bypass_lights_on
                            state: 'off'
                          - condition: state
                            entity_id: !input motion_bypass_lights_stop
                            state: 'off'
                      - condition: and
                        conditions:
                          - "{{ ('bypass_enabled_turn_on' not in include_bypass) and ('bypass_enabled_turn_off' in include_bypass) and ('bypass_enabled_stop' in include_bypass) }}"
                          - condition: state
                            entity_id: !input motion_bypass_lights_off
                            state: 'off'
                          - condition: state
                            entity_id: !input motion_bypass_lights_stop
                            state: 'off'
                      - condition: and
                        conditions:
                          - "{{ ('bypass_enabled_turn_on' in include_bypass) and ('bypass_enabled_turn_off' not in include_bypass) and ('bypass_enabled_stop' not in include_bypass) }}"
                          - condition: state
                            entity_id: !input motion_bypass_lights_on
                            state: 'off'
                      - condition: and
                        conditions:
                          - "{{ ('bypass_enabled_turn_on' not in include_bypass) and ('bypass_enabled_turn_off' in include_bypass) and ('bypass_enabled_stop' not in include_bypass) }}"
                          - condition: state
                            entity_id: !input motion_bypass_lights_off
                            state: 'off'
                      - condition: and
                        conditions:
                          - "{{ ('bypass_enabled_turn_on' not in include_bypass) and ('bypass_enabled_turn_off' not in include_bypass) and ('bypass_enabled_stop' in include_bypass) }}"
                          - condition: state
                            entity_id: !input motion_bypass_lights_stop
                            state: 'off'
                  - condition: or
                    conditions:
                    - "{{ (include_sun == 'sun_enabled') and (state_attr('sun.sun','elevation') >= sun_elevation | float(90)) }}"
                    - "{{ (include_ambient == 'ambient_enabled') and (ambient_light_options == 'ambient_light_option_disabled') and (states[ambient_light_sensor].state | int > ambient_light_value | int) }}"
                    - "{{ (include_ambient == 'ambient_enabled') and (ambient_light_options == 'ambient_light_option_enabled') and (states[ambient_light_sensor].state | int > ambient_light_value | int) and (expand(light_switch.entity_id) | selectattr('state', '==', 'off') | list | count > 0) }}"
                    - "{{ (include_ambient == 'ambient_enabled') and (ambient_light_options == 'ambient_light_option_enabled') and (states[ambient_light_sensor].state | int > ambient_light_value | int) and (is_state(boolean_scenes_scripts, 'off')) }}"
                    - condition: and
                      conditions:
                      - condition: time
                        after: !input before_time
                        before: !input after_time
                      -  "{{ include_time == 'time_enabled' }}"
                sequence:
                  - alias: "Wait the number of minutes set in the by-pass time delay"
                    delay:
                      minutes: !input bypass_time_delay
                  - choose:
                    - alias: "If transition is selected"
                      conditions:
                        - condition: template
                          value_template: "{{ 'use_transition' in include_light_control }}"
                      sequence:
                        - alias: "Turn off the lights"
                          service: light.turn_off
                          target:
                            entity_id: "{{ light_entities }}"
                          data:
                            transition: "{{ transition_off_value }}"
                        - alias: "Turn off the scenes"
                          service: scene.turn_on
                          data:
                            entity_id: "{{ end_scene_entities }}"
                            transition: "{{ transition_off_value }}"
                    - alias: "If transition is not selected"
                      conditions:
                        - condition: template
                          value_template: "{{ 'use_transition' not in include_light_control }}"
                      sequence:
                        - alias: "Turn off the lights"
                          service: light.turn_off
                          target:
                            entity_id: "{{ light_entities }}"
                        - alias: "Turn off the scenes"
                          service: scene.turn_on
                          data:
                            entity_id: "{{ end_scene_entities }}"
                  - alias: "Turn off the switches"
                    service: switch.turn_off
                    target:
                      entity_id: "{{ switch_entities }}"
                  - alias: "Turn off the script"
                    service: script.turn_on
                    data:
                      entity_id: "{{ end_script_entities }}"
                  - stop: "Stop the automation"
              - alias: "Motion trigger is on and check if any by-passes are on"
                conditions:
                  - condition: or
                    conditions:
                      - condition: and
                        conditions:
                          - "{{ ('bypass_enabled_turn_on' in include_bypass) and ('bypass_enabled_turn_off' in include_bypass) and ('bypass_enabled_stop' in include_bypass) }}"
                          - condition: or
                            conditions:
                              - condition: state
                                entity_id: !input motion_bypass_lights_on
                                match: any
                                state: 'on'
                              - condition: state
                                entity_id: !input motion_bypass_lights_off
                                match: any
                                state: 'on'
                              - condition: state
                                entity_id: !input motion_bypass_lights_stop
                                match: any
                                state: 'on'
                      - condition: and
                        conditions:
                          - "{{ ('bypass_enabled_turn_on' in include_bypass) and ('bypass_enabled_turn_off' in include_bypass) and ('bypass_enabled_stop' not in include_bypass) }}"
                          - condition: or
                            conditions:
                              - condition: state
                                entity_id: !input motion_bypass_lights_on
                                match: any
                                state: 'on'
                              - condition: state
                                entity_id: !input motion_bypass_lights_off
                                match: any
                                state: 'on'
                      - condition: and
                        conditions:
                          - "{{ ('bypass_enabled_turn_on' in include_bypass) and ('bypass_enabled_turn_off' not in include_bypass) and ('bypass_enabled_stop' in include_bypass) }}"
                          - condition: or
                            conditions:
                              - condition: state
                                entity_id: !input motion_bypass_lights_on
                                match: any
                                state: 'on'
                              - condition: state
                                entity_id: !input motion_bypass_lights_stop
                                match: any
                                state: 'on'
                      - condition: and
                        conditions:
                          - "{{ ('bypass_enabled_turn_on' not in include_bypass) and ('bypass_enabled_turn_off' in include_bypass) and ('bypass_enabled_stop' in include_bypass) }}"
                          - condition: or
                            conditions:
                              - condition: state
                                entity_id: !input motion_bypass_lights_off
                                match: any
                                state: 'on'
                              - condition: state
                                entity_id: !input motion_bypass_lights_stop
                                match: any
                                state: 'on'
                      - condition: and
                        conditions:
                          - "{{ ('bypass_enabled_turn_on' in include_bypass) and ('bypass_enabled_turn_off' not in include_bypass) and ('bypass_enabled_stop' not in include_bypass) }}"
                          - condition: state
                            entity_id: !input motion_bypass_lights_on
                            match: any
                            state: 'on'
                      - condition: and
                        conditions:
                          - "{{ ('bypass_enabled_turn_on' not in include_bypass) and ('bypass_enabled_turn_off' in include_bypass) and ('bypass_enabled_stop' not in include_bypass) }}"
                          - condition: state
                            entity_id: !input motion_bypass_lights_off
                            match: any
                            state: 'on'
                      - condition: and
                        conditions:
                          - "{{ ('bypass_enabled_turn_on' not in include_bypass) and ('bypass_enabled_turn_off' not in include_bypass) and ('bypass_enabled_stop' in include_bypass) }}"
                          - condition: state
                            entity_id: !input motion_bypass_lights_stop
                            match: any
                            state: 'on'
                sequence:
                  - alias: "Check by-pass settings and preform the correct action"
                    if:
                      - alias: "Check if the by-pass auto off is enabled"
                        condition: template
                        value_template: "{{ ('bypass_auto_off_enabled_on' in include_bypass_auto_off) or ('bypass_auto_off_enabled_off' in include_bypass_auto_off) or ('bypass_auto_off_enabled_stop' in include_bypass_auto_off) }}"
                    then:
                      - alias: "Wait the number of minutes set in the by-pass auto off time delay"
                        delay: 
                          minutes: !input bypass_auto_off_delay
                      - alias: Parallel Actions for the by-pass auto off
                        parallel:
                          - sequence:
                              - choose:
                                  - conditions:
                                      - condition: template
                                        value_template: "{{ ('bypass_enabled_turn_on' in include_bypass) and ('bypass_auto_off_enabled_on' in include_bypass_auto_off) }}"
                                    sequence:
                                      - alias: "Turn off the by-pass"
                                        service: homeassistant.turn_off
                                        entity_id: !input motion_bypass_lights_on
                          - sequence:
                              - choose:
                                  - conditions:
                                      - condition: template
                                        value_template: "{{ ('bypass_enabled_turn_off' in include_bypass) and ('bypass_auto_off_enabled_off' in include_bypass_auto_off) }}"
                                    sequence:
                                      - alias: "Turn off the by-pass"
                                        service: homeassistant.turn_off
                                        entity_id: !input motion_bypass_lights_off
                          - sequence:
                              - choose:
                                  - conditions:
                                      - condition: template
                                        value_template: "{{ ('bypass_enabled_stop' in include_bypass) and ('bypass_auto_off_enabled_stop' in include_bypass_auto_off) }}"
                                    sequence:
                                      - alias: "Turn off the by-pass"
                                        service: homeassistant.turn_off
                                        entity_id: !input motion_bypass_lights_stop
                  - stop: "Stop the automation"
      - choose:
        - alias: "Sun, Ambient Light Sensor & time above setting to turn off"
          conditions:
            - condition: trigger
              id: 
                - 't9'
                - 't10'
                - 't11'
          sequence:
            - choose:
              - alias: "If transition is selected"
                conditions:
                  - condition: template
                    value_template: "{{ 'use_transition' in include_light_control }}"
                sequence:
                  - alias: "Turn off the lights"
                    service: light.turn_off
                    target:
                      entity_id: "{{ light_entities }}"
                    data:
                      transition: "{{ transition_off_value }}"
                  - alias: "Turn off the scenes"
                    service: scene.turn_on
                    data:
                      entity_id: "{{ end_scene_entities }}"
                      transition: "{{ transition_off_value }}"
              - alias: "If transition is not selected"
                conditions:
                  - condition: template
                    value_template: "{{ 'use_transition' not in include_light_control }}"
                sequence:
                  - alias: "Turn off the lights"
                    service: light.turn_off
                    target:
                      entity_id: "{{ light_entities }}"
                  - alias: "Turn off the scenes"
                    service: scene.turn_on
                    data:
                      entity_id: "{{ end_scene_entities }}"
            - alias: "Turn off the switches"
              service: switch.turn_off
              target:
                entity_id: "{{ switch_entities }}"
            - alias: "Turn off the script"
              service: script.turn_on
              data:
                entity_id: "{{ end_script_entities }}"
            - alias: "Turn off the input boolean night lights"
              service: input_boolean.turn_off
              data:
                entity_id: !input boolean_scenes_scripts
            - stop: "Stop the automation"
        - alias: "Turn off night lights when trigger by end night lights conditions"
          conditions:
            - condition: trigger
              id:
                - 't12'
                - 't13'
                - 't14'
          sequence:
            - choose:
              - alias: "If transition is selected"
                conditions:
                  - "{{ (expand(light_switch.entity_id) | selectattr('state', '==', 'on') | list | count > 0) or (expand(night_lights.entity_id) | selectattr('state', '==', 'on') | list | count > 0) or (is_state(night_boolean_scenes_scripts, 'on')) }}"
                sequence:
                  - choose:
                    - alias: "If transition is selected"
                      conditions:
                        - condition: template
                          value_template: "{{ 'use_transition' in include_night_light_control }}"
                      sequence:
                        - alias: "Turn off the lights"
                          service: light.turn_off
                          target:
                            entity_id: "{{ crossover_night_lights_light }}"
                          data:
                            transition: "{{ night_transition_off_value }}"
                        - alias: "Turn off the scenes"
                          service: scene.turn_on
                          data:
                            entity_id: "{{ end_scene_entities }}"
                            transition: "{{ night_transition_off_value }}"
                    - alias: "If transition is not selected"
                      conditions:
                        - condition: template
                          value_template: "{{ 'use_transition' not in include_night_light_control }}"
                      sequence:
                        - alias: "Turn off the lights"
                          service: light.turn_off
                          target:
                            entity_id: "{{ crossover_night_lights_light }}"
                        - alias: "Turn off the scenes"
                          service: scene.turn_on
                          data:
                            entity_id: "{{ end_scene_entities }}"
                  - alias: "Turn off the switches"
                    service: switch.turn_off
                    target:
                      entity_id: "{{ crossover_night_lights_switch }}"
                  - alias: "Turn off the script"
                    service: script.turn_on
                    data:
                      entity_id: "{{ end_script_entities }}"
                  - alias: "Turn off the input boolean night lights"
                    service: input_boolean.turn_off
                    data:
                      entity_id: !input night_boolean_scenes_scripts
                  - choose:
                    - alias: "If adjust light settings when crossing over if lights are ON is selected in night light control"
                      conditions:
                        - condition: template
                          value_template: "{{ 'if_lights_are_on_adjust_when_crossing_over' in include_night_light_control }}"
                      sequence:
                        - choose:
                          - alias: "Set the transition and brightness for the normal lights switch"
                            conditions:
                              - condition: template
                                value_template: "{{ ('use_transition' in include_light_control) and ('use_brightness' in include_light_control) and ('enable_lux_controled_brightness' not in include_dynamic_lighting) and ('use_colour_temperature' not in include_light_control) }}"
                            sequence:
                              - service: light.turn_on
                                target:
                                  entity_id: "{{ crossover_lights_light_on }}"
                                data:
                                  transition: "{{ transition_on_value }}"
                                  brightness_pct: "{{ brightness_value }}"
                          - alias: "Set the transition and colour temperature for the normal lights switch"
                            conditions:
                              - condition: template
                                value_template: "{{ ('use_transition' in include_light_control) and ('use_brightness' not in include_light_control) and ('enable_lux_controled_brightness' not in include_dynamic_lighting) and ('use_colour_temperature' in include_light_control) }}"
                            sequence:
                              - service: light.turn_on
                                target:
                                  entity_id: "{{ crossover_lights_light_on }}"
                                data:
                                  transition: "{{ transition_on_value }}"
                                  kelvin: "{{temperature_value}}"
                          - alias: "Set the transition, brightness and colour temperature for the normal lights switch"
                            conditions:
                              - condition: template
                                value_template: "{{ ('use_transition' in include_light_control) and ('use_brightness' in include_light_control) and ('enable_lux_controled_brightness' not in include_dynamic_lighting) and ('use_colour_temperature' in include_light_control) }}"
                            sequence:
                              - service: light.turn_on
                                target:
                                  entity_id: "{{ crossover_lights_light_on }}"
                                data:
                                  transition: "{{ transition_on_value }}"
                                  brightness_pct: "{{ brightness_value }}"
                                  kelvin: "{{temperature_value}}"
                          - alias: "Set the brightness for the normal lights switch"
                            conditions:
                              - condition: template
                                value_template: "{{ ('use_transition' not in include_light_control) and ('use_brightness' in include_light_control) and ('enable_lux_controled_brightness' not in include_dynamic_lighting) and ('use_colour_temperature' not in include_light_control) }}"
                            sequence:
                              - service: light.turn_on
                                target:
                                  entity_id: "{{ crossover_lights_light_on }}"
                                data:
                                  brightness_pct: "{{ brightness_value }}"
                          - alias: "Set the colour temperature for the normal lights switch"
                            conditions:
                              - condition: template
                                value_template: "{{ ('use_transition' not in include_light_control) and ('use_brightness' not in include_light_control) and ('enable_lux_controled_brightness' not in include_dynamic_lighting) and ('use_colour_temperature' in include_light_control) }}"
                            sequence:
                              - service: light.turn_on
                                target:
                                  entity_id: "{{ crossover_lights_light_on }}"
                                data:
                                  kelvin: "{{temperature_value}}"
                          - alias: "Set the brightness and colour temperature for the normal lights switch"
                            conditions:
                              - condition: template
                                value_template: "{{ ('use_transition' not in include_light_control) and ('use_brightness' in include_light_control) and ('enable_lux_controled_brightness' not in include_dynamic_lighting) and ('use_colour_temperature' in include_light_control) }}"
                            sequence:
                              - service: light.turn_on
                                target:
                                  entity_id: "{{ crossover_lights_light_on }}"
                                data:
                                  brightness_pct: "{{ brightness_value }}"
                                  kelvin: "{{temperature_value}}"
              - alias: "If transition is selected"
                conditions:
                  - "{{ 'manage_scripts_crossing_over' in include_night_light_control }}"
                  - "{{ (expand(light_switch.entity_id) | selectattr('state', '==', 'off') | list | count > 0) or (expand(night_lights.entity_id) | selectattr('state', '==', 'off') | list | count > 0) or (is_state(night_boolean_scenes_scripts, 'off')) }}"
                sequence:
                  - alias: "Turn off the script"
                    service: script.turn_on
                    data:
                      entity_id: "{{ end_script_entities }}"
                  - stop: "Stop the automation"
        - alias: "Safe Guard when HA restarts"
          conditions:
            - condition: trigger
              id: 't15'
          sequence:
            - choose:
              - alias: "Check all by-pass are off and check conditions if enabled "
                conditions:
                  - condition: or
                    conditions:
                      - condition: and
                        conditions:
                          - "{{ ('bypass_enabled_turn_on' in include_bypass) and ('bypass_enabled_turn_off' in include_bypass) and ('bypass_enabled_stop' in include_bypass) }}"
                          - condition: state
                            entity_id: !input motion_bypass_lights_on
                            state: 'off'
                          - condition: state
                            entity_id: !input motion_bypass_lights_off
                            state: 'off'
                          - condition: state
                            entity_id: !input motion_bypass_lights_stop
                            state: 'off'
                      - condition: and
                        conditions:
                          - "{{ ('bypass_enabled_turn_on' in include_bypass) and ('bypass_enabled_turn_off' in include_bypass) and ('bypass_enabled_stop' not in include_bypass) }}"
                          - condition: state
                            entity_id: !input motion_bypass_lights_on
                            state: 'off'
                          - condition: state
                            entity_id: !input motion_bypass_lights_off
                            state: 'off'
                      - condition: and
                        conditions:
                          - "{{ ('bypass_enabled_turn_on' in include_bypass) and ('bypass_enabled_turn_off' not in include_bypass) and ('bypass_enabled_stop' in include_bypass) }}"
                          - condition: state
                            entity_id: !input motion_bypass_lights_on
                            state: 'off'
                          - condition: state
                            entity_id: !input motion_bypass_lights_stop
                            state: 'off'
                      - condition: and
                        conditions:
                          - "{{ ('bypass_enabled_turn_on' not in include_bypass) and ('bypass_enabled_turn_off' in include_bypass) and ('bypass_enabled_stop' in include_bypass) }}"
                          - condition: state
                            entity_id: !input motion_bypass_lights_off
                            state: 'off'
                          - condition: state
                            entity_id: !input motion_bypass_lights_stop
                            state: 'off'
                      - condition: and
                        conditions:
                          - "{{ ('bypass_enabled_turn_on' in include_bypass) and ('bypass_enabled_turn_off' not in include_bypass) and ('bypass_enabled_stop' not in include_bypass) }}"
                          - condition: state
                            entity_id: !input motion_bypass_lights_on
                            state: 'off'
                      - condition: and
                        conditions:
                          - "{{ ('bypass_enabled_turn_on' not in include_bypass) and ('bypass_enabled_turn_off' in include_bypass) and ('bypass_enabled_stop' not in include_bypass) }}"
                          - condition: state
                            entity_id: !input motion_bypass_lights_off
                            state: 'off'
                      - condition: and
                        conditions:
                          - "{{ ('bypass_enabled_turn_on' not in include_bypass) and ('bypass_enabled_turn_off' not in include_bypass) and ('bypass_enabled_stop' in include_bypass) }}"
                          - condition: state
                            entity_id: !input motion_bypass_lights_stop
                            state: 'off'
                sequence:
                  - alias: "Small time delay required"
                    delay:
                      seconds: 1
              - alias: "Check if any by-passes are on"
                conditions:
                  - condition: or
                    conditions:
                      - condition: and
                        conditions:
                          - "{{ ('bypass_enabled_turn_on' in include_bypass) and ('bypass_enabled_turn_off' in include_bypass) and ('bypass_enabled_stop' in include_bypass) }}"
                          - condition: or
                            conditions:
                              - condition: state
                                entity_id: !input motion_bypass_lights_on
                                match: any
                                state: 'on'
                              - condition: state
                                entity_id: !input motion_bypass_lights_off
                                match: any
                                state: 'on'
                              - condition: state
                                entity_id: !input motion_bypass_lights_stop
                                match: any
                                state: 'on'
                      - condition: and
                        conditions:
                          - "{{ ('bypass_enabled_turn_on' in include_bypass) and ('bypass_enabled_turn_off' in include_bypass) and ('bypass_enabled_stop' not in include_bypass) }}"
                          - condition: or
                            conditions:
                              - condition: state
                                entity_id: !input motion_bypass_lights_on
                                match: any
                                state: 'on'
                              - condition: state
                                entity_id: !input motion_bypass_lights_off
                                match: any
                                state: 'on'
                      - condition: and
                        conditions:
                          - "{{ ('bypass_enabled_turn_on' in include_bypass) and ('bypass_enabled_turn_off' not in include_bypass) and ('bypass_enabled_stop' in include_bypass) }}"
                          - condition: or
                            conditions:
                              - condition: state
                                entity_id: !input motion_bypass_lights_on
                                match: any
                                state: 'on'
                              - condition: state
                                entity_id: !input motion_bypass_lights_stop
                                match: any
                                state: 'on'
                      - condition: and
                        conditions:
                          - "{{ ('bypass_enabled_turn_on' not in include_bypass) and ('bypass_enabled_turn_off' in include_bypass) and ('bypass_enabled_stop' in include_bypass) }}"
                          - condition: or
                            conditions:
                              - condition: state
                                entity_id: !input motion_bypass_lights_off
                                match: any
                                state: 'on'
                              - condition: state
                                entity_id: !input motion_bypass_lights_stop
                                match: any
                                state: 'on'
                      - condition: and
                        conditions:
                          - "{{ ('bypass_enabled_turn_on' in include_bypass) and ('bypass_enabled_turn_off' not in include_bypass) and ('bypass_enabled_stop' not in include_bypass) }}"
                          - condition: state
                            entity_id: !input motion_bypass_lights_on
                            match: any
                            state: 'on'
                      - condition: and
                        conditions:
                          - "{{ ('bypass_enabled_turn_on' not in include_bypass) and ('bypass_enabled_turn_off' in include_bypass) and ('bypass_enabled_stop' not in include_bypass) }}"
                          - condition: state
                            entity_id: !input motion_bypass_lights_off
                            match: any
                            state: 'on'
                      - condition: and
                        conditions:
                          - "{{ ('bypass_enabled_turn_on' not in include_bypass) and ('bypass_enabled_turn_off' not in include_bypass) and ('bypass_enabled_stop' in include_bypass) }}"
                          - condition: state
                            entity_id: !input motion_bypass_lights_stop
                            match: any
                            state: 'on'
                sequence:
                  - alias: "Check by-pass auto off is enabled and preform the correct"
                    if:
                      - alias: "Check if the by-pass auto off is enabled"
                        condition: template
                        value_template: "{{ ('bypass_auto_off_enabled_on' in include_bypass_auto_off) or ('bypass_auto_off_enabled_off' in include_bypass_auto_off) or ('bypass_auto_off_enabled_stop' in include_bypass_auto_off) }}"
                    then:
                      - alias: "Wait the number of minutes set in the by-pass auto off time delay"
                        delay: 
                          minutes: !input bypass_auto_off_delay
                      - alias: Parallel Actions for the by-pass auto off
                        parallel:
                          - sequence:
                              - choose:
                                  - conditions:
                                      - condition: template
                                        value_template: "{{ ('bypass_enabled_turn_on' in include_bypass) and ('bypass_auto_off_enabled_on' in include_bypass_auto_off) }}"
                                    sequence:
                                      - alias: "Turn off the by-pass"
                                        service: homeassistant.turn_off
                                        entity_id: !input motion_bypass_lights_on
                          - sequence:
                              - choose:
                                  - conditions:
                                      - condition: template
                                        value_template: "{{ ('bypass_enabled_turn_off' in include_bypass) and ('bypass_auto_off_enabled_off' in include_bypass_auto_off) }}"
                                    sequence:
                                      - alias: "Turn off the by-pass"
                                        service: homeassistant.turn_off
                                        entity_id: !input motion_bypass_lights_off
                          - sequence:
                              - choose:
                                  - conditions:
                                      - condition: template
                                        value_template: "{{ ('bypass_enabled_stop' in include_bypass) and ('bypass_auto_off_enabled_stop' in include_bypass_auto_off) }}"
                                    sequence:
                                      - alias: "Turn off the by-pass"
                                        service: homeassistant.turn_off
                                        entity_id: !input motion_bypass_lights_stop
                  - stop: "Stop the automation"
      - alias: "Parallel Actions for dynamic lighting"
        parallel:
          - sequence:
              - alias: "Check if the dynamic lighting is enabled"
                condition: and
                conditions:
                  - condition: template
                    value_template: "{{'disable_dynamic_lighting' not in include_dynamic_lighting }}"
              - choose:
                - alias: "Set the Dynamic Lux Controlled Brightness for the normal lights switch"
                  conditions:
                    - condition: template
                      value_template: "{{ include_dynamic_lighting == 'enable_lux_controled_brightness'}}"
                  sequence:
                    - alias: "Dynamic Lighting Control"
                      repeat:
                        until: "{{ expand(light_switch.entity_id) | selectattr('state', '==', 'off') | list | count > 0 }}"
                        sequence:
                          - choose:
                            - alias: "Set the transition and dynamic lighting brightness for the normal lights switch"
                              conditions:
                                - condition: template
                                  value_template: "{{ ('use_transition' in include_light_control) and (include_dynamic_lighting == 'enable_lux_controled_brightness') and ('use_colour_temperature' not in include_light_control) }}"
                              sequence:
                                - service: light.turn_on
                                  target:
                                    entity_id: "{{ light_entities }}"
                                  data:
                                    transition: "{{ transition_on_value }}"
                                    brightness_pct: >
                                      {% set lux = states(dynamic_lighting_lux_sensor) | float %}
                                      {% set slope = (dynamic_lighting_min_brightness - dynamic_lighting_max_brightness) / (dynamic_lighting_max_lux - dynamic_lighting_min_lux) %}
                                      {% set ak = (( slope * dynamic_lighting_min_lux) * -1) + dynamic_lighting_max_brightness %}
                                      {% set le = light_entities %}
                                      {% set lec = expand(le) | map(attribute='entity_id') | list | length %}
                                      {% set lp = expand(le) | map(attribute='attributes.brightness') | reject('equalto', None) | sum | float(default=255) / 255 * 100 / lec %}
                                      {% if lux <= dynamic_lighting_min_lux %}
                                        {% set bv = dynamic_lighting_max_brightness %}
                                      {% elif lux >= dynamic_lighting_max_lux %}
                                        {% set bv = dynamic_lighting_min_brightness %}
                                      {% else %}
                                        {% set bv = ((slope * lux) + ak) | round(1) %}
                                      {% endif %}
                                      {% if lp <= 0 %}
                                        {% set bv = bv %}
                                      {% elif (bv > lp) and (bv - lp) <= dynamic_lighting_dead_zone %}
                                        {% set bv = lp %}
                                      {% elif (lp > bv) and  (lp - bv) <= dynamic_lighting_dead_zone %}
                                        {% set bv = lp %}
                                      {% elif bv > (lp + dynamic_lighting_step_value) %}
                                        {% set bv = lp + dynamic_lighting_step_value %}
                                      {% elif bv < (lp - dynamic_lighting_step_value) %}
                                        {% set bv = lp - dynamic_lighting_step_value %}
                                      {% endif %}
                                      {{ bv | round(0) }}
                                - alias: "Dynamic lighting heartbeat"
                                  delay:
                                    minutes: !input dynamic_lighting_heartbeat
                            - alias: "Set the transition, dynamic lighting brightness and colour temperature for the normal lights switch"
                              conditions:
                                - condition: template
                                  value_template: "{{ ('use_transition' in include_light_control) and (include_dynamic_lighting == 'enable_lux_controled_brightness') and ('use_colour_temperature' in include_light_control) }}"
                              sequence:
                                - service: light.turn_on
                                  target:
                                    entity_id: "{{ light_entities }}"
                                  data:
                                    transition: "{{ transition_on_value }}"
                                    brightness_pct: >
                                      {% set lux = states(dynamic_lighting_lux_sensor) | float %}
                                      {% set slope = (dynamic_lighting_min_brightness - dynamic_lighting_max_brightness) / (dynamic_lighting_max_lux - dynamic_lighting_min_lux) %}
                                      {% set ak = (( slope * dynamic_lighting_min_lux) * -1) + dynamic_lighting_max_brightness %}
                                      {% set le = light_entities %}
                                      {% set lec = expand(le) | map(attribute='entity_id') | list | length %}
                                      {% set lp = expand(le) | map(attribute='attributes.brightness') | reject('equalto', None) | sum | float(default=255) / 255 * 100 / lec %}
                                      {% if lux <= dynamic_lighting_min_lux %}
                                        {% set bv = dynamic_lighting_max_brightness %}
                                      {% elif lux >= dynamic_lighting_max_lux %}
                                        {% set bv = dynamic_lighting_min_brightness %}
                                      {% else %}
                                        {% set bv = ((slope * lux) + ak) | round(1) %}
                                      {% endif %}
                                      {% if lp <= 0 %}
                                        {% set bv = bv %}
                                      {% elif (bv > lp) and (bv - lp) <= dynamic_lighting_dead_zone %}
                                        {% set bv = lp %}
                                      {% elif (lp > bv) and  (lp - bv) <= dynamic_lighting_dead_zone %}
                                        {% set bv = lp %}
                                      {% elif bv > (lp + dynamic_lighting_step_value) %}
                                        {% set bv = lp + dynamic_lighting_step_value %}
                                      {% elif bv < (lp - dynamic_lighting_step_value) %}
                                        {% set bv = lp - dynamic_lighting_step_value %}
                                      {% endif %}
                                      {{ bv | round(0) }}
                                    kelvin: "{{temperature_value}}"
                                - alias: "Dynamic lighting heartbeat"
                                  delay:
                                    minutes: !input dynamic_lighting_heartbeat
                            - alias: "Set the dynamic lighting brightness for the normal lights switch"
                              conditions:
                                - condition: template
                                  value_template: "{{ ('use_transition' not in include_light_control) and (include_dynamic_lighting == 'enable_lux_controled_brightness') and ('use_colour_temperature' not in include_light_control) }}"
                              sequence:
                                - service: light.turn_on
                                  target:
                                    entity_id: "{{ light_entities }}"
                                  data:
                                    brightness_pct: >
                                      {% set lux = states(dynamic_lighting_lux_sensor) | float %}
                                      {% set slope = (dynamic_lighting_min_brightness - dynamic_lighting_max_brightness) / (dynamic_lighting_max_lux - dynamic_lighting_min_lux) %}
                                      {% set ak = (( slope * dynamic_lighting_min_lux) * -1) + dynamic_lighting_max_brightness %}
                                      {% set le = light_entities %}
                                      {% set lec = expand(le) | map(attribute='entity_id') | list | length %}
                                      {% set lp = expand(le) | map(attribute='attributes.brightness') | reject('equalto', None) | sum | float(default=255) / 255 * 100 / lec %}
                                      {% if lux <= dynamic_lighting_min_lux %}
                                        {% set bv = dynamic_lighting_max_brightness %}
                                      {% elif lux >= dynamic_lighting_max_lux %}
                                        {% set bv = dynamic_lighting_min_brightness %}
                                      {% else %}
                                        {% set bv = ((slope * lux) + ak) | round(1) %}
                                      {% endif %}
                                      {% if lp <= 0 %}
                                        {% set bv = bv %}
                                      {% elif (bv > lp) and (bv - lp) <= dynamic_lighting_dead_zone %}
                                        {% set bv = lp %}
                                      {% elif (lp > bv) and  (lp - bv) <= dynamic_lighting_dead_zone %}
                                        {% set bv = lp %}
                                      {% elif bv > (lp + dynamic_lighting_step_value) %}
                                        {% set bv = lp + dynamic_lighting_step_value %}
                                      {% elif bv < (lp - dynamic_lighting_step_value) %}
                                        {% set bv = lp - dynamic_lighting_step_value %}
                                      {% endif %}
                                      {{ bv | round(0) }}
                                - alias: "Dynamic lighting heartbeat"
                                  delay:
                                    minutes: !input dynamic_lighting_heartbeat
                            - alias: "Set the dynamic lighting brightness and colour temperature for the normal lights switch"
                              conditions:
                                - condition: template
                                  value_template: "{{ ('use_transition' not in include_light_control) and (include_dynamic_lighting == 'enable_lux_controled_brightness') and ('use_colour_temperature' in include_light_control) }}"
                              sequence:
                                - service: light.turn_on
                                  target:
                                    entity_id: "{{ light_entities }}"
                                  data:
                                    brightness_pct: >
                                      {% set lux = states(dynamic_lighting_lux_sensor) | float %}
                                      {% set slope = (dynamic_lighting_min_brightness - dynamic_lighting_max_brightness) / (dynamic_lighting_max_lux - dynamic_lighting_min_lux) %}
                                      {% set ak = (( slope * dynamic_lighting_min_lux) * -1) + dynamic_lighting_max_brightness %}
                                      {% set le = light_entities %}
                                      {% set lec = expand(le) | map(attribute='entity_id') | list | length %}
                                      {% set lp = expand(le) | map(attribute='attributes.brightness') | reject('equalto', None) | sum | float(default=255) / 255 * 100 / lec %}
                                      {% if lux <= dynamic_lighting_min_lux %}
                                        {% set bv = dynamic_lighting_max_brightness %}
                                      {% elif lux >= dynamic_lighting_max_lux %}
                                        {% set bv = dynamic_lighting_min_brightness %}
                                      {% else %}
                                        {% set bv = ((slope * lux) + ak) | round(1) %}
                                      {% endif %}
                                      {% if lp <= 0 %}
                                        {% set bv = bv %}
                                      {% elif (bv > lp) and (bv - lp) <= dynamic_lighting_dead_zone %}
                                        {% set bv = lp %}
                                      {% elif (lp > bv) and  (lp - bv) <= dynamic_lighting_dead_zone %}
                                        {% set bv = lp %}
                                      {% elif bv > (lp + dynamic_lighting_step_value) %}
                                        {% set bv = lp + dynamic_lighting_step_value %}
                                      {% elif bv < (lp - dynamic_lighting_step_value) %}
                                        {% set bv = lp - dynamic_lighting_step_value %}
                                      {% endif %}
                                      {{ bv | round(0) }}
                                    kelvin: "{{temperature_value}}"
                                - alias: "Dynamic lighting heartbeat"
                                  delay:
                                    minutes: !input dynamic_lighting_heartbeat
              - choose:
                - alias: "Dynamic Lighting -  Lux Controlled Brightness - Inverted for the normal lights switch"
                  conditions:
                    - condition: template
                      value_template: "{{ include_dynamic_lighting == 'enable_lux_controled_brightness_inv'}}"
                  sequence:
                    - alias: "Dynamic Lighting Control"
                      repeat:
                        until: "{{ expand(light_switch.entity_id) | selectattr('state', '==', 'off') | list | count > 0 }}"
                        sequence:
                          - choose:
                            - alias: "Set the transition and dynamic lighting brightness for the normal lights switch"
                              conditions:
                                - condition: template
                                  value_template: "{{ ('use_transition' in include_light_control) and (include_dynamic_lighting == 'enable_lux_controled_brightness_inv') and ('use_colour_temperature' not in include_light_control) }}"
                              sequence:
                                - service: light.turn_on
                                  target:
                                    entity_id: "{{ light_entities }}"
                                  data:
                                    transition: "{{ transition_on_value }}"
                                    brightness_pct: >
                                      {% set lux = states(dynamic_lighting_lux_sensor) | float %}
                                      {% set slope = (dynamic_lighting_min_brightness - dynamic_lighting_max_brightness) / (dynamic_lighting_min_lux - dynamic_lighting_max_lux) %}
                                      {% set ak = (( slope * dynamic_lighting_min_lux) * -1) + dynamic_lighting_min_brightness %}
                                      {% set le = light_entities %}
                                      {% set lec = expand(le) | map(attribute='entity_id') | list | length %}
                                      {% set lp = expand(le) | map(attribute='attributes.brightness') | reject('equalto', None) | sum | float(default=255) / 255 * 100 / lec %}
                                      {% if lux <= dynamic_lighting_min_lux %}
                                        {% set bv = dynamic_lighting_min_brightness %}
                                      {% elif lux >= dynamic_lighting_max_lux %}
                                        {% set bv = dynamic_lighting_max_brightness %}
                                      {% else %}
                                        {% set bv = ((slope * lux) + ak) | round(1) %}
                                      {% endif %}
                                      {% if lp <= 0 %}
                                        {% set bv = bv %}
                                      {% elif (bv > lp) and (bv - lp) <= dynamic_lighting_dead_zone %}
                                        {% set bv = lp %}
                                      {% elif (lp > bv) and  (lp - bv) <= dynamic_lighting_dead_zone %}
                                        {% set bv = lp %}
                                      {% elif bv > (lp + dynamic_lighting_step_value) %}
                                        {% set bv = lp + dynamic_lighting_step_value %}
                                      {% elif bv < (lp - dynamic_lighting_step_value) %}
                                        {% set bv = lp - dynamic_lighting_step_value %}
                                      {% endif %}
                                      {{ bv | round(0) }}
                                - alias: "Dynamic lighting heartbeat"
                                  delay:
                                    minutes: !input dynamic_lighting_heartbeat
                            - alias: "Set the transition, dynamic lighting brightness and colour temperature for the normal lights switch"
                              conditions:
                                - condition: template
                                  value_template: "{{ ('use_transition' in include_light_control) and (include_dynamic_lighting == 'enable_lux_controled_brightness_inv') and ('use_colour_temperature' in include_light_control) }}"
                              sequence:
                                - service: light.turn_on
                                  target:
                                    entity_id: "{{ light_entities }}"
                                  data:
                                    transition: "{{ transition_on_value }}"
                                    brightness_pct: >
                                      {% set lux = states(dynamic_lighting_lux_sensor) | float %}
                                      {% set slope = (dynamic_lighting_min_brightness - dynamic_lighting_max_brightness) / (dynamic_lighting_min_lux - dynamic_lighting_max_lux) %}
                                      {% set ak = (( slope * dynamic_lighting_min_lux) * -1) + dynamic_lighting_min_brightness %}
                                      {% set le = light_entities %}
                                      {% set lec = expand(le) | map(attribute='entity_id') | list | length %}
                                      {% set lp = expand(le) | map(attribute='attributes.brightness') | reject('equalto', None) | sum | float(default=255) / 255 * 100 / lec %}
                                      {% if lux <= dynamic_lighting_min_lux %}
                                        {% set bv = dynamic_lighting_min_brightness %}
                                      {% elif lux >= dynamic_lighting_max_lux %}
                                        {% set bv = dynamic_lighting_max_brightness %}
                                      {% else %}
                                        {% set bv = ((slope * lux) + ak) | round(1) %}
                                      {% endif %}
                                      {% if lp <= 0 %}
                                        {% set bv = bv %}
                                      {% elif (bv > lp) and (bv - lp) <= dynamic_lighting_dead_zone %}
                                        {% set bv = lp %}
                                      {% elif (lp > bv) and  (lp - bv) <= dynamic_lighting_dead_zone %}
                                        {% set bv = lp %}
                                      {% elif bv > (lp + dynamic_lighting_step_value) %}
                                        {% set bv = lp + dynamic_lighting_step_value %}
                                      {% elif bv < (lp - dynamic_lighting_step_value) %}
                                        {% set bv = lp - dynamic_lighting_step_value %}
                                      {% endif %}
                                      {{ bv | round(0) }}
                                    kelvin: "{{temperature_value}}"
                                - alias: "Dynamic lighting heartbeat"
                                  delay:
                                    minutes: !input dynamic_lighting_heartbeat
                            - alias: "Set the dynamic lighting brightness for the normal lights switch"
                              conditions:
                                - condition: template
                                  value_template: "{{ ('use_transition' not in include_light_control) and (include_dynamic_lighting == 'enable_lux_controled_brightness_inv') and ('use_colour_temperature' not in include_light_control) }}"
                              sequence:
                                - service: light.turn_on
                                  target:
                                    entity_id: "{{ light_entities }}"
                                  data:
                                    brightness_pct: >
                                      {% set lux = states(dynamic_lighting_lux_sensor) | float %}
                                      {% set slope = (dynamic_lighting_min_brightness - dynamic_lighting_max_brightness) / (dynamic_lighting_min_lux - dynamic_lighting_max_lux) %}
                                      {% set ak = (( slope * dynamic_lighting_min_lux) * -1) + dynamic_lighting_min_brightness %}
                                      {% set le = light_entities %}
                                      {% set lec = expand(le) | map(attribute='entity_id') | list | length %}
                                      {% set lp = expand(le) | map(attribute='attributes.brightness') | reject('equalto', None) | sum | float(default=255) / 255 * 100 / lec %}
                                      {% if lux <= dynamic_lighting_min_lux %}
                                        {% set bv = dynamic_lighting_min_brightness %}
                                      {% elif lux >= dynamic_lighting_max_lux %}
                                        {% set bv = dynamic_lighting_max_brightness %}
                                      {% else %}
                                        {% set bv = ((slope * lux) + ak) | round(1) %}
                                      {% endif %}
                                      {% if lp <= 0 %}
                                        {% set bv = bv %}
                                      {% elif (bv > lp) and (bv - lp) <= dynamic_lighting_dead_zone %}
                                        {% set bv = lp %}
                                      {% elif (lp > bv) and  (lp - bv) <= dynamic_lighting_dead_zone %}
                                        {% set bv = lp %}
                                      {% elif bv > (lp + dynamic_lighting_step_value) %}
                                        {% set bv = lp + dynamic_lighting_step_value %}
                                      {% elif bv < (lp - dynamic_lighting_step_value) %}
                                        {% set bv = lp - dynamic_lighting_step_value %}
                                      {% endif %}
                                      {{ bv | round(0) }}
                                - alias: "Dynamic lighting heartbeat"
                                  delay:
                                    minutes: !input dynamic_lighting_heartbeat
                            - alias: "Set the dynamic lighting brightness and colour temperature for the normal lights switch"
                              conditions:
                                - condition: template
                                  value_template: "{{ ('use_transition' not in include_light_control) and (include_dynamic_lighting == 'enable_lux_controled_brightness_inv') and ('use_colour_temperature' in include_light_control) }}"
                              sequence:
                                - service: light.turn_on
                                  target:
                                    entity_id: "{{ light_entities }}"
                                  data:
                                    brightness_pct: >
                                      {% set lux = states(dynamic_lighting_lux_sensor) | float %}
                                      {% set slope = (dynamic_lighting_min_brightness - dynamic_lighting_max_brightness) / (dynamic_lighting_min_lux - dynamic_lighting_max_lux) %}
                                      {% set ak = (( slope * dynamic_lighting_min_lux) * -1) + dynamic_lighting_min_brightness %}
                                      {% set le = light_entities %}
                                      {% set lec = expand(le) | map(attribute='entity_id') | list | length %}
                                      {% set lp = expand(le) | map(attribute='attributes.brightness') | reject('equalto', None) | sum | float(default=255) / 255 * 100 / lec %}
                                      {% if lux <= dynamic_lighting_min_lux %}
                                        {% set bv = dynamic_lighting_min_brightness %}
                                      {% elif lux >= dynamic_lighting_max_lux %}
                                        {% set bv = dynamic_lighting_max_brightness %}
                                      {% else %}
                                        {% set bv = ((slope * lux) + ak) | round(1) %}
                                      {% endif %}
                                      {% if lp <= 0 %}
                                        {% set bv = bv %}
                                      {% elif (bv > lp) and (bv - lp) <= dynamic_lighting_dead_zone %}
                                        {% set bv = lp %}
                                      {% elif (lp > bv) and  (lp - bv) <= dynamic_lighting_dead_zone %}
                                        {% set bv = lp %}
                                      {% elif bv > (lp + dynamic_lighting_step_value) %}
                                        {% set bv = lp + dynamic_lighting_step_value %}
                                      {% elif bv < (lp - dynamic_lighting_step_value) %}
                                        {% set bv = lp - dynamic_lighting_step_value %}
                                      {% endif %}
                                      {{ bv | round(0) }}
                                    kelvin: "{{temperature_value}}"
                                - alias: "Dynamic lighting heartbeat"
                                  delay:
                                    minutes: !input dynamic_lighting_heartbeat
              - choose:
                - alias: "Dynamic Lighting - Sun Elevation Lighting - Colour Temp for the normal lights switch"
                  conditions:
                    - condition: template
                      value_template: "{{ include_dynamic_lighting == 'enable_sun_elevation_colour' }}"
                  sequence:
                    - alias: "Dynamic Lighting Control"
                      repeat:
                        until: "{{ expand(light_switch.entity_id) | selectattr('state', '==', 'off') | list | count > 0 }}"
                        sequence:
                          - choose:
                            - alias: "Set the transition and dynamic sun elevation colour temperature for the normal lights switch"
                              conditions:
                                - condition: template
                                  value_template: "{{ ('use_transition' in include_light_control) and ('use_brightness' not in include_light_control) and (include_dynamic_lighting == 'enable_sun_elevation_colour') }}"
                              sequence:
                                - service: light.turn_on
                                  target:
                                    entity_id: "{{ light_entities }}"
                                  data:
                                    transition: "{{ transition_on_value }}"
                                    kelvin: >
                                      {% set elevation = state_attr('sun.sun', 'elevation') | float %}
                                      {% set start_slope = (dynamic_lighting_min_colour_temp - dynamic_lighting_max_colour_temp) / (dynamic_lighting_sun_elevation_start_rising - dynamic_lighting_sun_elevation_end_rising) %}
                                      {% set start_ak = (( start_slope * dynamic_lighting_sun_elevation_end_rising) * -1) + dynamic_lighting_max_colour_temp %}
                                      {% set end_slope = (dynamic_lighting_min_colour_temp - dynamic_lighting_max_colour_temp) / (dynamic_lighting_sun_elevation_end_falling - dynamic_lighting_sun_elevation_start_falling) %}
                                      {% set end_ak = (( end_slope * dynamic_lighting_sun_elevation_end_falling) * -1) + dynamic_lighting_min_colour_temp %}
                                      {% if elevation >= -10 %}
                                        {% if elevation >= dynamic_lighting_sun_elevation_start_rising and elevation <= dynamic_lighting_sun_elevation_end_rising and is_state_attr('sun.sun', 'rising', true) %}
                                          {% set colour_temp_value = ((start_slope * elevation) + start_ak) | round(1) %}
                                        {% elif elevation <= dynamic_lighting_sun_elevation_start_falling and elevation >= dynamic_lighting_sun_elevation_end_falling and is_state_attr('sun.sun', 'rising', false) %}
                                          {% set colour_temp_value = ((end_slope * elevation) + end_ak) | round(1) %}
                                        {% elif elevation >= dynamic_lighting_sun_elevation_end_rising and elevation >= dynamic_lighting_sun_elevation_start_falling  %}
                                          {% set colour_temp_value = dynamic_lighting_max_colour_temp %}
                                        {% elif elevation <= dynamic_lighting_sun_elevation_start_rising and is_state_attr('sun.sun', 'rising', true) %}
                                          {% set colour_temp_value = dynamic_lighting_min_colour_temp %}
                                        {% elif elevation <= dynamic_lighting_sun_elevation_end_falling and is_state_attr('sun.sun', 'rising', false) %}
                                          {% set colour_temp_value = dynamic_lighting_min_colour_temp %}
                                        {% endif %}
                                      {% else %}
                                        {% set colour_temp_value = dynamic_lighting_min_colour_temp %}
                                      {% endif %}
                                      {{ colour_temp_value | round(0) }}
                                - alias: "Dynamic lighting heartbeat"
                                  delay:
                                    minutes: !input dynamic_lighting_heartbeat
                            - alias: "Set the transition, lighting brightness and dynamic sun elevation colour temperature for the normal lights switch"
                              conditions:
                                - condition: template
                                  value_template: "{{ ('use_transition' in include_light_control) and ('use_brightness' in include_light_control) and (include_dynamic_lighting == 'enable_sun_elevation_colour') }}"
                              sequence:
                                - service: light.turn_on
                                  target:
                                    entity_id: "{{ light_entities }}"
                                  data:
                                    transition: "{{ transition_on_value }}"
                                    brightness_pct: "{{ brightness_value }}"
                                    kelvin: >
                                      {% set elevation = state_attr('sun.sun', 'elevation') | float %}
                                      {% set start_slope = (dynamic_lighting_min_colour_temp - dynamic_lighting_max_colour_temp) / (dynamic_lighting_sun_elevation_start_rising - dynamic_lighting_sun_elevation_end_rising) %}
                                      {% set start_ak = (( start_slope * dynamic_lighting_sun_elevation_end_rising) * -1) + dynamic_lighting_max_colour_temp %}
                                      {% set end_slope = (dynamic_lighting_min_colour_temp - dynamic_lighting_max_colour_temp) / (dynamic_lighting_sun_elevation_end_falling - dynamic_lighting_sun_elevation_start_falling) %}
                                      {% set end_ak = (( end_slope * dynamic_lighting_sun_elevation_end_falling) * -1) + dynamic_lighting_min_colour_temp %}
                                      {% if elevation >= -10 %}
                                        {% if elevation >= dynamic_lighting_sun_elevation_start_rising and elevation <= dynamic_lighting_sun_elevation_end_rising and is_state_attr('sun.sun', 'rising', true) %}
                                          {% set colour_temp_value = ((start_slope * elevation) + start_ak) | round(1) %}
                                        {% elif elevation <= dynamic_lighting_sun_elevation_start_falling and elevation >= dynamic_lighting_sun_elevation_end_falling and is_state_attr('sun.sun', 'rising', false) %}
                                          {% set colour_temp_value = ((end_slope * elevation) + end_ak) | round(1) %}
                                        {% elif elevation >= dynamic_lighting_sun_elevation_end_rising and elevation >= dynamic_lighting_sun_elevation_start_falling  %}
                                          {% set colour_temp_value = dynamic_lighting_max_colour_temp %}
                                        {% elif elevation <= dynamic_lighting_sun_elevation_start_rising and is_state_attr('sun.sun', 'rising', true) %}
                                          {% set colour_temp_value = dynamic_lighting_min_colour_temp %}
                                        {% elif elevation <= dynamic_lighting_sun_elevation_end_falling and is_state_attr('sun.sun', 'rising', false) %}
                                          {% set colour_temp_value = dynamic_lighting_min_colour_temp %}
                                        {% endif %}
                                      {% else %}
                                        {% set colour_temp_value = dynamic_lighting_min_colour_temp %}
                                      {% endif %}
                                      {{ colour_temp_value | round(0) }}
                                - alias: "Dynamic lighting heartbeat"
                                  delay:
                                    minutes: !input dynamic_lighting_heartbeat
                            - alias: "Set the dynamic sun elevation colour temperature for the normal lights switch"
                              conditions:
                                - condition: template
                                  value_template: "{{ ('use_transition' not in include_light_control) and ('use_brightness' not in include_light_control) and (include_dynamic_lighting == 'enable_sun_elevation_colour') }}"
                              sequence:
                                - service: light.turn_on
                                  target:
                                    entity_id: "{{ light_entities }}"
                                  data:
                                    kelvin: >
                                      {% set elevation = state_attr('sun.sun', 'elevation') | float %}
                                      {% set start_slope = (dynamic_lighting_min_colour_temp - dynamic_lighting_max_colour_temp) / (dynamic_lighting_sun_elevation_start_rising - dynamic_lighting_sun_elevation_end_rising) %}
                                      {% set start_ak = (( start_slope * dynamic_lighting_sun_elevation_end_rising) * -1) + dynamic_lighting_max_colour_temp %}
                                      {% set end_slope = (dynamic_lighting_min_colour_temp - dynamic_lighting_max_colour_temp) / (dynamic_lighting_sun_elevation_end_falling - dynamic_lighting_sun_elevation_start_falling) %}
                                      {% set end_ak = (( end_slope * dynamic_lighting_sun_elevation_end_falling) * -1) + dynamic_lighting_min_colour_temp %}
                                      {% if elevation >= -10 %}
                                        {% if elevation >= dynamic_lighting_sun_elevation_start_rising and elevation <= dynamic_lighting_sun_elevation_end_rising and is_state_attr('sun.sun', 'rising', true) %}
                                          {% set colour_temp_value = ((start_slope * elevation) + start_ak) | round(1) %}
                                        {% elif elevation <= dynamic_lighting_sun_elevation_start_falling and elevation >= dynamic_lighting_sun_elevation_end_falling and is_state_attr('sun.sun', 'rising', false) %}
                                          {% set colour_temp_value = ((end_slope * elevation) + end_ak) | round(1) %}
                                        {% elif elevation >= dynamic_lighting_sun_elevation_end_rising and elevation >= dynamic_lighting_sun_elevation_start_falling  %}
                                          {% set colour_temp_value = dynamic_lighting_max_colour_temp %}
                                        {% elif elevation <= dynamic_lighting_sun_elevation_start_rising and is_state_attr('sun.sun', 'rising', true) %}
                                          {% set colour_temp_value = dynamic_lighting_min_colour_temp %}
                                        {% elif elevation <= dynamic_lighting_sun_elevation_end_falling and is_state_attr('sun.sun', 'rising', false) %}
                                          {% set colour_temp_value = dynamic_lighting_min_colour_temp %}
                                        {% endif %}
                                      {% else %}
                                        {% set colour_temp_value = dynamic_lighting_min_colour_temp %}
                                      {% endif %}
                                      {{ colour_temp_value | round(0) }}
                                - alias: "Dynamic lighting heartbeat"
                                  delay:
                                    minutes: !input dynamic_lighting_heartbeat
                            - alias: "Set the lighting brightness and dynamic sun elevation colour temperature for the normal lights switch"
                              conditions:
                                - condition: template
                                  value_template: "{{ ('use_transition' not in include_light_control) and ('use_brightness' in include_light_control) and (include_dynamic_lighting == 'enable_sun_elevation_colour') }}"
                              sequence:
                                - service: light.turn_on
                                  target:
                                    entity_id: "{{ light_entities }}"
                                  data:
                                    brightness_pct: "{{ brightness_value }}"
                                    kelvin: >
                                      {% set elevation = state_attr('sun.sun', 'elevation') | float %}
                                      {% set start_slope = (dynamic_lighting_min_colour_temp - dynamic_lighting_max_colour_temp) / (dynamic_lighting_sun_elevation_start_rising - dynamic_lighting_sun_elevation_end_rising) %}
                                      {% set start_ak = (( start_slope * dynamic_lighting_sun_elevation_end_rising) * -1) + dynamic_lighting_max_colour_temp %}
                                      {% set end_slope = (dynamic_lighting_min_colour_temp - dynamic_lighting_max_colour_temp) / (dynamic_lighting_sun_elevation_end_falling - dynamic_lighting_sun_elevation_start_falling) %}
                                      {% set end_ak = (( end_slope * dynamic_lighting_sun_elevation_end_falling) * -1) + dynamic_lighting_min_colour_temp %}
                                      {% if elevation >= -10 %}
                                        {% if elevation >= dynamic_lighting_sun_elevation_start_rising and elevation <= dynamic_lighting_sun_elevation_end_rising and is_state_attr('sun.sun', 'rising', true) %}
                                          {% set colour_temp_value = ((start_slope * elevation) + start_ak) | round(1) %}
                                        {% elif elevation <= dynamic_lighting_sun_elevation_start_falling and elevation >= dynamic_lighting_sun_elevation_end_falling and is_state_attr('sun.sun', 'rising', false) %}
                                          {% set colour_temp_value = ((end_slope * elevation) + end_ak) | round(1) %}
                                        {% elif elevation >= dynamic_lighting_sun_elevation_end_rising and elevation >= dynamic_lighting_sun_elevation_start_falling  %}
                                          {% set colour_temp_value = dynamic_lighting_max_colour_temp %}
                                        {% elif elevation <= dynamic_lighting_sun_elevation_start_rising and is_state_attr('sun.sun', 'rising', true) %}
                                          {% set colour_temp_value = dynamic_lighting_min_colour_temp %}
                                        {% elif elevation <= dynamic_lighting_sun_elevation_end_falling and is_state_attr('sun.sun', 'rising', false) %}
                                          {% set colour_temp_value = dynamic_lighting_min_colour_temp %}
                                        {% endif %}
                                      {% else %}
                                        {% set colour_temp_value = dynamic_lighting_min_colour_temp %}
                                      {% endif %}
                                      {{ colour_temp_value | round(0) }}
                                - alias: "Dynamic lighting heartbeat"
                                  delay:
                                    minutes: !input dynamic_lighting_heartbeat
              - choose:
                - alias: "Set the Sun Elevation Lighting - Brightness for the normal lights switch"
                  conditions:
                    - condition: template
                      value_template: "{{ include_dynamic_lighting == 'enable_sun_elevation_brightness' }}"
                  sequence:
                    - alias: "Dynamic Lighting Control"
                      repeat:
                        until: "{{ expand(light_switch.entity_id) | selectattr('state', '==', 'off') | list | count > 0 }}"
                        sequence:
                          - choose:
                            - alias: "Set the transition and dynamic sun elevation lighting brightness for the normal lights switch"
                              conditions:
                                - condition: template
                                  value_template: "{{ ('use_transition' in include_light_control) and (include_dynamic_lighting == 'enable_sun_elevation_brightness') and ('use_colour_temperature' not in include_light_control) }}"
                              sequence:
                                - service: light.turn_on
                                  target:
                                    entity_id: "{{ light_entities }}"
                                  data:
                                    transition: "{{ transition_on_value }}"
                                    brightness_pct: >
                                      {% set elevation = state_attr('sun.sun', 'elevation') | float %}
                                      {% set start_slope = (dynamic_lighting_min_brightness - dynamic_lighting_max_brightness) / (dynamic_lighting_sun_elevation_start_rising - dynamic_lighting_sun_elevation_end_rising) %}
                                      {% set start_ak = (( start_slope * dynamic_lighting_sun_elevation_end_rising) * -1) + dynamic_lighting_max_brightness %}
                                      {% set end_slope = (dynamic_lighting_min_brightness - dynamic_lighting_max_brightness) / (dynamic_lighting_sun_elevation_end_falling - dynamic_lighting_sun_elevation_start_falling) %}
                                      {% set end_ak = (( end_slope * dynamic_lighting_sun_elevation_end_falling) * -1) + dynamic_lighting_min_brightness %}
                                      {% if elevation >= -10 %}
                                        {% if elevation >= dynamic_lighting_sun_elevation_start_rising and elevation <= dynamic_lighting_sun_elevation_end_rising and is_state_attr('sun.sun', 'rising', true) %}
                                          {% set brightness_value = ((start_slope * elevation) + start_ak) | round(1) %}
                                        {% elif elevation <= dynamic_lighting_sun_elevation_start_falling and elevation >= dynamic_lighting_sun_elevation_end_falling and is_state_attr('sun.sun', 'rising', false) %}
                                          {% set brightness_value = ((end_slope * elevation) + end_ak) | round(1) %}
                                        {% elif elevation >= dynamic_lighting_sun_elevation_end_rising and elevation >= dynamic_lighting_sun_elevation_start_falling  %}
                                          {% set brightness_value = dynamic_lighting_max_brightness %}
                                        {% elif elevation <= dynamic_lighting_sun_elevation_start_rising and is_state_attr('sun.sun', 'rising', true) %}
                                          {% set brightness_value = dynamic_lighting_min_brightness %}
                                        {% elif elevation <= dynamic_lighting_sun_elevation_end_falling and is_state_attr('sun.sun', 'rising', false) %}
                                          {% set brightness_value = dynamic_lighting_min_brightness %}
                                        {% endif %}
                                      {% else %}
                                        {% set brightness_value = dynamic_lighting_min_brightness %}
                                      {% endif %}
                                      {{ brightness_value | round(0) }}
                                - alias: "Dynamic lighting heartbeat"
                                  delay:
                                    minutes: !input dynamic_lighting_heartbeat
                            - alias: "Set the transition, dynamic sun elevation lighting brightness and colour temperature for the normal lights switch"
                              conditions:
                                - condition: template
                                  value_template: "{{ ('use_transition' in include_light_control) and (include_dynamic_lighting == 'enable_sun_elevation_brightness') and ('use_colour_temperature' in include_light_control) }}"
                              sequence:
                                - service: light.turn_on
                                  target:
                                    entity_id: "{{ light_entities }}"
                                  data:
                                    transition: "{{ transition_on_value }}"
                                    brightness_pct: >
                                      {% set elevation = state_attr('sun.sun', 'elevation') | float %}
                                      {% set start_slope = (dynamic_lighting_min_brightness - dynamic_lighting_max_brightness) / (dynamic_lighting_sun_elevation_start_rising - dynamic_lighting_sun_elevation_end_rising) %}
                                      {% set start_ak = (( start_slope * dynamic_lighting_sun_elevation_end_rising) * -1) + dynamic_lighting_max_brightness %}
                                      {% set end_slope = (dynamic_lighting_min_brightness - dynamic_lighting_max_brightness) / (dynamic_lighting_sun_elevation_end_falling - dynamic_lighting_sun_elevation_start_falling) %}
                                      {% set end_ak = (( end_slope * dynamic_lighting_sun_elevation_end_falling) * -1) + dynamic_lighting_min_brightness %}
                                      {% if elevation >= -10 %}
                                        {% if elevation >= dynamic_lighting_sun_elevation_start_rising and elevation <= dynamic_lighting_sun_elevation_end_rising and is_state_attr('sun.sun', 'rising', true) %}
                                          {% set brightness_value = ((start_slope * elevation) + start_ak) | round(1) %}
                                        {% elif elevation <= dynamic_lighting_sun_elevation_start_falling and elevation >= dynamic_lighting_sun_elevation_end_falling and is_state_attr('sun.sun', 'rising', false) %}
                                          {% set brightness_value = ((end_slope * elevation) + end_ak) | round(1) %}
                                        {% elif elevation >= dynamic_lighting_sun_elevation_end_rising and elevation >= dynamic_lighting_sun_elevation_start_falling  %}
                                          {% set brightness_value = dynamic_lighting_max_brightness %}
                                        {% elif elevation <= dynamic_lighting_sun_elevation_start_rising and is_state_attr('sun.sun', 'rising', true) %}
                                          {% set brightness_value = dynamic_lighting_min_brightness %}
                                        {% elif elevation <= dynamic_lighting_sun_elevation_end_falling and is_state_attr('sun.sun', 'rising', false) %}
                                          {% set brightness_value = dynamic_lighting_min_brightness %}
                                        {% endif %}
                                      {% else %}
                                        {% set brightness_value = dynamic_lighting_min_brightness %}
                                      {% endif %}
                                      {{ brightness_value | round(0) }}
                                    kelvin: "{{temperature_value}}"
                                - alias: "Dynamic lighting heartbeat"
                                  delay:
                                    minutes: !input dynamic_lighting_heartbeat
                            - alias: "Set the dynamic sun elevation lighting brightness for the normal lights switch"
                              conditions:
                                - condition: template
                                  value_template: "{{ ('use_transition' not in include_light_control) and (include_dynamic_lighting == 'enable_sun_elevation_brightness') and ('use_colour_temperature' not in include_light_control) }}"
                              sequence:
                                - service: light.turn_on
                                  target:
                                    entity_id: "{{ light_entities }}"
                                  data:
                                    brightness_pct: >
                                      {% set elevation = state_attr('sun.sun', 'elevation') | float %}
                                      {% set start_slope = (dynamic_lighting_min_brightness - dynamic_lighting_max_brightness) / (dynamic_lighting_sun_elevation_start_rising - dynamic_lighting_sun_elevation_end_rising) %}
                                      {% set start_ak = (( start_slope * dynamic_lighting_sun_elevation_end_rising) * -1) + dynamic_lighting_max_brightness %}
                                      {% set end_slope = (dynamic_lighting_min_brightness - dynamic_lighting_max_brightness) / (dynamic_lighting_sun_elevation_end_falling - dynamic_lighting_sun_elevation_start_falling) %}
                                      {% set end_ak = (( end_slope * dynamic_lighting_sun_elevation_end_falling) * -1) + dynamic_lighting_min_brightness %}
                                      {% if elevation >= -10 %}
                                        {% if elevation >= dynamic_lighting_sun_elevation_start_rising and elevation <= dynamic_lighting_sun_elevation_end_rising and is_state_attr('sun.sun', 'rising', true) %}
                                          {% set brightness_value = ((start_slope * elevation) + start_ak) | round(1) %}
                                        {% elif elevation <= dynamic_lighting_sun_elevation_start_falling and elevation >= dynamic_lighting_sun_elevation_end_falling and is_state_attr('sun.sun', 'rising', false) %}
                                          {% set brightness_value = ((end_slope * elevation) + end_ak) | round(1) %}
                                        {% elif elevation >= dynamic_lighting_sun_elevation_end_rising and elevation >= dynamic_lighting_sun_elevation_start_falling  %}
                                          {% set brightness_value = dynamic_lighting_max_brightness %}
                                        {% elif elevation <= dynamic_lighting_sun_elevation_start_rising and is_state_attr('sun.sun', 'rising', true) %}
                                          {% set brightness_value = dynamic_lighting_min_brightness %}
                                        {% elif elevation <= dynamic_lighting_sun_elevation_end_falling and is_state_attr('sun.sun', 'rising', false) %}
                                          {% set brightness_value = dynamic_lighting_min_brightness %}
                                        {% endif %}
                                      {% else %}
                                        {% set brightness_value = dynamic_lighting_min_brightness %}
                                      {% endif %}
                                      {{ brightness_value | round(0) }}
                                - alias: "Dynamic lighting heartbeat"
                                  delay:
                                    minutes: !input dynamic_lighting_heartbeat
                            - alias: "Set the dynamic sun elevation lighting brightness and colour temperature for the normal lights switch"
                              conditions:
                                - condition: template
                                  value_template: "{{ ('use_transition' not in include_light_control) and (include_dynamic_lighting == 'enable_sun_elevation_brightness') and ('use_colour_temperature' in include_light_control) }}"
                              sequence:
                                - service: light.turn_on
                                  target:
                                    entity_id: "{{ light_entities }}"
                                  data:
                                    brightness_pct: >
                                      {% set elevation = state_attr('sun.sun', 'elevation') | float %}
                                      {% set start_slope = (dynamic_lighting_min_brightness - dynamic_lighting_max_brightness) / (dynamic_lighting_sun_elevation_start_rising - dynamic_lighting_sun_elevation_end_rising) %}
                                      {% set start_ak = (( start_slope * dynamic_lighting_sun_elevation_end_rising) * -1) + dynamic_lighting_max_brightness %}
                                      {% set end_slope = (dynamic_lighting_min_brightness - dynamic_lighting_max_brightness) / (dynamic_lighting_sun_elevation_end_falling - dynamic_lighting_sun_elevation_start_falling) %}
                                      {% set end_ak = (( end_slope * dynamic_lighting_sun_elevation_end_falling) * -1) + dynamic_lighting_min_brightness %}
                                      {% if elevation >= -10 %}
                                        {% if elevation >= dynamic_lighting_sun_elevation_start_rising and elevation <= dynamic_lighting_sun_elevation_end_rising and is_state_attr('sun.sun', 'rising', true) %}
                                          {% set brightness_value = ((start_slope * elevation) + start_ak) | round(1) %}
                                        {% elif elevation <= dynamic_lighting_sun_elevation_start_falling and elevation >= dynamic_lighting_sun_elevation_end_falling and is_state_attr('sun.sun', 'rising', false) %}
                                          {% set brightness_value = ((end_slope * elevation) + end_ak) | round(1) %}
                                        {% elif elevation >= dynamic_lighting_sun_elevation_end_rising and elevation >= dynamic_lighting_sun_elevation_start_falling  %}
                                          {% set brightness_value = dynamic_lighting_max_brightness %}
                                        {% elif elevation <= dynamic_lighting_sun_elevation_start_rising and is_state_attr('sun.sun', 'rising', true) %}
                                          {% set brightness_value = dynamic_lighting_min_brightness %}
                                        {% elif elevation <= dynamic_lighting_sun_elevation_end_falling and is_state_attr('sun.sun', 'rising', false) %}
                                          {% set brightness_value = dynamic_lighting_min_brightness %}
                                        {% endif %}
                                      {% else %}
                                        {% set brightness_value = dynamic_lighting_min_brightness %}
                                      {% endif %}
                                      {{ brightness_value | round(0) }}
                                    kelvin: "{{temperature_value}}"
                                - alias: "Dynamic lighting heartbeat"
                                  delay:
                                    minutes: !input dynamic_lighting_heartbeat
              - choose:
                - alias: "Set the Sun Elevation Lighting - Colour Temp + Brightness for the normal lights switch"
                  conditions:
                    - condition: template
                      value_template: "{{ include_dynamic_lighting == 'enable_sun_elevation_colour_brightness' }}"
                  sequence:
                    - alias: "Dynamic Lighting Control"
                      repeat:
                        until: "{{ expand(light_switch.entity_id) | selectattr('state', '==', 'off') | list | count > 0 }}"
                        sequence:
                          - choose:
                            - alias: "Set the transition, dynamic sun elevation lighting brightness and dynamic sun elevation colour temperature for the normal lights switch"
                              conditions:
                                - condition: template
                                  value_template: "{{ ('use_transition' in include_light_control) and (include_dynamic_lighting == 'enable_sun_elevation_colour_brightness') }}"
                              sequence:
                                - service: light.turn_on
                                  target:
                                    entity_id: "{{ light_entities }}"
                                  data:
                                    transition: "{{ transition_on_value }}"
                                    brightness_pct: >
                                      {% set elevation = state_attr('sun.sun', 'elevation') | float %}
                                      {% set start_slope = (dynamic_lighting_min_brightness - dynamic_lighting_max_brightness) / (dynamic_lighting_sun_elevation_start_rising - dynamic_lighting_sun_elevation_end_rising) %}
                                      {% set start_ak = (( start_slope * dynamic_lighting_sun_elevation_end_rising) * -1) + dynamic_lighting_max_brightness %}
                                      {% set end_slope = (dynamic_lighting_min_brightness - dynamic_lighting_max_brightness) / (dynamic_lighting_sun_elevation_end_falling - dynamic_lighting_sun_elevation_start_falling) %}
                                      {% set end_ak = (( end_slope * dynamic_lighting_sun_elevation_end_falling) * -1) + dynamic_lighting_min_brightness %}
                                      {% if elevation >= -10 %}
                                        {% if elevation >= dynamic_lighting_sun_elevation_start_rising and elevation <= dynamic_lighting_sun_elevation_end_rising and is_state_attr('sun.sun', 'rising', true) %}
                                          {% set brightness_value = ((start_slope * elevation) + start_ak) | round(1) %}
                                        {% elif elevation <= dynamic_lighting_sun_elevation_start_falling and elevation >= dynamic_lighting_sun_elevation_end_falling and is_state_attr('sun.sun', 'rising', false) %}
                                          {% set brightness_value = ((end_slope * elevation) + end_ak) | round(1) %}
                                        {% elif elevation >= dynamic_lighting_sun_elevation_end_rising and elevation >= dynamic_lighting_sun_elevation_start_falling  %}
                                          {% set brightness_value = dynamic_lighting_max_brightness %}
                                        {% elif elevation <= dynamic_lighting_sun_elevation_start_rising and is_state_attr('sun.sun', 'rising', true) %}
                                          {% set brightness_value = dynamic_lighting_min_brightness %}
                                        {% elif elevation <= dynamic_lighting_sun_elevation_end_falling and is_state_attr('sun.sun', 'rising', false) %}
                                          {% set brightness_value = dynamic_lighting_min_brightness %}
                                        {% endif %}
                                      {% else %}
                                        {% set brightness_value = dynamic_lighting_min_brightness %}
                                      {% endif %}
                                      {{ brightness_value | round(0) }}
                                    kelvin: >
                                      {% set elevation = state_attr('sun.sun', 'elevation') | float %}
                                      {% set start_slope = (dynamic_lighting_min_colour_temp - dynamic_lighting_max_colour_temp) / (dynamic_lighting_sun_elevation_start_rising - dynamic_lighting_sun_elevation_end_rising) %}
                                      {% set start_ak = (( start_slope * dynamic_lighting_sun_elevation_end_rising) * -1) + dynamic_lighting_max_colour_temp %}
                                      {% set end_slope = (dynamic_lighting_min_colour_temp - dynamic_lighting_max_colour_temp) / (dynamic_lighting_sun_elevation_end_falling - dynamic_lighting_sun_elevation_start_falling) %}
                                      {% set end_ak = (( end_slope * dynamic_lighting_sun_elevation_end_falling) * -1) + dynamic_lighting_min_colour_temp %}
                                      {% if elevation >= -10 %}
                                        {% if elevation >= dynamic_lighting_sun_elevation_start_rising and elevation <= dynamic_lighting_sun_elevation_end_rising and is_state_attr('sun.sun', 'rising', true) %}
                                          {% set colour_temp_value = ((start_slope * elevation) + start_ak) | round(1) %}
                                        {% elif elevation <= dynamic_lighting_sun_elevation_start_falling and elevation >= dynamic_lighting_sun_elevation_end_falling and is_state_attr('sun.sun', 'rising', false) %}
                                          {% set colour_temp_value = ((end_slope * elevation) + end_ak) | round(1) %}
                                        {% elif elevation >= dynamic_lighting_sun_elevation_end_rising and elevation >= dynamic_lighting_sun_elevation_start_falling  %}
                                          {% set colour_temp_value = dynamic_lighting_max_colour_temp %}
                                        {% elif elevation <= dynamic_lighting_sun_elevation_start_rising and is_state_attr('sun.sun', 'rising', true) %}
                                          {% set colour_temp_value = dynamic_lighting_min_colour_temp %}
                                        {% elif elevation <= dynamic_lighting_sun_elevation_end_falling and is_state_attr('sun.sun', 'rising', false) %}
                                          {% set colour_temp_value = dynamic_lighting_min_colour_temp %}
                                        {% endif %}
                                      {% else %}
                                        {% set colour_temp_value = dynamic_lighting_min_colour_temp %}
                                      {% endif %}
                                      {{ colour_temp_value | round(0) }}
                                - alias: "Dynamic lighting heartbeat"
                                  delay:
                                    minutes: !input dynamic_lighting_heartbeat
                            - alias: "Set the dynamic sun elevation lighting brightness and dynamic sun elevation colour temperature for the normal lights switch"
                              conditions:
                                - condition: template
                                  value_template: "{{ ('use_transition' not in include_light_control) and (include_dynamic_lighting == 'enable_sun_elevation_colour_brightness') }}"
                              sequence:
                                - service: light.turn_on
                                  target:
                                    entity_id: "{{ light_entities }}"
                                  data:
                                    brightness_pct: >
                                      {% set elevation = state_attr('sun.sun', 'elevation') | float %}
                                      {% set start_slope = (dynamic_lighting_min_brightness - dynamic_lighting_max_brightness) / (dynamic_lighting_sun_elevation_start_rising - dynamic_lighting_sun_elevation_end_rising) %}
                                      {% set start_ak = (( start_slope * dynamic_lighting_sun_elevation_end_rising) * -1) + dynamic_lighting_max_brightness %}
                                      {% set end_slope = (dynamic_lighting_min_brightness - dynamic_lighting_max_brightness) / (dynamic_lighting_sun_elevation_end_falling - dynamic_lighting_sun_elevation_start_falling) %}
                                      {% set end_ak = (( end_slope * dynamic_lighting_sun_elevation_end_falling) * -1) + dynamic_lighting_min_brightness %}
                                      {% if elevation >= -10 %}
                                        {% if elevation >= dynamic_lighting_sun_elevation_start_rising and elevation <= dynamic_lighting_sun_elevation_end_rising and is_state_attr('sun.sun', 'rising', true) %}
                                          {% set brightness_value = ((start_slope * elevation) + start_ak) | round(1) %}
                                        {% elif elevation <= dynamic_lighting_sun_elevation_start_falling and elevation >= dynamic_lighting_sun_elevation_end_falling and is_state_attr('sun.sun', 'rising', false) %}
                                          {% set brightness_value = ((end_slope * elevation) + end_ak) | round(1) %}
                                        {% elif elevation >= dynamic_lighting_sun_elevation_end_rising and elevation >= dynamic_lighting_sun_elevation_start_falling  %}
                                          {% set brightness_value = dynamic_lighting_max_brightness %}
                                        {% elif elevation <= dynamic_lighting_sun_elevation_start_rising and is_state_attr('sun.sun', 'rising', true) %}
                                          {% set brightness_value = dynamic_lighting_min_brightness %}
                                        {% elif elevation <= dynamic_lighting_sun_elevation_end_falling and is_state_attr('sun.sun', 'rising', false) %}
                                          {% set brightness_value = dynamic_lighting_min_brightness %}
                                        {% endif %}
                                      {% else %}
                                        {% set brightness_value = dynamic_lighting_min_brightness %}
                                      {% endif %}
                                      {{ brightness_value | round(0) }}
                                    kelvin: >
                                      {% set elevation = state_attr('sun.sun', 'elevation') | float %}
                                      {% set start_slope = (dynamic_lighting_min_colour_temp - dynamic_lighting_max_colour_temp) / (dynamic_lighting_sun_elevation_start_rising - dynamic_lighting_sun_elevation_end_rising) %}
                                      {% set start_ak = (( start_slope * dynamic_lighting_sun_elevation_end_rising) * -1) + dynamic_lighting_max_colour_temp %}
                                      {% set end_slope = (dynamic_lighting_min_colour_temp - dynamic_lighting_max_colour_temp) / (dynamic_lighting_sun_elevation_end_falling - dynamic_lighting_sun_elevation_start_falling) %}
                                      {% set end_ak = (( end_slope * dynamic_lighting_sun_elevation_end_falling) * -1) + dynamic_lighting_min_colour_temp %}
                                      {% if elevation >= -10 %}
                                        {% if elevation >= dynamic_lighting_sun_elevation_start_rising and elevation <= dynamic_lighting_sun_elevation_end_rising and is_state_attr('sun.sun', 'rising', true) %}
                                          {% set colour_temp_value = ((start_slope * elevation) + start_ak) | round(1) %}
                                        {% elif elevation <= dynamic_lighting_sun_elevation_start_falling and elevation >= dynamic_lighting_sun_elevation_end_falling and is_state_attr('sun.sun', 'rising', false) %}
                                          {% set colour_temp_value = ((end_slope * elevation) + end_ak) | round(1) %}
                                        {% elif elevation >= dynamic_lighting_sun_elevation_end_rising and elevation >= dynamic_lighting_sun_elevation_start_falling  %}
                                          {% set colour_temp_value = dynamic_lighting_max_colour_temp %}
                                        {% elif elevation <= dynamic_lighting_sun_elevation_start_rising and is_state_attr('sun.sun', 'rising', true) %}
                                          {% set colour_temp_value = dynamic_lighting_min_colour_temp %}
                                        {% elif elevation <= dynamic_lighting_sun_elevation_end_falling and is_state_attr('sun.sun', 'rising', false) %}
                                          {% set colour_temp_value = dynamic_lighting_min_colour_temp %}
                                        {% endif %}
                                      {% else %}
                                        {% set colour_temp_value = dynamic_lighting_min_colour_temp %}
                                      {% endif %}
                                      {{ colour_temp_value | round(0) }}
                                - alias: "Dynamic lighting heartbeat"
                                  delay:
                                    minutes: !input dynamic_lighting_heartbeat
              - choose:
                - alias: "Set the Sun Elevation Lighting - Colour Temp + LUX Controled Brightness for the normal lights switch"
                  conditions:
                    - condition: template
                      value_template: "{{ include_dynamic_lighting == 'enable_sun_elevation_colour_lux_brightness' }}"
                  sequence:
                    - alias: "Dynamic Lighting Control"
                      repeat:
                        until: "{{ expand(light_switch.entity_id) | selectattr('state', '==', 'off') | list | count > 0 }}"
                        sequence:
                          - choose:
                            - alias: "Set the transition, dynamic lighting lux brightness and dynamic sun elevation colour temperature for the normal lights switch"
                              conditions:
                                - condition: template
                                  value_template: "{{ ('use_transition' in include_light_control) and (include_dynamic_lighting == 'enable_sun_elevation_colour_lux_brightness') }}"
                              sequence:
                                - service: light.turn_on
                                  target:
                                    entity_id: "{{ light_entities }}"
                                  data:
                                    transition: "{{ transition_on_value }}"
                                    brightness_pct: >
                                      {% set lux = states(dynamic_lighting_lux_sensor) | float %}
                                      {% set slope = (dynamic_lighting_min_brightness - dynamic_lighting_max_brightness) / (dynamic_lighting_max_lux - dynamic_lighting_min_lux) %}
                                      {% set ak = (( slope * dynamic_lighting_min_lux) * -1) + dynamic_lighting_max_brightness %}
                                      {% set le = light_entities %}
                                      {% set lec = expand(le) | map(attribute='entity_id') | list | length %}
                                      {% set lp = expand(le) | map(attribute='attributes.brightness') | reject('equalto', None) | sum | float(default=255) / 255 * 100 / lec %}
                                      {% if lux <= dynamic_lighting_min_lux %}
                                        {% set bv = dynamic_lighting_max_brightness %}
                                      {% elif lux >= dynamic_lighting_max_lux %}
                                        {% set bv = dynamic_lighting_min_brightness %}
                                      {% else %}
                                        {% set bv = ((slope * lux) + ak) | round(1) %}
                                      {% endif %}
                                      {% if lp <= 0 %}
                                        {% set bv = bv %}
                                      {% elif (bv > lp) and (bv - lp) <= dynamic_lighting_dead_zone %}
                                        {% set bv = lp %}
                                      {% elif (lp > bv) and  (lp - bv) <= dynamic_lighting_dead_zone %}
                                        {% set bv = lp %}
                                      {% elif bv > (lp + dynamic_lighting_step_value) %}
                                        {% set bv = lp + dynamic_lighting_step_value %}
                                      {% elif bv < (lp - dynamic_lighting_step_value) %}
                                        {% set bv = lp - dynamic_lighting_step_value %}
                                      {% endif %}
                                      {{ bv | round(0) }}
                                    kelvin: >
                                      {% set elevation = state_attr('sun.sun', 'elevation') | float %}
                                      {% set start_slope = (dynamic_lighting_min_colour_temp - dynamic_lighting_max_colour_temp) / (dynamic_lighting_sun_elevation_start_rising - dynamic_lighting_sun_elevation_end_rising) %}
                                      {% set start_ak = (( start_slope * dynamic_lighting_sun_elevation_end_rising) * -1) + dynamic_lighting_max_colour_temp %}
                                      {% set end_slope = (dynamic_lighting_min_colour_temp - dynamic_lighting_max_colour_temp) / (dynamic_lighting_sun_elevation_end_falling - dynamic_lighting_sun_elevation_start_falling) %}
                                      {% set end_ak = (( end_slope * dynamic_lighting_sun_elevation_end_falling) * -1) + dynamic_lighting_min_colour_temp %}
                                      {% if elevation >= -10 %}
                                        {% if elevation >= dynamic_lighting_sun_elevation_start_rising and elevation <= dynamic_lighting_sun_elevation_end_rising and is_state_attr('sun.sun', 'rising', true) %}
                                          {% set colour_temp_value = ((start_slope * elevation) + start_ak) | round(1) %}
                                        {% elif elevation <= dynamic_lighting_sun_elevation_start_falling and elevation >= dynamic_lighting_sun_elevation_end_falling and is_state_attr('sun.sun', 'rising', false) %}
                                          {% set colour_temp_value = ((end_slope * elevation) + end_ak) | round(1) %}
                                        {% elif elevation >= dynamic_lighting_sun_elevation_end_rising and elevation >= dynamic_lighting_sun_elevation_start_falling  %}
                                          {% set colour_temp_value = dynamic_lighting_max_colour_temp %}
                                        {% elif elevation <= dynamic_lighting_sun_elevation_start_rising and is_state_attr('sun.sun', 'rising', true) %}
                                          {% set colour_temp_value = dynamic_lighting_min_colour_temp %}
                                        {% elif elevation <= dynamic_lighting_sun_elevation_end_falling and is_state_attr('sun.sun', 'rising', false) %}
                                          {% set colour_temp_value = dynamic_lighting_min_colour_temp %}
                                        {% endif %}
                                      {% else %}
                                        {% set colour_temp_value = dynamic_lighting_min_colour_temp %}
                                      {% endif %}
                                      {{ colour_temp_value | round(0) }}
                                - alias: "Dynamic lighting heartbeat"
                                  delay:
                                    minutes: !input dynamic_lighting_heartbeat
                            - alias: "Set the dynamic lighting lux brightness and dynamic sun elevation colour temperature for the normal lights switch"
                              conditions:
                                - condition: template
                                  value_template: "{{ ('use_transition' not in include_light_control) and (include_dynamic_lighting == 'enable_sun_elevation_colour_lux_brightness') }}"
                              sequence:
                                - service: light.turn_on
                                  target:
                                    entity_id: "{{ light_entities }}"
                                  data:
                                    brightness_pct: >
                                      {% set lux = states(dynamic_lighting_lux_sensor) | float %}
                                      {% set slope = (dynamic_lighting_min_brightness - dynamic_lighting_max_brightness) / (dynamic_lighting_max_lux - dynamic_lighting_min_lux) %}
                                      {% set ak = (( slope * dynamic_lighting_min_lux) * -1) + dynamic_lighting_max_brightness %}
                                      {% set le = light_entities %}
                                      {% set lec = expand(le) | map(attribute='entity_id') | list | length %}
                                      {% set lp = expand(le) | map(attribute='attributes.brightness') | reject('equalto', None) | sum | float(default=255) / 255 * 100 / lec %}
                                      {% if lux <= dynamic_lighting_min_lux %}
                                        {% set bv = dynamic_lighting_max_brightness %}
                                      {% elif lux >= dynamic_lighting_max_lux %}
                                        {% set bv = dynamic_lighting_min_brightness %}
                                      {% else %}
                                        {% set bv = ((slope * lux) + ak) | round(1) %}
                                      {% endif %}
                                      {% if lp <= 0 %}
                                        {% set bv = bv %}
                                      {% elif (bv > lp) and (bv - lp) <= dynamic_lighting_dead_zone %}
                                        {% set bv = lp %}
                                      {% elif (lp > bv) and  (lp - bv) <= dynamic_lighting_dead_zone %}
                                        {% set bv = lp %}
                                      {% elif bv > (lp + dynamic_lighting_step_value) %}
                                        {% set bv = lp + dynamic_lighting_step_value %}
                                      {% elif bv < (lp - dynamic_lighting_step_value) %}
                                        {% set bv = lp - dynamic_lighting_step_value %}
                                      {% endif %}
                                      {{ bv | round(0) }}
                                    kelvin: >
                                      {% set elevation = state_attr('sun.sun', 'elevation') | float %}
                                      {% set start_slope = (dynamic_lighting_min_colour_temp - dynamic_lighting_max_colour_temp) / (dynamic_lighting_sun_elevation_start_rising - dynamic_lighting_sun_elevation_end_rising) %}
                                      {% set start_ak = (( start_slope * dynamic_lighting_sun_elevation_end_rising) * -1) + dynamic_lighting_max_colour_temp %}
                                      {% set end_slope = (dynamic_lighting_min_colour_temp - dynamic_lighting_max_colour_temp) / (dynamic_lighting_sun_elevation_end_falling - dynamic_lighting_sun_elevation_start_falling) %}
                                      {% set end_ak = (( end_slope * dynamic_lighting_sun_elevation_end_falling) * -1) + dynamic_lighting_min_colour_temp %}
                                      {% if elevation >= -10 %}
                                        {% if elevation >= dynamic_lighting_sun_elevation_start_rising and elevation <= dynamic_lighting_sun_elevation_end_rising and is_state_attr('sun.sun', 'rising', true) %}
                                          {% set colour_temp_value = ((start_slope * elevation) + start_ak) | round(1) %}
                                        {% elif elevation <= dynamic_lighting_sun_elevation_start_falling and elevation >= dynamic_lighting_sun_elevation_end_falling and is_state_attr('sun.sun', 'rising', false) %}
                                          {% set colour_temp_value = ((end_slope * elevation) + end_ak) | round(1) %}
                                        {% elif elevation >= dynamic_lighting_sun_elevation_end_rising and elevation >= dynamic_lighting_sun_elevation_start_falling  %}
                                          {% set colour_temp_value = dynamic_lighting_max_colour_temp %}
                                        {% elif elevation <= dynamic_lighting_sun_elevation_start_rising and is_state_attr('sun.sun', 'rising', true) %}
                                          {% set colour_temp_value = dynamic_lighting_min_colour_temp %}
                                        {% elif elevation <= dynamic_lighting_sun_elevation_end_falling and is_state_attr('sun.sun', 'rising', false) %}
                                          {% set colour_temp_value = dynamic_lighting_min_colour_temp %}
                                        {% endif %}
                                      {% else %}
                                        {% set colour_temp_value = dynamic_lighting_min_colour_temp %}
                                      {% endif %}
                                      {{ colour_temp_value | round(0) }}
                                - alias: "Dynamic lighting heartbeat"
                                  delay:
                                    minutes: !input dynamic_lighting_heartbeat
              - stop: "Stop the automation"
          - sequence:
              - choose:
                - alias: "Set the transition for the normal lights switch"
                  conditions:
                    - condition: template
                      value_template: "{{ ('use_transition' in include_light_control) and ('use_brightness' not in include_light_control) and (include_dynamic_lighting == 'disable_dynamic_lighting') and ('use_colour_temperature' not in include_light_control) }}"
                  sequence:
                    - service: light.turn_on
                      target:
                        entity_id: "{{ light_entities_off }}"
                      data:
                        transition: "{{ transition_on_value }}"
                - alias: "Set the transition and brightness for the normal lights switch"
                  conditions:
                    - condition: template
                      value_template: "{{ ('use_transition' in include_light_control) and ('use_brightness' in include_light_control) and (include_dynamic_lighting == 'disable_dynamic_lighting') and ('use_colour_temperature' not in include_light_control) }}"
                  sequence:
                    - service: light.turn_on
                      target:
                        entity_id: "{{ light_entities_off }}"
                      data:
                        transition: "{{ transition_on_value }}"
                        brightness_pct: "{{ brightness_value }}"
                - alias: "Set the transition and colour temperature for the normal lights switch"
                  conditions:
                    - condition: template
                      value_template: "{{ ('use_transition' in include_light_control) and ('use_brightness' not in include_light_control) and (include_dynamic_lighting == 'disable_dynamic_lighting') and ('use_colour_temperature' in include_light_control) }}"
                  sequence:
                    - service: light.turn_on
                      target:
                        entity_id: "{{ light_entities_off }}"
                      data:
                        transition: "{{ transition_on_value }}"
                        kelvin: "{{temperature_value}}"
                - alias: "Set the transition, brightness and colour temperature for the normal lights switch"
                  conditions:
                    - condition: template
                      value_template: "{{ ('use_transition' in include_light_control) and ('use_brightness' in include_light_control) and (include_dynamic_lighting == 'disable_dynamic_lighting') and ('use_colour_temperature' in include_light_control) }}"
                  sequence:
                    - service: light.turn_on
                      target:
                        entity_id: "{{ light_entities_off }}"
                      data:
                        transition: "{{ transition_on_value }}"
                        brightness_pct: "{{ brightness_value }}"
                        kelvin: "{{temperature_value}}"
                - alias: "Set the brightness for the normal lights switch"
                  conditions:
                    - condition: template
                      value_template: "{{ ('use_transition' not in include_light_control) and ('use_brightness' in include_light_control) and (include_dynamic_lighting == 'disable_dynamic_lighting') and ('use_colour_temperature' not in include_light_control) }}"
                  sequence:
                    - service: light.turn_on
                      target:
                        entity_id: "{{ light_entities_off }}"
                      data:
                        brightness_pct: "{{ brightness_value }}"
                - alias: "Set the colour temperature for the normal lights switch"
                  conditions:
                    - condition: template
                      value_template: "{{ ('use_transition' not in include_light_control) and ('use_brightness' not in include_light_control) and (include_dynamic_lighting == 'disable_dynamic_lighting') and ('use_colour_temperature' in include_light_control) }}"
                  sequence:
                    - service: light.turn_on
                      target:
                        entity_id: "{{ light_entities_off }}"
                      data:
                        kelvin: "{{temperature_value}}"
                - alias: "Set the brightness and colour temperature for the normal lights switch"
                  conditions:
                    - condition: template
                      value_template: "{{ ('use_transition' not in include_light_control) and ('use_brightness' in include_light_control) and (include_dynamic_lighting == 'disable_dynamic_lighting') and ('use_colour_temperature' in include_light_control) }}"
                  sequence:
                    - service: light.turn_on
                      target:
                        entity_id: "{{ light_entities_off }}"
                      data:
                        brightness_pct: "{{ brightness_value }}"
                        kelvin: "{{temperature_value}}"
                - alias: "Set the default for the normal lights switch"
                  conditions:
                    - condition: template
                      value_template: "{{ ('use_transition' not in include_light_control) and ('use_brightness' not in include_light_control) and (include_dynamic_lighting == 'disable_dynamic_lighting') and ('use_colour_temperature' not in include_light_control) }}"
                  sequence:
                    - service: light.turn_on
                      target:
                        entity_id: "{{ light_entities_off }}"
              - choose:
                - alias: "If transition is selected"
                  conditions:
                    - condition: template
                      value_template: "{{ 'use_transition' in include_light_control }}"
                  sequence:
                    - alias: "Turn on the scenes"
                      service: scene.turn_on
                      target:
                        entity_id: "{{ scene_entities }}"
                      data:
                        transition: "{{ transition_on_value }}"
                - alias: "If transition is not selected"
                  conditions:
                    - condition: template
                      value_template: "{{ 'use_transition' not in include_light_control }}"
                  sequence:
                    - alias: "Turn on the scenes"
                      service: scene.turn_on
                      target:
                        entity_id: "{{ scene_entities }}"
              - alias: "Turn on the switches"
                service: switch.turn_on
                target:
                  entity_id: "{{ switch_entities_off }}"
              - alias: "Turn on the scripts"
                service: script.turn_on
                target:
                  entity_id: "{{ script_entities }}"
              - alias: "Turn on the boolean for scenes and scripts"
                service: input_boolean.turn_on
                data:
                  entity_id: "{{ boolean_scenes_scripts_helper }}"
              - choose:
                - alias: "By-pass is enabled & check by-pass option - turn lights on"
                  conditions:
                    - condition: trigger
                      id: 't7_on'
                  sequence:
                    - alias: "Check by-pass settings and preform the correct action"
                      if:
                        - alias: "Check if the by-pass auto off is enabled"
                          condition: template
                          value_template: "{{ ('bypass_auto_off_enabled_on' in include_bypass_auto_off) or ('bypass_auto_off_enabled_off' in include_bypass_auto_off) or ('bypass_auto_off_enabled_stop' in include_bypass_auto_off) }}"
                      then:
                        - alias: "Wait the number of minutes set in the by-pass auto off time delay"
                          delay: 
                            minutes: !input bypass_auto_off_delay
                        - alias: Parallel Actions for the by-pass auto off
                          parallel:
                            - sequence:
                                - choose:
                                    - conditions:
                                        - condition: template
                                          value_template: "{{ ('bypass_enabled_turn_on' in include_bypass) and ('bypass_auto_off_enabled_on' in include_bypass_auto_off) }}"
                                      sequence:
                                        - alias: "Turn off the by-pass"
                                          service: homeassistant.turn_off
                                          entity_id: !input motion_bypass_lights_on
                            - sequence:
                                - choose:
                                    - conditions:
                                        - condition: template
                                          value_template: "{{ ('bypass_enabled_turn_off' in include_bypass) and ('bypass_auto_off_enabled_off' in include_bypass_auto_off) }}"
                                      sequence:
                                        - alias: "Turn off the by-pass"
                                          service: homeassistant.turn_off
                                          entity_id: !input motion_bypass_lights_off
                            - sequence:
                                - choose:
                                    - conditions:
                                        - condition: template
                                          value_template: "{{ ('bypass_enabled_stop' in include_bypass) and ('bypass_auto_off_enabled_stop' in include_bypass_auto_off) }}"
                                      sequence:
                                        - alias: "Turn off the by-pass"
                                          service: homeassistant.turn_off
                                          entity_id: !input motion_bypass_lights_stop
                        - stop: "Stop the automation"
                      else:
                        - stop: "Stop the automation"
              - choose:
                - alias: "Check if the trigger is on and wait for it to go off"
                  conditions:
                    - condition: state
                      entity_id: !input motion_trigger
                      state: 'on'
                      match: any
                  sequence:
                    - alias: "Wait until motion sensor is off"
                      wait_for_trigger:
                        platform: state
                        entity_id: !input motion_trigger
                        from: "on"
                        to: "off"
              - alias: "Wait the number of minutes set in the normal lights time delay"
                delay:
                  minutes: !input time_delay
              - choose:
                - alias: "If transition is selected"
                  conditions:
                    - condition: template
                      value_template: "{{ 'use_transition' in include_light_control }}"
                  sequence:
                    - alias: "Turn off the lights"
                      service: light.turn_off
                      target:
                        entity_id: "{{ light_entities }}"
                      data:
                        transition: "{{ transition_off_value }}"
                    - alias: "Turn off the scenes"
                      service: scene.turn_on
                      data:
                        entity_id: "{{ end_scene_entities }}"
                        transition: "{{ transition_off_value }}"
                - alias: "If transition is not selected"
                  conditions:
                    - condition: template
                      value_template: "{{ 'use_transition' not in include_light_control }}"
                  sequence:
                    - alias: "Turn off the lights"
                      service: light.turn_off
                      target:
                        entity_id: "{{ light_entities }}"
                    - alias: "Turn off the scenes"
                      service: scene.turn_on
                      data:
                        entity_id: "{{ end_scene_entities }}"
              - alias: "Turn off the switches"
                service: switch.turn_off
                target:
                  entity_id: "{{ switch_entities }}"
              - alias: "Turn off the script"
                service: script.turn_on
                data:
                  entity_id: "{{ end_script_entities }}"
              - alias: "Turn off the boolean for scenes and scripts"
                service: input_boolean.turn_off
                data:
                  entity_id: !input boolean_scenes_scripts